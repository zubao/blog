<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/blog/atom.xml" title="闲敲棋子落灯花" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="闲敲棋子落灯花">
<meta property="og:url" content="https://zubao.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="闲敲棋子落灯花">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="闲敲棋子落灯花">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zubao.github.io/blog/page/2/">





  <title>闲敲棋子落灯花</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">闲敲棋子落灯花</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/15/Android 性能监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/15/Android 性能监控/" itemprop="url">android 性能监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-15T17:53:43+08:00">
                2020-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>rabbit </p>
<blockquote>
<p><a href="https://juejin.im/post/5e189537f265da3e413f4da2" target="_blank" rel="noopener">https://juejin.im/post/5e189537f265da3e413f4da2</a></p>
<p>源码：</p>
<p><a href="https://github.com/zubao/rabbit-client" target="_blank" rel="noopener">https://github.com/zubao/rabbit-client</a></p>
</blockquote>
</li>
<li><p>Firebase Performance Monitoring SDK 谷歌</p>
<blockquote>
<p><a href="https://firebase.google.com/docs/perf-mon/get-started-android?hl=zh-cn" target="_blank" rel="noopener">https://firebase.google.com/docs/perf-mon/get-started-android?hl=zh-cn</a></p>
</blockquote>
</li>
<li><p>matrix  腾讯-微信</p>
<blockquote>
<p><a href="https://github.com/zubao/matrix" target="_blank" rel="noopener">https://github.com/zubao/matrix</a></p>
<p><a href="https://dahei.me/2018/12/27/腾讯性能监控框架Matrix源码分析之第一篇/" target="_blank" rel="noopener">https://dahei.me/2018/12/27/%E8%85%BE%E8%AE%AF%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6Matrix%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E7%AC%AC%E4%B8%80%E7%AF%87/</a></p>
</blockquote>
</li>
<li><p>ArgusAPM  360</p>
<blockquote>
<p><a href="https://github.com/Qihoo360/ArgusAPM" target="_blank" rel="noopener">https://github.com/Qihoo360/ArgusAPM</a></p>
</blockquote>
</li>
<li><p>Emmagee 网易</p>
<blockquote>
<p><a href="https://github.com/Qihoo360/ArgusAPM" target="_blank" rel="noopener">https://github.com/Qihoo360/ArgusAPM</a></p>
</blockquote>
</li>
<li><p>fpsviewer </p>
<blockquote>
<p><a href="https://github.com/SilenceDut/fpsviewer" target="_blank" rel="noopener">https://github.com/SilenceDut/fpsviewer</a></p>
</blockquote>
</li>
<li><p>Android Performance Monitor</p>
<blockquote>
<p><a href="https://github.com/markzhai/AndroidPerformanceMonitor" target="_blank" rel="noopener">https://github.com/markzhai/AndroidPerformanceMonitor</a> </p>
</blockquote>
</li>
</ul>
<p>参考文章：</p>
<p><a href="https://github.com/D-clock/Doc/blob/master/Android/辅助工具/Android性能分析工具整理汇总.md" target="_blank" rel="noopener">https://github.com/D-clock/Doc/blob/master/Android/%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7/Android%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E6%B1%87%E6%80%BB.md</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/09/Java 虚拟机 JVMTI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/09/Java 虚拟机 JVMTI/" itemprop="url">Java 虚拟机 JVMTI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-09T14:50:51+08:00">
                2020-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="JVMTI-JVM-tools-interface"><a href="#JVMTI-JVM-tools-interface" class="headerlink" title="JVMTI(JVM tools interface)"></a>JVMTI(JVM tools interface)</h5><ul>
<li><a href="https://cloud.tencent.com/developer/article/1478720" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1478720</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/08/Mac GDB调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/08/Mac GDB调试/" itemprop="url">Mac gdb调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-08T15:54:23+08:00">
                2020-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/mac/" itemprop="url" rel="index">
                    <span itemprop="name">mac</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="安装gdb"><a href="#安装gdb" class="headerlink" title="安装gdb"></a>安装gdb</h5><ul>
<li><p>命令行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install gdb</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"> #</span> 下载源码</span><br><span class="line"> http://ftp.gnu.org/gnu/gdb/gdb-8.0.tar.gz </span><br><span class="line"><span class="meta"> #</span> 编译安装</span><br><span class="line"> ./configure</span><br><span class="line">make j4</span><br><span class="line">make install</span><br><span class="line">gdb -v</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h5><ul>
<li>使用钥匙串创建证书</li>
<li>打开 应用程序&gt;实用工具&gt;钥匙串</li>
<li>左上角菜单&gt;钥匙串访问-&gt;证书助理-&gt;创建证书</li>
<li>名称 gdb_codesign；身份类型：自签名根证书；证书类型：代码签名；勾选：让我覆盖这些默认设置</li>
<li>一直next，直到出现“指定证书位置”，选择登录，然后完成。</li>
<li>将创建的证书拖到桌面；</li>
<li>打开钥匙串，两指单击系统&gt;解锁钥匙串系统&gt;添加证书&gt;将上步拖到桌面的证书添加到系统。</li>
<li>删除登录中的gdb_codesign证书</li>
<li>点击系统-gdb_codesign，展开信任，选择始终信任；</li>
</ul>
<h5 id="签名gdb"><a href="#签名gdb" class="headerlink" title="签名gdb"></a>签名gdb</h5><ul>
<li><p>sudo codesign -s gdb_codesign /usr/local/bin/gdb</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">10.14及以后</span><br><span class="line">先创建一个文件 gdb-entitlement.xml，内容为:</span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>com.apple.security.cs.debugger<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line">codesign --entitlements gdb-entitlement.xml -fs gdb-cert $(which gdb)</span><br></pre></td></tr></table></figure>
</li>
<li><p>echo “set startup-with-shell off” &gt;&gt; ~/.gdbinit</p>
</li>
</ul>
<h5 id="gdb-调试"><a href="#gdb-调试" class="headerlink" title="gdb 调试"></a>gdb 调试</h5><ul>
<li><a href="https://blog.csdn.net/feixiaoxing/article/details/7199643" target="_blank" rel="noopener">https://blog.csdn.net/feixiaoxing/article/details/7199643</a></li>
</ul>
<h5 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h5><ul>
<li><a href="https://blog.csdn.net/wj1066/article/details/83653153" target="_blank" rel="noopener">https://blog.csdn.net/wj1066/article/details/83653153</a></li>
<li><a href="https://segmentfault.com/q/1010000004136334" target="_blank" rel="noopener">https://segmentfault.com/q/1010000004136334</a></li>
<li><a href="https://sourceware.org/gdb/wiki/PermissionsDarwin" target="_blank" rel="noopener">https://sourceware.org/gdb/wiki/PermissionsDarwin</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/06/Java 虚拟机启动跟踪/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/06/Java 虚拟机启动跟踪/" itemprop="url">Java 虚拟机 启动跟踪</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-06T21:38:44+08:00">
                2020-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h5><ul>
<li>macosx 10.14</li>
<li>虚拟机源码版本 OpenJDK11U</li>
</ul>
<h5 id="编译命令"><a href="#编译命令" class="headerlink" title="编译命令"></a>编译命令</h5><ul>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh configure --with-jvm-variants=client --disable-warnings-as-errors --with-debug-level=slowdebug </span><br><span class="line">make images</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="源码跟踪"><a href="#源码跟踪" class="headerlink" title="源码跟踪"></a>源码跟踪</h5><ul>
<li><p>虚拟机入口方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 虚拟机入口文件 src/java.base/share/native/launcher/main.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Entry point.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JAVAW</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> **__initenv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> WINAPI</span><br><span class="line">WinMain(HINSTANCE inst, HINSTANCE previnst, LPSTR cmdline, <span class="keyword">int</span> cmdshow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> margc;</span><br><span class="line">    <span class="keyword">char</span>** margv;</span><br><span class="line">    <span class="keyword">int</span> jargc;</span><br><span class="line">    <span class="keyword">char</span>** jargv;</span><br><span class="line">    <span class="keyword">const</span> jboolean const_javaw = JNI_TRUE;</span><br><span class="line"></span><br><span class="line">    __initenv = _environ;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* JAVAW */</span></span></span><br><span class="line">JNIEXPORT <span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> margc;</span><br><span class="line">    <span class="keyword">char</span>** margv;</span><br><span class="line">    <span class="keyword">int</span> jargc;</span><br><span class="line">    <span class="keyword">char</span>** jargv;</span><br><span class="line">    <span class="keyword">const</span> jboolean const_javaw = JNI_FALSE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* JAVAW */</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i, main_jargc, extra_jargc;</span><br><span class="line">        JLI_List <span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line">        main_jargc = (<span class="keyword">sizeof</span>(const_jargs) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)) &gt; <span class="number">1</span></span><br><span class="line">            ? <span class="keyword">sizeof</span>(const_jargs) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)</span><br><span class="line">            : <span class="number">0</span>; <span class="comment">// ignore the null terminator index</span></span><br><span class="line"></span><br><span class="line">        extra_jargc = (<span class="keyword">sizeof</span>(const_extra_jargs) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)) &gt; <span class="number">1</span></span><br><span class="line">            ? <span class="keyword">sizeof</span>(const_extra_jargs) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)</span><br><span class="line">            : <span class="number">0</span>; <span class="comment">// ignore the null terminator index</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (main_jargc &gt; <span class="number">0</span> &amp;&amp; extra_jargc &gt; <span class="number">0</span>) &#123; <span class="comment">// combine extra java args</span></span><br><span class="line">            jargc = main_jargc + extra_jargc;</span><br><span class="line">            <span class="built_in">list</span> = JLI_List_new(jargc + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; extra_jargc; i++) &#123;</span><br><span class="line">                JLI_List_add(<span class="built_in">list</span>, JLI_StringDup(const_extra_jargs[i]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; main_jargc ; i++) &#123;</span><br><span class="line">                JLI_List_add(<span class="built_in">list</span>, JLI_StringDup(const_jargs[i]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// terminate the list</span></span><br><span class="line">            JLI_List_add(<span class="built_in">list</span>, <span class="literal">NULL</span>);</span><br><span class="line">            jargv = <span class="built_in">list</span>-&gt;elements;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (extra_jargc &gt; <span class="number">0</span>) &#123; <span class="comment">// should never happen</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"EXTRA_JAVA_ARGS defined without JAVA_ARGS"</span>);</span><br><span class="line">            <span class="built_in">abort</span>();</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123; <span class="comment">// no extra args, business as usual</span></span><br><span class="line">            jargc = main_jargc;</span><br><span class="line">            jargv = (<span class="keyword">char</span> **) const_jargs;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JLI_InitArgProcessing(jargc &gt; <span class="number">0</span>, const_disable_argfile);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (getenv(JLDEBUG_ENV_ENTRY) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Windows original main args:\n"</span>);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; __argc ; i++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"wwwd_args[%d] = %s\n"</span>, i, __argv[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    JLI_CmdToArgs(GetCommandLine());</span><br><span class="line">    margc = JLI_GetStdArgc();</span><br><span class="line">    <span class="comment">// add one more to mark the end</span></span><br><span class="line">    margv = (<span class="keyword">char</span> **)JLI_MemAlloc((margc + <span class="number">1</span>) * (<span class="keyword">sizeof</span>(<span class="keyword">char</span> *)));</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        StdArg *stdargs = JLI_GetStdArgs();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; margc ; i++) &#123;</span><br><span class="line">            margv[i] = stdargs[i].arg;</span><br><span class="line">        &#125;</span><br><span class="line">        margv[i] = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* *NIXES */</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// accommodate the NULL at the end</span></span><br><span class="line">        JLI_List args = JLI_List_new(argc + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add first arg, which is the app name</span></span><br><span class="line">        JLI_List_add(args, JLI_StringDup(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="comment">// Append JDK_JAVA_OPTIONS</span></span><br><span class="line">        <span class="keyword">if</span> (JLI_AddArgsFromEnvVar(args, JDK_JAVA_OPTIONS)) &#123;</span><br><span class="line">            <span class="comment">// JLI_SetTraceLauncher is not called yet</span></span><br><span class="line">            <span class="comment">// Show _JAVA_OPTIONS content along with JDK_JAVA_OPTIONS to aid diagnosis</span></span><br><span class="line">            <span class="keyword">if</span> (getenv(JLDEBUG_ENV_ENTRY)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *tmp = getenv(<span class="string">"_JAVA_OPTIONS"</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">NULL</span> != tmp) &#123;</span><br><span class="line">                    JLI_ReportMessage(ARG_INFO_ENVVAR, <span class="string">"_JAVA_OPTIONS"</span>, tmp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Iterate the rest of command line</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">            JLI_List argsInFile = JLI_PreprocessArg(argv[i], JNI_TRUE);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">NULL</span> == argsInFile) &#123;</span><br><span class="line">                JLI_List_add(args, JLI_StringDup(argv[i]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt, idx;</span><br><span class="line">                cnt = argsInFile-&gt;size;</span><br><span class="line">                <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; cnt; idx++) &#123;</span><br><span class="line">                    JLI_List_add(args, argsInFile-&gt;elements[idx]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Shallow free, we reuse the string to avoid copy</span></span><br><span class="line">                JLI_MemFree(argsInFile-&gt;elements);</span><br><span class="line">                JLI_MemFree(argsInFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        margc = args-&gt;size;</span><br><span class="line">        <span class="comment">// add the NULL pointer at argv[argc]</span></span><br><span class="line">        JLI_List_add(args, <span class="literal">NULL</span>);</span><br><span class="line">        margv = args-&gt;elements;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WIN32 */</span></span></span><br><span class="line">    <span class="keyword">return</span> JLI_Launch(margc, margv,</span><br><span class="line">                   jargc, (<span class="keyword">const</span> <span class="keyword">char</span>**) jargv,</span><br><span class="line">                   <span class="number">0</span>, <span class="literal">NULL</span>,</span><br><span class="line">                   VERSION_STRING,</span><br><span class="line">                   DOT_VERSION,</span><br><span class="line">                   (const_progname != <span class="literal">NULL</span>) ? const_progname : *margv,</span><br><span class="line">                   (const_launcher != <span class="literal">NULL</span>) ? const_launcher : *margv,</span><br><span class="line">                   jargc &gt; <span class="number">0</span>,</span><br><span class="line">                   const_cpwildcard, const_javaw, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>JLI_Launch 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/java.base/share/native/libjli/java.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Entry point.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">int</span> JNICALL</span><br><span class="line">JLI_Launch(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv,              <span class="comment">/* main argc, argv */</span></span><br><span class="line">        <span class="keyword">int</span> jargc, <span class="keyword">const</span> <span class="keyword">char</span>** jargv,          <span class="comment">/* java args */</span></span><br><span class="line">        <span class="keyword">int</span> appclassc, <span class="keyword">const</span> <span class="keyword">char</span>** appclassv,  <span class="comment">/* app classpath */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* fullversion,                <span class="comment">/* full version defined */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* dotversion,                 <span class="comment">/* UNUSED dot version defined */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* pname,                      <span class="comment">/* program name */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* lname,                      <span class="comment">/* launcher name */</span></span><br><span class="line">        jboolean javaargs,                      <span class="comment">/* JAVA_ARGS */</span></span><br><span class="line">        jboolean cpwildcard,                    <span class="comment">/* classpath wildcard*/</span></span><br><span class="line">        jboolean javaw,                         <span class="comment">/* windows-only javaw */</span></span><br><span class="line">        jint ergo                               <span class="comment">/* unused */</span></span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> mode = LM_UNKNOWN;</span><br><span class="line">    <span class="keyword">char</span> *what = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *main_class = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    InvocationFunctions ifn;</span><br><span class="line">    jlong start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> jvmpath[MAXPATHLEN];</span><br><span class="line">    <span class="keyword">char</span> jrepath[MAXPATHLEN];</span><br><span class="line">    <span class="keyword">char</span> jvmcfg[MAXPATHLEN];</span><br><span class="line"></span><br><span class="line">    _fVersion = fullversion;</span><br><span class="line">    _launcher_name = lname;</span><br><span class="line">    _program_name = pname;</span><br><span class="line">    _is_java_args = javaargs;</span><br><span class="line">    _wc_enabled = cpwildcard;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"LPL Java Enter Point！\n"</span>);</span><br><span class="line">    InitLauncher(javaw);</span><br><span class="line">    DumpState();</span><br><span class="line">    <span class="keyword">if</span> (JLI_IsTraceLauncher()) &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Java args:\n"</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; jargc ; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"jargv[%d] = %s\n"</span>, i, jargv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Command line args:\n"</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc ; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"argv[%d] = %s\n"</span>, i, argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        AddOption(<span class="string">"-Dsun.java.launcher.diag=true"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * SelectVersion() has several responsibilities:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  1) Disallow specification of another JRE.  With 1.9, another</span></span><br><span class="line"><span class="comment">     *     version of the JRE cannot be invoked.</span></span><br><span class="line"><span class="comment">     *  2) Allow for a JRE version to invoke JDK 1.9 or later.  Since</span></span><br><span class="line"><span class="comment">     *     all mJRE directives have been stripped from the request but</span></span><br><span class="line"><span class="comment">     *     the pre 1.9 JRE [ 1.6 thru 1.8 ], it is as if 1.9+ has been</span></span><br><span class="line"><span class="comment">     *     invoked from the command line.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SelectVersion(argc, argv, &amp;main_class);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 这里进入会新开线程，并重新执行上面的main方法</span></span><br><span class="line">    CreateExecutionEnvironment(&amp;argc, &amp;argv,</span><br><span class="line">                               jrepath, <span class="keyword">sizeof</span>(jrepath),</span><br><span class="line">                               jvmpath, <span class="keyword">sizeof</span>(jvmpath),</span><br><span class="line">                               jvmcfg,  <span class="keyword">sizeof</span>(jvmcfg));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!IsJavaArgs()) &#123;</span><br><span class="line">        SetJvmEnvironment(argc,argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ifn.CreateJavaVM = <span class="number">0</span>;</span><br><span class="line">    ifn.GetDefaultJavaVMInitArgs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JLI_IsTraceLauncher()) &#123;</span><br><span class="line">        start = CounterGet();</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 载入JVM</span></span><br><span class="line">    <span class="keyword">if</span> (!LoadJavaVM(jvmpath, &amp;ifn)) &#123;</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JLI_IsTraceLauncher()) &#123;</span><br><span class="line">        end   = CounterGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JLI_TraceLauncher(<span class="string">"%ld micro seconds to LoadJavaVM\n"</span>,</span><br><span class="line">             (<span class="keyword">long</span>)(jint)Counter2Micros(end-start));</span><br><span class="line"></span><br><span class="line">    ++argv;</span><br><span class="line">    --argc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IsJavaArgs()) &#123;</span><br><span class="line">        <span class="comment">/* Preprocess wrapper arguments */</span></span><br><span class="line">        TranslateApplicationArgs(jargc, jargv, &amp;argc, &amp;argv);</span><br><span class="line">        <span class="keyword">if</span> (!AddApplicationOptions(appclassc, appclassv)) &#123;</span><br><span class="line">            <span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Set default CLASSPATH */</span></span><br><span class="line">        <span class="keyword">char</span>* cpath = getenv(<span class="string">"CLASSPATH"</span>);</span><br><span class="line">        <span class="keyword">if</span> (cpath != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            SetClassPath(cpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse command line options; if the return value of</span></span><br><span class="line"><span class="comment">     * ParseArguments is false, the program should exit.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!ParseArguments(&amp;argc, &amp;argv, &amp;mode, &amp;what, &amp;ret, jrepath)) &#123;</span><br><span class="line">        <span class="keyword">return</span>(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Override class path if -jar flag was specified */</span></span><br><span class="line">    <span class="keyword">if</span> (mode == LM_JAR) &#123;</span><br><span class="line">        SetClassPath(what);     <span class="comment">/* Override class path */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set the -Dsun.java.command pseudo property */</span></span><br><span class="line">    SetJavaCommandLineProp(what, argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the -Dsun.java.launcher pseudo property */</span></span><br><span class="line">    SetJavaLauncherProp();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set the -Dsun.java.launcher.* platform properties */</span></span><br><span class="line">    SetJavaLauncherPlatformProps();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JVMInit(&amp;ifn, threadStackSize, argc, argv, mode, what, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//参考 https://blog.csdn.net/weixin_37477523/article/details/88117056</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>CreateExecutionEnvironment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：/src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">CreateExecutionEnvironment(<span class="keyword">int</span> *pargc, <span class="keyword">char</span> ***pargv,</span><br><span class="line">                           <span class="keyword">char</span> jrepath[], jint so_jrepath,</span><br><span class="line">                           <span class="keyword">char</span> jvmpath[], jint so_jvmpath,</span><br><span class="line">                           <span class="keyword">char</span> jvmcfg[],  jint so_jvmcfg) &#123;</span><br><span class="line">    jboolean jvmpathExists;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Compute/set the name of the executable */</span></span><br><span class="line">    SetExecname(*pargv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> * jvmtype    = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span>  argc         = *pargc;</span><br><span class="line">    <span class="keyword">char</span> **argv       = *pargv;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find out where the JRE is that we will be using. */</span></span><br><span class="line">    <span class="keyword">if</span> (!GetJREPath(jrepath, so_jrepath, JNI_FALSE) ) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(JRE_ERROR1);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    JLI_Snprintf(jvmcfg, so_jvmcfg, <span class="string">"%s%slib%sjvm.cfg"</span>,</span><br><span class="line">                 jrepath, FILESEP, FILESEP);</span><br><span class="line">    <span class="comment">/* Find the specified JVM type */</span></span><br><span class="line">    <span class="keyword">if</span> (ReadKnownVMs(jvmcfg, JNI_FALSE) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(CFG_ERROR7);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jvmpath[<span class="number">0</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    jvmtype = CheckJvmType(pargc, pargv, JNI_FALSE);</span><br><span class="line">    <span class="keyword">if</span> (JLI_StrCmp(jvmtype, <span class="string">"ERROR"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(CFG_ERROR9);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!GetJVMPath(jrepath, jvmtype, jvmpath, so_jvmpath)) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(CFG_ERROR8, jvmtype, jvmpath);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Mac OS X requires the Cocoa event loop to be run on the "main"</span></span><br><span class="line"><span class="comment">     * thread. Spawn off a new thread to run main() and pass</span></span><br><span class="line"><span class="comment">     * this thread off to the Cocoa event loop.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"> <span class="comment">// Mac OS X 上面需要在 Cocoa event loop 上面运行 main线程，这里就将当前线程停止，新建一个线程重新运行main方法。</span></span><br><span class="line">    MacOSXStartup(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we seem to have everything we need</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>MacOSXStartup</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：/src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Mac OS X mandates that the GUI event loop run on very first thread of</span></span><br><span class="line"><span class="comment"> * an application. This requires that we re-call Java's main() on a new</span></span><br><span class="line"><span class="comment"> * thread, reserving the 'main' thread for Cocoa.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MacOSXStartup</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Thread already started?</span></span><br><span class="line">  	<span class="comment">// 只有第一次会另起一个线程去重新执行main方法</span></span><br><span class="line">    <span class="keyword">static</span> jboolean started = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (started) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    started = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hand off arguments</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NSAppArgs</span> <span class="title">args</span>;</span></span><br><span class="line">    args.argc = argc;</span><br><span class="line">    args.argv = argv;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fire up the main thread</span></span><br><span class="line">    <span class="keyword">pthread_t</span> main_thr;</span><br><span class="line">  <span class="comment">// 新建一个线程，通过apple_main方法去重新运行 main方法</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;main_thr, <span class="literal">NULL</span>, &amp;apple_main, &amp;args) != <span class="number">0</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessageSys(<span class="string">"Could not create main thread: %s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pthread_detach(main_thr)) &#123;</span><br><span class="line">        JLI_ReportErrorMessageSys(<span class="string">"pthread_detach() failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ParkEventLoop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>apple_main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：/src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Unwrap the arguments and re-run main()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">apple_main</span> <span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (main_fptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> STATIC_BUILD</span></span><br><span class="line">        <span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>;</span><br><span class="line">        main_fptr = &amp;main;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        main_fptr = (<span class="keyword">int</span> (*)())dlsym(RTLD_DEFAULT, <span class="string">"main"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (main_fptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            JLI_ReportErrorMessageSys(<span class="string">"error locating main entrypoint\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NSAppArgs</span> *<span class="title">args</span> = (<span class="title">struct</span> <span class="title">NSAppArgs</span> *) <span class="title">arg</span>;</span></span><br><span class="line">  	<span class="comment">// 重新运行main方法</span></span><br><span class="line">    <span class="built_in">exit</span>(main_fptr(args-&gt;argc, args-&gt;argv));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LoadJavaVM 载入虚拟机</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line">jboolean</span><br><span class="line">LoadJavaVM(<span class="keyword">const</span> <span class="keyword">char</span> *jvmpath, InvocationFunctions *ifn)</span><br><span class="line">&#123;</span><br><span class="line">    Dl_info dlinfo;</span><br><span class="line">    <span class="keyword">void</span> *libjvm;</span><br><span class="line"></span><br><span class="line">    JLI_TraceLauncher(<span class="string">"macosx JVM path is %s\n"</span>, jvmpath);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取、载入编译好的jvm库文件 jdk/lib/client/libjvm.dylib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> STATIC_BUILD</span></span><br><span class="line">    libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    libjvm = dlopen(<span class="literal">NULL</span>, RTLD_FIRST);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (libjvm == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(DLL_ERROR1, __LINE__);</span><br><span class="line">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 从库文件中获取指定的JNI_CreateJavaVM方法。</span></span><br><span class="line">    ifn-&gt;CreateJavaVM = (CreateJavaVM_t)</span><br><span class="line">        dlsym(libjvm, <span class="string">"JNI_CreateJavaVM"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ifn-&gt;CreateJavaVM == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ifn-&gt;GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)</span><br><span class="line">        dlsym(libjvm, <span class="string">"JNI_GetDefaultJavaVMInitArgs"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ifn-&gt;GetDefaultJavaVMInitArgs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ifn-&gt;GetCreatedJavaVMs = (GetCreatedJavaVMs_t)</span><br><span class="line">    dlsym(libjvm, <span class="string">"JNI_GetCreatedJavaVMs"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ifn-&gt;GetCreatedJavaVMs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JNI_CreateJavaVM 创建jvm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/hotspot/share/prims/jni.cpp</span></span><br><span class="line">_<span class="function">JNI_IMPORT_OR_EXPORT_ jint JNICALL <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM **vm, <span class="keyword">void</span> **penv, <span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">  jint result = JNI_ERR;</span><br><span class="line">  <span class="comment">// On Windows, let CreateJavaVM run with SEH protection</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  __try &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    result = JNI_CreateJavaVM_inner(vm, penv, args);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  &#125; __except(topLevelExceptionFilter((_EXCEPTION_POINTERS*)_exception_info())) &#123;</span><br><span class="line">    <span class="comment">// Nothing to do.</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JNI_CreateJavaVM_inner</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/hotspot/share/prims/jni.cpp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">JNI_CreateJavaVM_inner</span><span class="params">(JavaVM **vm, <span class="keyword">void</span> **penv, <span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">  HOTSPOT_JNI_CREATEJAVAVM_ENTRY((<span class="keyword">void</span> **) vm, penv, args);</span><br><span class="line"></span><br><span class="line">  jint result = JNI_ERR;</span><br><span class="line">  DT_RETURN_MARK(CreateJavaVM, jint, (<span class="keyword">const</span> jint&amp;)result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We're about to use Atomic::xchg for synchronization.  Some Zero</span></span><br><span class="line">  <span class="comment">// platforms use the GCC builtin __sync_lock_test_and_set for this,</span></span><br><span class="line">  <span class="comment">// but __sync_lock_test_and_set is not guaranteed to do what we want</span></span><br><span class="line">  <span class="comment">// on all architectures.  So we check it works before relying on it.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZERO) &amp;&amp; defined(ASSERT)</span></span><br><span class="line">  &#123;</span><br><span class="line">    jint a = <span class="number">0xcafebabe</span>;</span><br><span class="line">    jint b = Atomic::xchg((jint) <span class="number">0xdeadbeef</span>, &amp;a);</span><br><span class="line">    <span class="keyword">void</span> *c = &amp;a;</span><br><span class="line">    <span class="keyword">void</span> *d = Atomic::xchg(&amp;b, &amp;c);</span><br><span class="line">    assert(a == (jint) <span class="number">0xdeadbeef</span> &amp;&amp; b == (jint) <span class="number">0xcafebabe</span>, <span class="string">"Atomic::xchg() works"</span>);</span><br><span class="line">    assert(c == &amp;b &amp;&amp; d == &amp;a, <span class="string">"Atomic::xchg() works"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// ZERO &amp;&amp; ASSERT</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// At the moment it's only possible to have one Java VM,</span></span><br><span class="line">  <span class="comment">// since some of the runtime state is in global variables.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We cannot use our mutex locks here, since they only work on</span></span><br><span class="line">  <span class="comment">// Threads. We do an atomic compare and exchange to ensure only</span></span><br><span class="line">  <span class="comment">// one thread can call this method at a time</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We use Atomic::xchg rather than Atomic::add/dec since on some platforms</span></span><br><span class="line">  <span class="comment">// the add/dec implementations are dependent on whether we are running</span></span><br><span class="line">  <span class="comment">// on a multiprocessor, and at this stage of initialization the os::is_MP</span></span><br><span class="line">  <span class="comment">// function used to determine this will always return false. Atomic::xchg</span></span><br><span class="line">  <span class="comment">// does not have this problem.</span></span><br><span class="line">  <span class="keyword">if</span> (Atomic::xchg(<span class="number">1</span>, &amp;vm_created) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_EEXIST;   <span class="comment">// already created, or create attempt in progress</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If a previous creation attempt failed but can be retried safely,</span></span><br><span class="line">  <span class="comment">// then safe_to_recreate_vm will have been reset to 1 after being</span></span><br><span class="line">  <span class="comment">// cleared here. If a previous creation attempt succeeded and we then</span></span><br><span class="line">  <span class="comment">// destroyed that VM, we will be prevented from trying to recreate</span></span><br><span class="line">  <span class="comment">// the VM in the same process, as the value will still be 0.</span></span><br><span class="line">  <span class="keyword">if</span> (Atomic::xchg(<span class="number">0</span>, &amp;safe_to_recreate_vm) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert(vm_created == <span class="number">1</span>, <span class="string">"vm_created is true during the creation"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Certain errors during initialization are recoverable and do not</span></span><br><span class="line"><span class="comment">   * prevent this method from being called again at a later time</span></span><br><span class="line"><span class="comment">   * (perhaps with different arguments).  However, at a certain</span></span><br><span class="line"><span class="comment">   * point during initialization if an error occurs we cannot allow</span></span><br><span class="line"><span class="comment">   * this function to be called again (or it will crash).  In those</span></span><br><span class="line"><span class="comment">   * situations, the 'canTryAgain' flag is set to false, which atomically</span></span><br><span class="line"><span class="comment">   * sets safe_to_recreate_vm to 1, such that any new call to</span></span><br><span class="line"><span class="comment">   * JNI_CreateJavaVM will immediately fail using the above logic.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">bool</span> can_try_again = <span class="literal">true</span>;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 在Threads 类中创建虚拟机</span></span><br><span class="line">  result = Threads::create_vm((JavaVMInitArgs*) args, &amp;can_try_again);</span><br><span class="line">  <span class="keyword">if</span> (result == JNI_OK) &#123; <span class="comment">// 如果创建成功</span></span><br><span class="line">    JavaThread *thread = JavaThread::current();</span><br><span class="line">    assert(!thread-&gt;has_pending_exception(), <span class="string">"should have returned not OK"</span>);</span><br><span class="line">    <span class="comment">/* thread is thread_in_vm here */</span></span><br><span class="line">    *vm = (JavaVM *)(&amp;main_vm);</span><br><span class="line">    *(JNIEnv**)penv = thread-&gt;jni_environment();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_JVMCI</span></span><br><span class="line">    <span class="keyword">if</span> (EnableJVMCI) &#123;</span><br><span class="line">      <span class="keyword">if</span> (UseJVMCICompiler) &#123;</span><br><span class="line">        <span class="comment">// JVMCI is initialized on a CompilerThread</span></span><br><span class="line">        <span class="keyword">if</span> (BootstrapJVMCI) &#123;</span><br><span class="line">          JavaThread* THREAD = thread;</span><br><span class="line">          JVMCICompiler* compiler = JVMCICompiler::instance(<span class="literal">true</span>, CATCH);</span><br><span class="line">          compiler-&gt;bootstrap(THREAD);</span><br><span class="line">          <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">            HandleMark hm;</span><br><span class="line">            vm_exit_during_initialization(Handle(THREAD, PENDING_EXCEPTION));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tracks the time application was running before GC</span></span><br><span class="line">    RuntimeService::record_application_start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify JVMTI</span></span><br><span class="line">    <span class="keyword">if</span> (JvmtiExport::should_post_thread_life()) &#123;</span><br><span class="line">       JvmtiExport::post_thread_start(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    post_thread_start_event(thread);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRODUCT</span></span><br><span class="line">    <span class="comment">// Check if we should compile all classes on bootclasspath</span></span><br><span class="line">    <span class="keyword">if</span> (CompileTheWorld) ClassLoader::compile_the_world();</span><br><span class="line">    <span class="keyword">if</span> (ReplayCompiles) ciReplay::replay(thread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some platforms (like Win*) need a wrapper around these test</span></span><br><span class="line">    <span class="comment">// functions in order to properly handle error conditions.</span></span><br><span class="line">    VMError::test_error_handler();</span><br><span class="line">    <span class="keyword">if</span> (ExecuteInternalVMTests) &#123;</span><br><span class="line">      InternalVMTests::run();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since this is not a JVM_ENTRY we have to set the thread state manually before leaving.</span></span><br><span class="line">    ThreadStateTransition::transition_and_fence(thread, _thread_in_vm, _thread_in_native);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If create_vm exits because of a pending exception, exit with that</span></span><br><span class="line">    <span class="comment">// exception.  In the future when we figure out how to reclaim memory,</span></span><br><span class="line">    <span class="comment">// we may be able to exit with JNI_ERR and allow the calling application</span></span><br><span class="line">    <span class="comment">// to continue.</span></span><br><span class="line">    <span class="keyword">if</span> (Universe::is_fully_initialized()) &#123;</span><br><span class="line">      <span class="comment">// otherwise no pending exception possible - VM will already have aborted</span></span><br><span class="line">      JavaThread* THREAD = JavaThread::current();</span><br><span class="line">      <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">        HandleMark hm;</span><br><span class="line">        vm_exit_during_initialization(Handle(THREAD, PENDING_EXCEPTION));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (can_try_again) &#123;</span><br><span class="line">      <span class="comment">// reset safe_to_recreate_vm to 1 so that retrial would be possible</span></span><br><span class="line">      safe_to_recreate_vm = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Creation failed. We must reset vm_created</span></span><br><span class="line">    *vm = <span class="number">0</span>;</span><br><span class="line">    *(JNIEnv**)penv = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// reset vm_created last to avoid race condition. Use OrderAccess to</span></span><br><span class="line">    <span class="comment">// control both compiler and architectural-based reordering.</span></span><br><span class="line">    OrderAccess::release_store(&amp;vm_created, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Flush stdout and stderr before exit.</span></span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fflush(<span class="built_in">stderr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>create_vm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/hotspot/share/runtime/thread.cpp</span></span><br><span class="line">jint Threads::create_vm(JavaVMInitArgs* args, <span class="keyword">bool</span>* canTryAgain) &#123;</span><br><span class="line">  <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">JDK_Version_init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Preinitialize version info.</span></span><br><span class="line">  VM_Version::early_initialize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check version</span></span><br><span class="line">  <span class="keyword">if</span> (!is_supported_jni_version(args-&gt;version)) <span class="keyword">return</span> JNI_EVERSION;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize library-based TLS</span></span><br><span class="line">  ThreadLocalStorage::init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the output stream module</span></span><br><span class="line">  ostream_init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process java launcher properties.</span></span><br><span class="line">  Arguments::process_sun_java_launcher_properties(args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the os module</span></span><br><span class="line">  os::init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record VM creation timing statistics</span></span><br><span class="line">  TraceVmCreationTime create_vm_timer;</span><br><span class="line">  create_vm_timer.start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize system properties.</span></span><br><span class="line">  Arguments::init_system_properties();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// So that JDK version can be used as a discriminator when parsing arguments</span></span><br><span class="line">  JDK_Version_init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update/Initialize System properties after JDK version number is known</span></span><br><span class="line">  Arguments::init_version_specific_system_properties();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure to initialize log configuration *before* parsing arguments</span></span><br><span class="line">  LogConfiguration::initialize(create_vm_timer.begin_time());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse arguments</span></span><br><span class="line">  <span class="comment">// Note: this internally calls os::init_container_support()</span></span><br><span class="line">  jint parse_result = Arguments::parse(args);</span><br><span class="line">  <span class="keyword">if</span> (parse_result != JNI_OK) <span class="keyword">return</span> parse_result;</span><br><span class="line"></span><br><span class="line">  os::init_before_ergo();</span><br><span class="line"></span><br><span class="line">  jint ergo_result = Arguments::apply_ergo();</span><br><span class="line">  <span class="keyword">if</span> (ergo_result != JNI_OK) <span class="keyword">return</span> ergo_result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Final check of all ranges after ergonomics which may change values.</span></span><br><span class="line">  <span class="keyword">if</span> (!JVMFlagRangeList::check_ranges()) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Final check of all 'AfterErgo' constraints after ergonomics which may change values.</span></span><br><span class="line">  <span class="keyword">bool</span> constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);</span><br><span class="line">  <span class="keyword">if</span> (!constraint_result) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  JVMFlagWriteableList::mark_startup();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (PauseAtStartup) &#123;</span><br><span class="line">    os::pause();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  HOTSPOT_VM_INIT_BEGIN();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Timing (must come after argument parsing)</span></span><br><span class="line">  <span class="function">TraceTime <span class="title">timer</span><span class="params">(<span class="string">"Create VM"</span>, TRACETIME_LOG(Info, startuptime))</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the os module after parsing the args</span></span><br><span class="line">  jint os_init_2_result = os::init_2();</span><br><span class="line">  <span class="keyword">if</span> (os_init_2_result != JNI_OK) <span class="keyword">return</span> os_init_2_result;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CAN_SHOW_REGISTERS_ON_ASSERT</span></span><br><span class="line">  <span class="comment">// Initialize assert poison page mechanism.</span></span><br><span class="line">  <span class="keyword">if</span> (ShowRegistersOnAssert) &#123;</span><br><span class="line">    initialize_assert_poison();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// CAN_SHOW_REGISTERS_ON_ASSERT</span></span></span><br><span class="line"></span><br><span class="line">  SafepointMechanism::initialize();</span><br><span class="line"></span><br><span class="line">  jint adjust_after_os_result = Arguments::adjust_after_os();</span><br><span class="line">  <span class="keyword">if</span> (adjust_after_os_result != JNI_OK) <span class="keyword">return</span> adjust_after_os_result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize output stream logging</span></span><br><span class="line">  ostream_init_log();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Convert -Xrun to -agentlib: if there is no JVM_OnLoad</span></span><br><span class="line">  <span class="comment">// Must be before create_vm_init_agents()</span></span><br><span class="line">  <span class="keyword">if</span> (Arguments::init_libraries_at_startup()) &#123;</span><br><span class="line">    convert_vm_init_libraries_to_agents();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Launch -agentlib/-agentpath and converted -Xrun agents</span></span><br><span class="line">  <span class="keyword">if</span> (Arguments::init_agents_at_startup()) &#123;</span><br><span class="line">    create_vm_init_agents();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize Threads state</span></span><br><span class="line">  _thread_list = <span class="literal">NULL</span>;</span><br><span class="line">  _number_of_threads = <span class="number">0</span>;</span><br><span class="line">  _number_of_non_daemon_threads = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize global data structures and create system classes in heap</span></span><br><span class="line">  vm_init_globals();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_JVMCI</span></span><br><span class="line">  <span class="keyword">if</span> (JVMCICounterSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);</span><br><span class="line">    <span class="built_in">memset</span>(JavaThread::_jvmci_old_thread_counters, <span class="number">0</span>, <span class="keyword">sizeof</span>(jlong) * JVMCICounterSize);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    JavaThread::_jvmci_old_thread_counters = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_JVMCI</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Attach the main thread to this os thread</span></span><br><span class="line">  JavaThread* main_thread = <span class="keyword">new</span> JavaThread();</span><br><span class="line">  main_thread-&gt;set_thread_state(_thread_in_vm);</span><br><span class="line">  main_thread-&gt;initialize_thread_current();</span><br><span class="line">  <span class="comment">// must do this before set_active_handles</span></span><br><span class="line">  main_thread-&gt;record_stack_base_and_size();</span><br><span class="line">  main_thread-&gt;register_thread_stack_with_NMT();</span><br><span class="line">  main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!main_thread-&gt;set_as_starting_thread()) &#123;</span><br><span class="line">    vm_shutdown_during_initialization(</span><br><span class="line">                                      <span class="string">"Failed necessary internal allocation. Out of swap space"</span>);</span><br><span class="line">    main_thread-&gt;smr_delete();</span><br><span class="line">    *canTryAgain = <span class="literal">false</span>; <span class="comment">// don't let caller call JNI_CreateJavaVM again</span></span><br><span class="line">    <span class="keyword">return</span> JNI_ENOMEM;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Enable guard page *after* os::create_main_thread(), otherwise it would</span></span><br><span class="line">  <span class="comment">// crash Linux VM, see notes in os_linux.cpp.</span></span><br><span class="line">  main_thread-&gt;create_stack_guard_pages();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize Java-Level synchronization subsystem</span></span><br><span class="line">  ObjectMonitor::Initialize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize global modules</span></span><br><span class="line">  jint status = init_globals();</span><br><span class="line">  <span class="keyword">if</span> (status != JNI_OK) &#123;</span><br><span class="line">    main_thread-&gt;smr_delete();</span><br><span class="line">    *canTryAgain = <span class="literal">false</span>; <span class="comment">// don't let caller call JNI_CreateJavaVM again</span></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  JFR_ONLY(Jfr::on_create_vm_1();)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Should be done after the heap is fully created</span></span><br><span class="line">  main_thread-&gt;cache_global_variables();</span><br><span class="line"></span><br><span class="line">  HandleMark hm;</span><br><span class="line"></span><br><span class="line">  &#123; <span class="function">MutexLocker <span class="title">mu</span><span class="params">(Threads_lock)</span></span>;</span><br><span class="line">    Threads::add(main_thread);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Any JVMTI raw monitors entered in onload will transition into</span></span><br><span class="line">  <span class="comment">// real raw monitor. VM is setup enough here for raw monitor enter.</span></span><br><span class="line">  JvmtiExport::transition_pending_onload_raw_monitors();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the VMThread</span></span><br><span class="line">  &#123; <span class="function">TraceTime <span class="title">timer</span><span class="params">(<span class="string">"Start VMThread"</span>, TRACETIME_LOG(Info, startuptime))</span></span>;</span><br><span class="line"></span><br><span class="line">  VMThread::create();</span><br><span class="line">    Thread* vmthread = VMThread::vm_thread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!os::create_thread(vmthread, os::vm_thread)) &#123;</span><br><span class="line">      vm_exit_during_initialization(<span class="string">"Cannot create VM thread. "</span></span><br><span class="line">                                    <span class="string">"Out of system resources."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait for the VM thread to become ready, and VMThread::run to initialize</span></span><br><span class="line">    <span class="comment">// Monitors can have spurious returns, must always check another state flag</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">MutexLocker <span class="title">ml</span><span class="params">(Notify_lock)</span></span>;</span><br><span class="line">      os::start_thread(vmthread);</span><br><span class="line">      <span class="keyword">while</span> (vmthread-&gt;active_handles() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        Notify_lock-&gt;wait();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert(Universe::is_fully_initialized(), <span class="string">"not initialized"</span>);</span><br><span class="line">  <span class="keyword">if</span> (VerifyDuringStartup) &#123;</span><br><span class="line">    <span class="comment">// Make sure we're starting with a clean slate.</span></span><br><span class="line">    VM_Verify verify_op;</span><br><span class="line">    VMThread::execute(&amp;verify_op);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We need this to update the java.vm.info property in case any flags used</span></span><br><span class="line">  <span class="comment">// to initially define it have been changed. This is needed for both CDS and</span></span><br><span class="line">  <span class="comment">// AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info</span></span><br><span class="line">  <span class="comment">// is initially computed. See Abstract_VM_Version::vm_info_string().</span></span><br><span class="line">  <span class="comment">// This update must happen before we initialize the java classes, but</span></span><br><span class="line">  <span class="comment">// after any initialization logic that might modify the flags.</span></span><br><span class="line">  Arguments::update_vm_info_property(VM_Version::vm_info_string());</span><br><span class="line"></span><br><span class="line">  Thread* THREAD = Thread::current();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call even when there are not JVMTI environments yet, since environments</span></span><br><span class="line">  <span class="comment">// may be attached late and JVMTI must track phases of VM execution</span></span><br><span class="line">  JvmtiExport::enter_early_start_phase();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.</span></span><br><span class="line">  JvmtiExport::post_early_vm_start();</span><br><span class="line"></span><br><span class="line">  initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line">  quicken_jni_functions();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No more stub generation allowed after that point.</span></span><br><span class="line">  StubCodeDesc::freeze();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set flag that basic initialization has completed. Used by exceptions and various</span></span><br><span class="line">  <span class="comment">// debug stuff, that does not work until all basic classes have been initialized.</span></span><br><span class="line">  set_init_completed();</span><br><span class="line"></span><br><span class="line">  LogConfiguration::post_initialize();</span><br><span class="line">  Metaspace::post_initialize();</span><br><span class="line"></span><br><span class="line">  HOTSPOT_VM_INIT_END();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// record VM initialization completion time</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_MANAGEMENT</span></span><br><span class="line">  Management::record_vm_init_completed();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_MANAGEMENT</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Signal Dispatcher needs to be started before VMInit event is posted</span></span><br><span class="line">  os::initialize_jdk_signal_support(CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start Attach Listener if +StartAttachListener or it can't be started lazily</span></span><br><span class="line">  <span class="keyword">if</span> (!DisableAttachMechanism) &#123;</span><br><span class="line">    AttachListener::vm_start();</span><br><span class="line">    <span class="keyword">if</span> (StartAttachListener || AttachListener::init_at_startup()) &#123;</span><br><span class="line">      AttachListener::init();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Launch -Xrun agents</span></span><br><span class="line">  <span class="comment">// Must be done in the JVMTI live phase so that for backward compatibility the JDWP</span></span><br><span class="line">  <span class="comment">// back-end can launch with -Xdebug -Xrunjdwp.</span></span><br><span class="line">  <span class="keyword">if</span> (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) &#123;</span><br><span class="line">    create_vm_init_libraries();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CleanChunkPoolAsync) &#123;</span><br><span class="line">    Chunk::start_chunk_pool_cleaner_task();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize compiler(s)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(COMPILER1) || COMPILER2_OR_JVMCI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_JVMCI</span></span><br><span class="line">  <span class="keyword">bool</span> force_JVMCI_intialization = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (EnableJVMCI) &#123;</span><br><span class="line">    <span class="comment">// Initialize JVMCI eagerly when it is explicitly requested.</span></span><br><span class="line">    <span class="comment">// Or when JVMCIPrintProperties is enabled.</span></span><br><span class="line">    <span class="comment">// The JVMCI Java initialization code will read this flag and</span></span><br><span class="line">    <span class="comment">// do the printing if it's set.</span></span><br><span class="line">    force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!force_JVMCI_intialization) &#123;</span><br><span class="line">      <span class="comment">// 8145270: Force initialization of JVMCI runtime otherwise requests for blocking</span></span><br><span class="line">      <span class="comment">// compilations via JVMCI will not actually block until JVMCI is initialized.</span></span><br><span class="line">      force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);</span><br><span class="line">  <span class="comment">// Postpone completion of compiler initialization to after JVMCI</span></span><br><span class="line">  <span class="comment">// is initialized to avoid timeouts of blocking compilations.</span></span><br><span class="line">  <span class="keyword">if</span> (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(<span class="literal">true</span>)) &#123;</span><br><span class="line">    CompileBroker::compilation_init_phase2();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Pre-initialize some JSR292 core classes to avoid deadlock during class loading.</span></span><br><span class="line">  <span class="comment">// It is done after compilers are initialized, because otherwise compilations of</span></span><br><span class="line">  <span class="comment">// signature polymorphic MH intrinsics can be missed</span></span><br><span class="line">  <span class="comment">// (see SystemDictionary::find_method_handle_intrinsic).</span></span><br><span class="line">  initialize_jsr292_core_classes(CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This will initialize the module system.  Only java.base classes can be</span></span><br><span class="line">  <span class="comment">// loaded until phase 2 completes</span></span><br><span class="line">  call_initPhase2(CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line">  JFR_ONLY(Jfr::on_create_vm_2();)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call even when there are not JVMTI environments yet, since environments</span></span><br><span class="line">  <span class="comment">// may be attached late and JVMTI must track phases of VM execution</span></span><br><span class="line">  JvmtiExport::enter_start_phase();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.</span></span><br><span class="line">  JvmtiExport::post_vm_start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Final system initialization including security manager and system class loader</span></span><br><span class="line">  call_initPhase3(CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cache the system and platform class loaders</span></span><br><span class="line">  SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><br><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">    <span class="comment">// capture the module path info from the ModuleEntryTable</span></span><br><span class="line">    ClassLoader::initialize_module_path(THREAD);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_JVMCI</span></span><br><span class="line">  <span class="keyword">if</span> (force_JVMCI_intialization) &#123;</span><br><span class="line">    JVMCIRuntime::force_initialization(CHECK_JNI_ERR);</span><br><span class="line">    CompileBroker::compilation_init_phase2();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call even when there are not JVMTI environments yet, since environments</span></span><br><span class="line">  <span class="comment">// may be attached late and JVMTI must track phases of VM execution</span></span><br><span class="line">  JvmtiExport::enter_live_phase();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Notify JVMTI agents that VM initialization is complete - nop if no agents.</span></span><br><span class="line">  JvmtiExport::post_vm_initialized();</span><br><span class="line"></span><br><span class="line">  JFR_ONLY(Jfr::on_create_vm_3();)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_MANAGEMENT</span></span><br><span class="line">  Management::initialize(THREAD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">    <span class="comment">// management agent fails to start possibly due to</span></span><br><span class="line">    <span class="comment">// configuration problem and is responsible for printing</span></span><br><span class="line">    <span class="comment">// stack trace if appropriate. Simply exit VM.</span></span><br><span class="line">    vm_exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_MANAGEMENT</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (MemProfiling)                   MemProfiler::engage();</span><br><span class="line">  StatSampler::engage();</span><br><span class="line">  <span class="keyword">if</span> (CheckJNICalls)                  JniPeriodicChecker::engage();</span><br><span class="line"></span><br><span class="line">  BiasedLocking::init();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_RTM_OPT</span></span><br><span class="line">  RTMLockingCounters::init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (JDK_Version::current().post_vm_init_hook_enabled()) &#123;</span><br><span class="line">    call_postVMInitHook(THREAD);</span><br><span class="line">    <span class="comment">// The Java side of PostVMInitHook.run must deal with all</span></span><br><span class="line">    <span class="comment">// exceptions and provide means of diagnosis.</span></span><br><span class="line">    <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">      CLEAR_PENDING_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">MutexLocker <span class="title">ml</span><span class="params">(PeriodicTask_lock)</span></span>;</span><br><span class="line">    <span class="comment">// Make sure the WatcherThread can be started by WatcherThread::start()</span></span><br><span class="line">    <span class="comment">// or by dynamic enrollment.</span></span><br><span class="line">    WatcherThread::make_startable();</span><br><span class="line">    <span class="comment">// Start up the WatcherThread if there are any periodic tasks</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span>  All PeriodicTasks should be registered by now. If they</span></span><br><span class="line">    <span class="comment">//   aren't, late joiners might appear to start slowly (we might</span></span><br><span class="line">    <span class="comment">//   take a while to process their first tick).</span></span><br><span class="line">    <span class="keyword">if</span> (PeriodicTask::num_tasks() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      WatcherThread::start();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  create_vm_timer.end();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><br><span class="line">  _vm_complete = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">    MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);</span><br><span class="line">    ShouldNotReachHere();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>vm_init_globals</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/hotspot/share/runtime/init.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vm_init_globals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  check_ThreadShadow();</span><br><span class="line">  <span class="comment">// 基础类型初始化</span></span><br><span class="line">  basic_types_init();</span><br><span class="line">  eventlog_init();</span><br><span class="line">  <span class="comment">// 互斥锁</span></span><br><span class="line">  mutex_init();</span><br><span class="line">  chunkpool_init();</span><br><span class="line">  perfMemory_init();</span><br><span class="line">  SuspendibleThreadSet_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>init_globals</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/hotspot/share/runtime/init.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">init_globals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HandleMark hm;</span><br><span class="line">  management_init();</span><br><span class="line"> <span class="comment">// 操作符初始化</span></span><br><span class="line">  bytecodes_init();</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  classLoader_init1();</span><br><span class="line">  compilationPolicy_init();</span><br><span class="line">  codeCache_init();</span><br><span class="line">  VM_Version_init();</span><br><span class="line">  os_init_globals();</span><br><span class="line">  stubRoutines_init1();</span><br><span class="line">  <span class="comment">// 堆初始化</span></span><br><span class="line">  jint status = universe_init();  <span class="comment">// dependent on codeCache_init and</span></span><br><span class="line">                                  <span class="comment">// stubRoutines_init1 and metaspace_init.</span></span><br><span class="line">  <span class="keyword">if</span> (status != JNI_OK)</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">  gc_barrier_stubs_init();   <span class="comment">// depends on universe_init, must be before interpreter_init</span></span><br><span class="line">  interpreter_init();        <span class="comment">// before any methods loaded</span></span><br><span class="line">  invocationCounter_init();  <span class="comment">// before any methods loaded</span></span><br><span class="line">  accessFlags_init();</span><br><span class="line">  templateTable_init();</span><br><span class="line">  InterfaceSupport_init();</span><br><span class="line">  VMRegImpl::set_regName();  <span class="comment">// need this before generate_stubs (for printing oop maps).</span></span><br><span class="line">  SharedRuntime::generate_stubs();</span><br><span class="line">  universe2_init();  <span class="comment">// dependent on codeCache_init and stubRoutines_init1</span></span><br><span class="line">  javaClasses_init();<span class="comment">// must happen after vtable initialization, before referenceProcessor_init</span></span><br><span class="line">  referenceProcessor_init();</span><br><span class="line">  jni_handles_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_VM_STRUCTS</span></span><br><span class="line">  vmStructs_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_VM_STRUCTS</span></span></span><br><span class="line"></span><br><span class="line">  vtableStubs_init();</span><br><span class="line">  InlineCacheBuffer_init();</span><br><span class="line">  compilerOracle_init();</span><br><span class="line">  dependencyContext_init();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!compileBroker_init()) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!universe_post_init()) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line">  stubRoutines_init2(); <span class="comment">// note: StubRoutines need 2-phase init</span></span><br><span class="line">  MethodHandles::generate_adapters();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_NMT</span></span><br><span class="line">  <span class="comment">// Solaris stack is walkable only after stubRoutines are set up.</span></span><br><span class="line">  <span class="comment">// On Other platforms, the stack is always walkable.</span></span><br><span class="line">  NMT_stack_walkable = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_NMT</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// All the flags that get adjusted by VM_Version_init and os::init_2</span></span><br><span class="line">  <span class="comment">// have been set so dump the flags now.</span></span><br><span class="line">  <span class="keyword">if</span> (PrintFlagsFinal || PrintFlagsRanges) &#123;</span><br><span class="line">    JVMFlag::printFlags(tty, <span class="literal">false</span>, PrintFlagsRanges);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>universe_init</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 /src/hotspot/share/memory/universe.cpp</span></span><br><span class="line"><span class="function">jint <span class="title">universe_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  assert(!Universe::_fully_initialized, <span class="string">"called after initialize_vtables"</span>);</span><br><span class="line">  guarantee(<span class="number">1</span> &lt;&lt; LogHeapWordSize == <span class="keyword">sizeof</span>(HeapWord),</span><br><span class="line">         <span class="string">"LogHeapWordSize is incorrect."</span>);</span><br><span class="line">  guarantee(<span class="keyword">sizeof</span>(oop) &gt;= <span class="keyword">sizeof</span>(HeapWord), <span class="string">"HeapWord larger than oop?"</span>);</span><br><span class="line">  guarantee(<span class="keyword">sizeof</span>(oop) % <span class="keyword">sizeof</span>(HeapWord) == <span class="number">0</span>,</span><br><span class="line">            <span class="string">"oop size is not not a multiple of HeapWord size"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function">TraceTime <span class="title">timer</span><span class="params">(<span class="string">"Genesis"</span>, TRACETIME_LOG(Info, startuptime))</span></span>;</span><br><span class="line"></span><br><span class="line">  JavaClasses::compute_hard_coded_offsets();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化堆</span></span><br><span class="line">  jint status = Universe::initialize_heap();</span><br><span class="line">  <span class="keyword">if</span> (status != JNI_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SystemDictionary::initialize_oop_storage();</span><br><span class="line"></span><br><span class="line">  Metaspace::global_initialize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize performance counters for metaspaces</span></span><br><span class="line">  MetaspaceCounters::initialize_performance_counters();</span><br><span class="line">  CompressedClassSpaceCounters::initialize_performance_counters();</span><br><span class="line"></span><br><span class="line">  AOTLoader::universe_init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Checks 'AfterMemoryInit' constraints.</span></span><br><span class="line">  <span class="keyword">if</span> (!JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterMemoryInit)) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create memory for metadata.  Must be after initializing heap for</span></span><br><span class="line">  <span class="comment">// DumpSharedSpaces.</span></span><br><span class="line">  ClassLoaderData::init_null_class_loader_data();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We have a heap so create the Method* caches before</span></span><br><span class="line">  <span class="comment">// Metaspace::initialize_shared_spaces() tries to populate them.</span></span><br><span class="line">  Universe::_finalizer_register_cache = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line">  Universe::_loader_addClass_cache    = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line">  Universe::_pd_implies_cache         = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line">  Universe::_throw_illegal_access_error_cache = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line">  Universe::_throw_no_such_method_error_cache = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line">  Universe::_do_stack_walk_cache = <span class="keyword">new</span> LatestMethodCache();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><br><span class="line">  <span class="keyword">if</span> (UseSharedSpaces) &#123;</span><br><span class="line">    <span class="comment">// Read the data structures supporting the shared spaces (shared</span></span><br><span class="line">    <span class="comment">// system dictionary, symbol table, etc.).  After that, access to</span></span><br><span class="line">    <span class="comment">// the file (other than the mapped regions) is no longer needed, and</span></span><br><span class="line">    <span class="comment">// the file is closed. Closing the file does not affect the</span></span><br><span class="line">    <span class="comment">// currently mapped regions.</span></span><br><span class="line">    MetaspaceShared::initialize_shared_spaces();</span><br><span class="line">    StringTable::create_table();</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">  &#123;</span><br><span class="line">    SymbolTable::create_table();</span><br><span class="line">    StringTable::create_table();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><br><span class="line">    <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">      MetaspaceShared::prepare_for_dumping();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(VerifySubSet) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    Universe::initialize_verify_flags();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ResolvedMethodTable::create_table();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>initialize_heap</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 /src/hotspot/share/memory/universe.cpp</span></span><br><span class="line"></span><br><span class="line">jint Universe::initialize_heap() &#123;</span><br><span class="line">  _collectedHeap = create_heap();</span><br><span class="line">  jint status = _collectedHeap-&gt;initialize();</span><br><span class="line">  <span class="keyword">if</span> (status != JNI_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125;</span><br><span class="line">  log_info(gc)(<span class="string">"Using %s"</span>, _collectedHeap-&gt;name());</span><br><span class="line"></span><br><span class="line">  ThreadLocalAllocBuffer::set_max_size(Universe::heap()-&gt;max_tlab_size());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LP64</span></span><br><span class="line">  <span class="keyword">if</span> (UseCompressedOops) &#123;</span><br><span class="line">    <span class="comment">// Subtract a page because something can get allocated at heap base.</span></span><br><span class="line">    <span class="comment">// This also makes implicit null checking work, because the</span></span><br><span class="line">    <span class="comment">// memory+1 page below heap_base needs to cause a signal.</span></span><br><span class="line">    <span class="comment">// See needs_explicit_null_check.</span></span><br><span class="line">    <span class="comment">// Only set the heap base for compressed oops because it indicates</span></span><br><span class="line">    <span class="comment">// compressed oops for pstack code.</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">uint64_t</span>)Universe::heap()-&gt;reserved_region().end() &gt; UnscaledOopHeapMax) &#123;</span><br><span class="line">      <span class="comment">// Didn't reserve heap below 4Gb.  Must shift.</span></span><br><span class="line">      Universe::set_narrow_oop_shift(LogMinObjAlignmentInBytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">uint64_t</span>)Universe::heap()-&gt;reserved_region().end() &lt;= OopEncodingHeapMax) &#123;</span><br><span class="line">      <span class="comment">// Did reserve heap below 32Gb. Can use base == 0;</span></span><br><span class="line">      Universe::set_narrow_oop_base(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    AOTLoader::set_narrow_oop_shift();</span><br><span class="line"></span><br><span class="line">    Universe::set_narrow_ptrs_base(Universe::narrow_oop_base());</span><br><span class="line"></span><br><span class="line">    LogTarget(Info, gc, heap, coops) lt;</span><br><span class="line">    <span class="keyword">if</span> (lt.is_enabled()) &#123;</span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      <span class="function">LogStream <span class="title">ls</span><span class="params">(lt)</span></span>;</span><br><span class="line">      Universe::print_compressed_oops_mode(&amp;ls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell tests in which mode we run.</span></span><br><span class="line">    Arguments::PropertyList_add(<span class="keyword">new</span> SystemProperty(<span class="string">"java.vm.compressedOopsMode"</span>,</span><br><span class="line">                                                   narrow_oop_mode_to_string(narrow_oop_mode()),</span><br><span class="line">                                                   <span class="literal">false</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Universe::narrow_oop_base() is one page below the heap.</span></span><br><span class="line">  assert((<span class="keyword">intptr_t</span>)Universe::narrow_oop_base() &lt;= (<span class="keyword">intptr_t</span>)(Universe::heap()-&gt;base() -</span><br><span class="line">         os::vm_page_size()) ||</span><br><span class="line">         Universe::narrow_oop_base() == <span class="literal">NULL</span>, <span class="string">"invalid value"</span>);</span><br><span class="line">  assert(Universe::narrow_oop_shift() == LogMinObjAlignmentInBytes ||</span><br><span class="line">         Universe::narrow_oop_shift() == <span class="number">0</span>, <span class="string">"invalid value"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We will never reach the CATCH below since Exceptions::_throw will cause</span></span><br><span class="line">  <span class="comment">// the VM to exit if an exception is thrown during initialization</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (UseTLAB) &#123;</span><br><span class="line">    assert(Universe::heap()-&gt;supports_tlab_allocation(),</span><br><span class="line">           <span class="string">"Should support thread-local allocation buffers"</span>);</span><br><span class="line">    ThreadLocalAllocBuffer::startup_initialization();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>create_heap</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 /src/hotspot/share/memory/universe.cpp</span></span><br><span class="line"></span><br><span class="line">CollectedHeap* Universe::create_heap() &#123;</span><br><span class="line">  assert(_collectedHeap == <span class="literal">NULL</span>, <span class="string">"Heap already created"</span>);</span><br><span class="line">  <span class="keyword">return</span> GCConfig::arguments()-&gt;create_heap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>create_heap</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 假设是G1垃圾回收器</span><br><span class="line">// 文件： /src/hotspot/share/gc/g1/g1Arguments.cpp</span><br><span class="line">CollectedHeap* G1Arguments::create_heap() &#123;</span><br><span class="line">  return create_heap_with_policy&lt;G1CollectedHeap, G1CollectorPolicy&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>G1CollectedHeap 的构造方法</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 文件 /src/hotspot/share/gc/g1/g1CollectedHeap.cpp</span></span><br><span class="line">G1CollectedHeap::G1CollectedHeap(G1CollectorPolicy* collector_policy) :</span><br><span class="line">  CollectedHeap(),</span><br><span class="line">  _young_gen_sampling_thread(<span class="literal">NULL</span>),</span><br><span class="line">  _collector_policy(collector_policy),</span><br><span class="line">  _soft_ref_policy(),</span><br><span class="line">  _card_table(<span class="literal">NULL</span>),</span><br><span class="line">  _memory_manager(<span class="string">"G1 Young Generation"</span>, <span class="string">"end of minor GC"</span>),</span><br><span class="line">  _full_gc_memory_manager(<span class="string">"G1 Old Generation"</span>, <span class="string">"end of major GC"</span>),</span><br><span class="line">  _eden_pool(<span class="literal">NULL</span>),</span><br><span class="line">  _survivor_pool(<span class="literal">NULL</span>),</span><br><span class="line">  _old_pool(<span class="literal">NULL</span>),</span><br><span class="line">  _gc_timer_stw(<span class="keyword">new</span> (ResourceObj::C_HEAP, mtGC) STWGCTimer()),</span><br><span class="line">  _gc_tracer_stw(<span class="keyword">new</span> (ResourceObj::C_HEAP, mtGC) G1NewTracer()),</span><br><span class="line">  _g1_policy(<span class="keyword">new</span> G1Policy(_gc_timer_stw)),</span><br><span class="line">  _collection_set(<span class="keyword">this</span>, _g1_policy),</span><br><span class="line">  _dirty_card_queue_set(<span class="literal">false</span>),</span><br><span class="line">  _ref_processor_stw(<span class="literal">NULL</span>),</span><br><span class="line">  _is_alive_closure_stw(<span class="keyword">this</span>),</span><br><span class="line">  _is_subject_to_discovery_stw(<span class="keyword">this</span>),</span><br><span class="line">  _ref_processor_cm(<span class="literal">NULL</span>),</span><br><span class="line">  _is_alive_closure_cm(<span class="keyword">this</span>),</span><br><span class="line">  _is_subject_to_discovery_cm(<span class="keyword">this</span>),</span><br><span class="line">  _bot(<span class="literal">NULL</span>),</span><br><span class="line">  _hot_card_cache(<span class="literal">NULL</span>),</span><br><span class="line">  _g1_rem_set(<span class="literal">NULL</span>),</span><br><span class="line">  _cr(<span class="literal">NULL</span>),</span><br><span class="line">  _g1mm(<span class="literal">NULL</span>),</span><br><span class="line">  _preserved_marks_set(<span class="literal">true</span> <span class="comment">/* in_c_heap */</span>),</span><br><span class="line">  _old_set(<span class="string">"Old Set"</span>, <span class="literal">false</span> <span class="comment">/* humongous */</span>, <span class="keyword">new</span> OldRegionSetMtSafeChecker()),</span><br><span class="line">  _humongous_set(<span class="string">"Master Humongous Set"</span>, <span class="literal">true</span> <span class="comment">/* humongous */</span>, <span class="keyword">new</span> HumongousRegionSetMtSafeChecker()),</span><br><span class="line">  _humongous_reclaim_candidates(),</span><br><span class="line">  _has_humongous_reclaim_candidates(<span class="literal">false</span>),</span><br><span class="line">  _archive_allocator(<span class="literal">NULL</span>),</span><br><span class="line">  _summary_bytes_used(<span class="number">0</span>),</span><br><span class="line">  _survivor_evac_stats(<span class="string">"Young"</span>, YoungPLABSize, PLABWeight),</span><br><span class="line">  _old_evac_stats(<span class="string">"Old"</span>, OldPLABSize, PLABWeight),</span><br><span class="line">  _expand_heap_after_alloc_failure(<span class="literal">true</span>),</span><br><span class="line">  _old_marking_cycles_started(<span class="number">0</span>),</span><br><span class="line">  _old_marking_cycles_completed(<span class="number">0</span>),</span><br><span class="line">  _in_cset_fast_test() &#123;</span><br><span class="line"></span><br><span class="line">  _workers = <span class="keyword">new</span> WorkGang(<span class="string">"GC Thread"</span>, ParallelGCThreads,</span><br><span class="line">                          <span class="comment">/* are_GC_task_threads */</span><span class="literal">true</span>,</span><br><span class="line">                          <span class="comment">/* are_ConcurrentGC_threads */</span><span class="literal">false</span>);</span><br><span class="line">  _workers-&gt;initialize_workers();</span><br><span class="line">  _verifier = <span class="keyword">new</span> G1HeapVerifier(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  _allocator = <span class="keyword">new</span> G1Allocator(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  _heap_sizing_policy = G1HeapSizingPolicy::create(<span class="keyword">this</span>, _g1_policy-&gt;analytics());</span><br><span class="line"></span><br><span class="line">  _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Override the default _filler_array_max_size so that no humongous filler</span></span><br><span class="line">  <span class="comment">// objects are created.</span></span><br><span class="line">  _filler_array_max_size = _humongous_object_threshold_in_words;</span><br><span class="line"></span><br><span class="line">  uint n_queues = ParallelGCThreads;</span><br><span class="line">  _task_queues = <span class="keyword">new</span> RefToScanQueueSet(n_queues);</span><br><span class="line"></span><br><span class="line">  _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; n_queues; i++) &#123;</span><br><span class="line">    RefToScanQueue* q = <span class="keyword">new</span> RefToScanQueue();</span><br><span class="line">    q-&gt;initialize();</span><br><span class="line">    _task_queues-&gt;register_queue(i, q);</span><br><span class="line">    ::<span class="keyword">new</span> (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the G1EvacuationFailureALot counters and flags.</span></span><br><span class="line">  NOT_PRODUCT(reset_evacuation_should_fail();)</span><br><span class="line">  _gc_tracer_stw-&gt;initialize();</span><br><span class="line"></span><br><span class="line">  guarantee(_task_queues != <span class="literal">NULL</span>, <span class="string">"task_queues allocation failure."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>initialize</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件： /src/hotspot/share/gc/g1/g1CollectedHeap.cpp</span></span><br><span class="line">jint G1CollectedHeap::initialize() &#123;</span><br><span class="line">  os::enable_vtime();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Necessary to satisfy locking discipline assertions.</span></span><br><span class="line"></span><br><span class="line">  <span class="function">MutexLocker <span class="title">x</span><span class="params">(Heap_lock)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// While there are no constraints in the GC code that HeapWordSize</span></span><br><span class="line">  <span class="comment">// be any particular value, there are multiple other areas in the</span></span><br><span class="line">  <span class="comment">// system which believe this to be true (e.g. oop-&gt;object_size in some</span></span><br><span class="line">  <span class="comment">// cases incorrectly returns the size in wordSize units rather than</span></span><br><span class="line">  <span class="comment">// HeapWordSize).</span></span><br><span class="line">  guarantee(HeapWordSize == wordSize, <span class="string">"HeapWordSize must equal wordSize"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> init_byte_size = collector_policy()-&gt;initial_heap_byte_size();</span><br><span class="line">  <span class="keyword">size_t</span> max_byte_size = collector_policy()-&gt;max_heap_byte_size();</span><br><span class="line">  <span class="keyword">size_t</span> heap_alignment = collector_policy()-&gt;heap_alignment();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure that the sizes are properly aligned.</span></span><br><span class="line">  Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, <span class="string">"g1 heap"</span>);</span><br><span class="line">  Universe::check_alignment(max_byte_size, HeapRegion::GrainBytes, <span class="string">"g1 heap"</span>);</span><br><span class="line">  Universe::check_alignment(max_byte_size, heap_alignment, <span class="string">"g1 heap"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reserve the maximum.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// When compressed oops are enabled, the preferred heap base</span></span><br><span class="line">  <span class="comment">// is calculated by subtracting the requested size from the</span></span><br><span class="line">  <span class="comment">// 32Gb boundary and using the result as the base address for</span></span><br><span class="line">  <span class="comment">// heap reservation. If the requested size is not aligned to</span></span><br><span class="line">  <span class="comment">// HeapRegion::GrainBytes (i.e. the alignment that is passed</span></span><br><span class="line">  <span class="comment">// into the ReservedHeapSpace constructor) then the actual</span></span><br><span class="line">  <span class="comment">// base of the reserved heap may end up differing from the</span></span><br><span class="line">  <span class="comment">// address that was requested (i.e. the preferred heap base).</span></span><br><span class="line">  <span class="comment">// If this happens then we could end up using a non-optimal</span></span><br><span class="line">  <span class="comment">// compressed oops mode.</span></span><br><span class="line"></span><br><span class="line">  ReservedSpace heap_rs = Universe::reserve_heap(max_byte_size,</span><br><span class="line">                                                 heap_alignment);</span><br><span class="line"></span><br><span class="line">  initialize_reserved_region((HeapWord*)heap_rs.base(), (HeapWord*)(heap_rs.base() + heap_rs.size()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the barrier set for the entire reserved region.</span></span><br><span class="line">  G1CardTable* ct = <span class="keyword">new</span> G1CardTable(reserved_region());</span><br><span class="line">  ct-&gt;initialize();</span><br><span class="line">  G1BarrierSet* bs = <span class="keyword">new</span> G1BarrierSet(ct);</span><br><span class="line">  bs-&gt;initialize();</span><br><span class="line">  assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), <span class="string">"sanity"</span>);</span><br><span class="line">  BarrierSet::set_barrier_set(bs);</span><br><span class="line">  _card_table = ct;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the hot card cache.</span></span><br><span class="line">  _hot_card_cache = <span class="keyword">new</span> G1HotCardCache(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Carve out the G1 part of the heap.</span></span><br><span class="line">  ReservedSpace g1_rs = heap_rs.first_part(max_byte_size);</span><br><span class="line">  <span class="keyword">size_t</span> page_size = UseLargePages ? os::large_page_size() : os::vm_page_size();</span><br><span class="line">  G1RegionToSpaceMapper* heap_storage =</span><br><span class="line">    G1RegionToSpaceMapper::create_mapper(g1_rs,</span><br><span class="line">                                         g1_rs.size(),</span><br><span class="line">                                         page_size,</span><br><span class="line">                                         HeapRegion::GrainBytes,</span><br><span class="line">                                         <span class="number">1</span>,</span><br><span class="line">                                         mtJavaHeap);</span><br><span class="line">  os::trace_page_sizes(<span class="string">"Heap"</span>,</span><br><span class="line">                       collector_policy()-&gt;min_heap_byte_size(),</span><br><span class="line">                       max_byte_size,</span><br><span class="line">                       page_size,</span><br><span class="line">                       heap_rs.base(),</span><br><span class="line">                       heap_rs.size());</span><br><span class="line">  heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.</span></span><br><span class="line">  G1RegionToSpaceMapper* bot_storage =</span><br><span class="line">    create_aux_memory_mapper(<span class="string">"Block Offset Table"</span>,</span><br><span class="line">                             G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),</span><br><span class="line">                             G1BlockOffsetTable::heap_map_factor());</span><br><span class="line"></span><br><span class="line">  G1RegionToSpaceMapper* cardtable_storage =</span><br><span class="line">    create_aux_memory_mapper(<span class="string">"Card Table"</span>,</span><br><span class="line">                             G1CardTable::compute_size(g1_rs.size() / HeapWordSize),</span><br><span class="line">                             G1CardTable::heap_map_factor());</span><br><span class="line"></span><br><span class="line">  G1RegionToSpaceMapper* card_counts_storage =</span><br><span class="line">    create_aux_memory_mapper(<span class="string">"Card Counts Table"</span>,</span><br><span class="line">                             G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),</span><br><span class="line">                             G1CardCounts::heap_map_factor());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> bitmap_size = G1CMBitMap::compute_size(g1_rs.size());</span><br><span class="line">  G1RegionToSpaceMapper* prev_bitmap_storage =</span><br><span class="line">    create_aux_memory_mapper(<span class="string">"Prev Bitmap"</span>, bitmap_size, G1CMBitMap::heap_map_factor());</span><br><span class="line">  G1RegionToSpaceMapper* next_bitmap_storage =</span><br><span class="line">    create_aux_memory_mapper(<span class="string">"Next Bitmap"</span>, bitmap_size, G1CMBitMap::heap_map_factor());</span><br><span class="line"></span><br><span class="line">  _hrm.initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);</span><br><span class="line">  _card_table-&gt;initialize(cardtable_storage);</span><br><span class="line">  <span class="comment">// Do later initialization work for concurrent refinement.</span></span><br><span class="line">  _hot_card_cache-&gt;initialize(card_counts_storage);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6843694 - ensure that the maximum region index can fit</span></span><br><span class="line">  <span class="comment">// in the remembered set structures.</span></span><br><span class="line">  <span class="keyword">const</span> uint max_region_idx = (<span class="number">1U</span> &lt;&lt; (<span class="keyword">sizeof</span>(RegionIdx_t)*BitsPerByte<span class="number">-1</span>)) - <span class="number">1</span>;</span><br><span class="line">  guarantee((max_regions() - <span class="number">1</span>) &lt;= max_region_idx, <span class="string">"too many regions"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The G1FromCardCache reserves card with value 0 as "invalid", so the heap must not</span></span><br><span class="line">  <span class="comment">// start within the first card.</span></span><br><span class="line">  guarantee(g1_rs.base() &gt;= (<span class="keyword">char</span>*)G1CardTable::card_size, <span class="string">"Java heap must not start within the first card."</span>);</span><br><span class="line">  <span class="comment">// Also create a G1 rem set.</span></span><br><span class="line">  _g1_rem_set = <span class="keyword">new</span> G1RemSet(<span class="keyword">this</span>, _card_table, _hot_card_cache);</span><br><span class="line">  _g1_rem_set-&gt;initialize(max_capacity(), max_regions());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> max_cards_per_region = ((<span class="keyword">size_t</span>)<span class="number">1</span> &lt;&lt; (<span class="keyword">sizeof</span>(CardIdx_t)*BitsPerByte<span class="number">-1</span>)) - <span class="number">1</span>;</span><br><span class="line">  guarantee(HeapRegion::CardsPerRegion &gt; <span class="number">0</span>, <span class="string">"make sure it's initialized"</span>);</span><br><span class="line">  guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,</span><br><span class="line">            <span class="string">"too many cards per region"</span>);</span><br><span class="line"></span><br><span class="line">  FreeRegionList::set_unrealistically_long_length(max_regions() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _bot = <span class="keyword">new</span> G1BlockOffsetTable(reserved_region(), bot_storage);</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    HeapWord* start = _hrm.reserved().start();</span><br><span class="line">    HeapWord* end = _hrm.reserved().end();</span><br><span class="line">    <span class="keyword">size_t</span> granularity = HeapRegion::GrainBytes;</span><br><span class="line"></span><br><span class="line">    _in_cset_fast_test.initialize(start, end, granularity);</span><br><span class="line">    _humongous_reclaim_candidates.initialize(start, end, granularity);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the G1ConcurrentMark data structure and thread.</span></span><br><span class="line">  <span class="comment">// (Must do this late, so that "max_regions" is defined.)</span></span><br><span class="line">  _cm = <span class="keyword">new</span> G1ConcurrentMark(<span class="keyword">this</span>, prev_bitmap_storage, next_bitmap_storage);</span><br><span class="line">  <span class="keyword">if</span> (_cm == <span class="literal">NULL</span> || !_cm-&gt;completed_initialization()) &#123;</span><br><span class="line">    vm_shutdown_during_initialization(<span class="string">"Could not create/initialize G1ConcurrentMark"</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_ENOMEM;</span><br><span class="line">  &#125;</span><br><span class="line">  _cm_thread = _cm-&gt;cm_thread();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now expand into the initial heap size.</span></span><br><span class="line">  <span class="keyword">if</span> (!expand(init_byte_size, _workers)) &#123;</span><br><span class="line">    vm_shutdown_during_initialization(<span class="string">"Failed to allocate initial heap."</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_ENOMEM;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform any initialization actions delegated to the policy.</span></span><br><span class="line">  g1_policy()-&gt;init(<span class="keyword">this</span>, &amp;_collection_set);</span><br><span class="line"></span><br><span class="line">  G1BarrierSet::satb_mark_queue_set().initialize(SATB_Q_CBL_mon,</span><br><span class="line">                                                 SATB_Q_FL_lock,</span><br><span class="line">                                                 G1SATBProcessCompletedThreshold,</span><br><span class="line">                                                 Shared_SATB_Q_lock);</span><br><span class="line"></span><br><span class="line">  jint ecode = initialize_concurrent_refinement();</span><br><span class="line">  <span class="keyword">if</span> (ecode != JNI_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> ecode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ecode = initialize_young_gen_sampling_thread();</span><br><span class="line">  <span class="keyword">if</span> (ecode != JNI_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> ecode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  G1BarrierSet::dirty_card_queue_set().initialize(DirtyCardQ_CBL_mon,</span><br><span class="line">                                                  DirtyCardQ_FL_lock,</span><br><span class="line">                                                  (<span class="keyword">int</span>)concurrent_refine()-&gt;yellow_zone(),</span><br><span class="line">                                                  (<span class="keyword">int</span>)concurrent_refine()-&gt;red_zone(),</span><br><span class="line">                                                  Shared_DirtyCardQ_lock,</span><br><span class="line">                                                  <span class="literal">NULL</span>,  <span class="comment">// fl_owner</span></span><br><span class="line">                                                  <span class="literal">true</span>); <span class="comment">// init_free_ids</span></span><br><span class="line"></span><br><span class="line">  dirty_card_queue_set().initialize(DirtyCardQ_CBL_mon,</span><br><span class="line">                                    DirtyCardQ_FL_lock,</span><br><span class="line">                                    <span class="number">-1</span>, <span class="comment">// never trigger processing</span></span><br><span class="line">                                    <span class="number">-1</span>, <span class="comment">// no limit on length</span></span><br><span class="line">                                    Shared_DirtyCardQ_lock,</span><br><span class="line">                                    &amp;G1BarrierSet::dirty_card_queue_set());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Here we allocate the dummy HeapRegion that is required by the</span></span><br><span class="line">  <span class="comment">// G1AllocRegion class.</span></span><br><span class="line">  HeapRegion* dummy_region = _hrm.get_dummy_region();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We'll re-use the same region whether the alloc region will</span></span><br><span class="line">  <span class="comment">// require BOT updates or not and, if it doesn't, then a non-young</span></span><br><span class="line">  <span class="comment">// region will complain that it cannot support allocations without</span></span><br><span class="line">  <span class="comment">// BOT updates. So we'll tag the dummy region as eden to avoid that.</span></span><br><span class="line">  dummy_region-&gt;set_eden();</span><br><span class="line">  <span class="comment">// Make sure it's full.</span></span><br><span class="line">  dummy_region-&gt;set_top(dummy_region-&gt;end());</span><br><span class="line">  G1AllocRegion::setup(<span class="keyword">this</span>, dummy_region);</span><br><span class="line"></span><br><span class="line">  _allocator-&gt;init_mutator_alloc_region();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do create of the monitoring and management support so that</span></span><br><span class="line">  <span class="comment">// values in the heap have been properly initialized.</span></span><br><span class="line">  _g1mm = <span class="keyword">new</span> G1MonitoringSupport(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  G1StringDedup::initialize();</span><br><span class="line"></span><br><span class="line">  _preserved_marks_set.init(ParallelGCThreads);</span><br><span class="line"></span><br><span class="line">  _collection_set.initialize(max_regions());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>reserve_heap</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件： /src/hotspot/share/memory/universe.cpp</span></span><br><span class="line"></span><br><span class="line">ReservedSpace Universe::reserve_heap(<span class="keyword">size_t</span> heap_size, <span class="keyword">size_t</span> alignment) &#123;</span><br><span class="line"></span><br><span class="line">  assert(alignment &lt;= Arguments::conservative_max_heap_alignment(),</span><br><span class="line">         <span class="string">"actual alignment "</span> SIZE_FORMAT <span class="string">" must be within maximum heap alignment "</span> SIZE_FORMAT,</span><br><span class="line">         alignment, Arguments::conservative_max_heap_alignment());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> total_reserved = align_up(heap_size, alignment);</span><br><span class="line">  assert(!UseCompressedOops || (total_reserved &lt;= (OopEncodingHeapMax - os::vm_page_size())),</span><br><span class="line">      <span class="string">"heap size is too big for compressed oops"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> use_large_pages = UseLargePages &amp;&amp; is_aligned(alignment, os::large_page_size());</span><br><span class="line">  assert(!UseLargePages</span><br><span class="line">      || UseParallelGC</span><br><span class="line">      || use_large_pages, <span class="string">"Wrong alignment to use large pages"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now create the space.</span></span><br><span class="line">  <span class="function">ReservedHeapSpace <span class="title">total_rs</span><span class="params">(total_reserved, alignment, use_large_pages, AllocateHeapAt)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (total_rs.is_reserved()) &#123;</span><br><span class="line">    assert((total_reserved == total_rs.size()) &amp;&amp; ((<span class="keyword">uintptr_t</span>)total_rs.base() % alignment == <span class="number">0</span>),</span><br><span class="line">           <span class="string">"must be exactly of required size and alignment"</span>);</span><br><span class="line">    <span class="comment">// We are good.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (UseCompressedOops) &#123;</span><br><span class="line">      <span class="comment">// Universe::initialize_heap() will reset this to NULL if unscaled</span></span><br><span class="line">      <span class="comment">// or zero-based narrow oops are actually used.</span></span><br><span class="line">      <span class="comment">// Else heap start and base MUST differ, so that NULL can be encoded nonambigous.</span></span><br><span class="line">      Universe::set_narrow_oop_base((address)total_rs.compressed_oop_base());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (AllocateHeapAt != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      log_info(gc,heap)(<span class="string">"Successfully allocated Java heap at location %s"</span>, AllocateHeapAt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total_rs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm_exit_during_initialization(</span><br><span class="line">    err_msg(<span class="string">"Could not reserve enough space for "</span> SIZE_FORMAT <span class="string">"KB object heap"</span>,</span><br><span class="line">            total_reserved/K));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// satisfy compiler</span></span><br><span class="line">  ShouldNotReachHere();</span><br><span class="line">  <span class="keyword">return</span> ReservedHeapSpace(<span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JVMInit 初始化虚拟机</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line"><span class="comment">// MacOSX we may continue in the same thread</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">JVMInit(InvocationFunctions* ifn, jlong threadStackSize,</span><br><span class="line">                 <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv,</span><br><span class="line">                 <span class="keyword">int</span> mode, <span class="keyword">char</span> *what, <span class="keyword">int</span> ret) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sameThread) &#123;</span><br><span class="line">        JLI_TraceLauncher(<span class="string">"In same thread\n"</span>);</span><br><span class="line">        <span class="comment">// need to block this thread against the main thread</span></span><br><span class="line">        <span class="comment">// so signals get caught correctly</span></span><br><span class="line">        __block <span class="keyword">int</span> rslt = <span class="number">0</span>;</span><br><span class="line">        NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span><br><span class="line">        &#123;</span><br><span class="line">            NSBlockOperation *op = [NSBlockOperation blockOperationWithBlock: ^&#123;</span><br><span class="line">                JavaMainArgs args;</span><br><span class="line">                args.argc = argc;</span><br><span class="line">                args.argv = argv;</span><br><span class="line">                args.mode = mode;</span><br><span class="line">                args.what = what;</span><br><span class="line">                args.ifn  = *ifn;</span><br><span class="line">                rslt = JavaMain(&amp;args);</span><br><span class="line">            &#125;];</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * We cannot use dispatch_sync here, because it blocks the main dispatch queue.</span></span><br><span class="line"><span class="comment">             * Using the main NSRunLoop allows the dispatch queue to run properly once</span></span><br><span class="line"><span class="comment">             * SWT (or whatever toolkit this is needed for) kicks off it's own NSRunLoop</span></span><br><span class="line"><span class="comment">             * and starts running.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            [op performSelectorOnMainThread:@selector(start) withObject:nil waitUntilDone:YES];</span><br><span class="line">        &#125;</span><br><span class="line">        [pool drain];</span><br><span class="line">        <span class="keyword">return</span> rslt;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 会走这个分支</span></span><br><span class="line">        <span class="keyword">return</span> ContinueInNewThread(ifn, threadStackSize, argc, argv, mode, what, ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ContinueInNewThread</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件：/src/java.base/share/native/libjli/java.c</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">ContinueInNewThread(InvocationFunctions* ifn, jlong threadStackSize,</span><br><span class="line">                    <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv,</span><br><span class="line">                    <span class="keyword">int</span> mode, <span class="keyword">char</span> *what, <span class="keyword">int</span> ret)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If user doesn't specify stack size, check if VM has a preference.</span></span><br><span class="line"><span class="comment">     * Note that HotSpot no longer supports JNI_VERSION_1_1 but it will</span></span><br><span class="line"><span class="comment">     * return its default stack size through the init args structure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (threadStackSize == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">JDK1_1InitArgs</span> <span class="title">args1_1</span>;</span></span><br><span class="line">      <span class="built_in">memset</span>((<span class="keyword">void</span>*)&amp;args1_1, <span class="number">0</span>, <span class="keyword">sizeof</span>(args1_1));</span><br><span class="line">      args1_1.version = JNI_VERSION_1_1;</span><br><span class="line">      ifn-&gt;GetDefaultJavaVMInitArgs(&amp;args1_1);  <span class="comment">/* ignore return value */</span></span><br><span class="line">      <span class="keyword">if</span> (args1_1.javaStackSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         threadStackSize = args1_1.javaStackSize;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">/* Create a new thread to create JVM and invoke main method */</span></span><br><span class="line">      JavaMainArgs args;</span><br><span class="line">      <span class="keyword">int</span> rslt;</span><br><span class="line"></span><br><span class="line">      args.argc = argc;</span><br><span class="line">      args.argv = argv;</span><br><span class="line">      args.mode = mode;</span><br><span class="line">      args.what = what;</span><br><span class="line">      args.ifn = *ifn;</span><br><span class="line"></span><br><span class="line">      rslt = ContinueInNewThread0(JavaMain, threadStackSize, (<span class="keyword">void</span>*)&amp;args);</span><br><span class="line">      <span class="comment">/* If the caller has deemed there is an error we</span></span><br><span class="line"><span class="comment">       * simply return that, otherwise we return the value of</span></span><br><span class="line"><span class="comment">       * the callee</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">return</span> (ret != <span class="number">0</span>) ? ret : rslt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ContinueInNewThread0 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：/src/java.base/macosx/native/libjli/java_md_macosx.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Block current thread and continue execution in a new thread</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">ContinueInNewThread0(<span class="keyword">int</span> (JNICALL *continuation)(<span class="keyword">void</span> *), jlong stack_size, <span class="keyword">void</span> * args) &#123;</span><br><span class="line">    <span class="keyword">int</span> rslt;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_JOINABLE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stack_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      pthread_attr_setstacksize(&amp;attr, stack_size);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_attr_setguardsize(&amp;attr, <span class="number">0</span>); <span class="comment">// no pthread guard page on java threads</span></span><br><span class="line"></span><br><span class="line">	  <span class="comment">// 另开一个线程去执行java代码；PS：这里是执行java.c 中的 JavaMain方法</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;tid, &amp;attr, (<span class="keyword">void</span> *(*)(<span class="keyword">void</span>*))continuation, (<span class="keyword">void</span>*)args) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">void</span> * tmp;</span><br><span class="line">      pthread_join(tid, &amp;tmp);</span><br><span class="line">      rslt = (<span class="keyword">int</span>)(<span class="keyword">intptr_t</span>)tmp;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * Continue execution in current thread if for some reason (e.g. out of</span></span><br><span class="line"><span class="comment">      * memory/LWP)  a new thread can't be created. This will likely fail</span></span><br><span class="line"><span class="comment">      * later in continuation as JNI_CreateJavaVM needs to create quite a</span></span><br><span class="line"><span class="comment">      * few new threads, anyway, just give it a try..</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      rslt = continuation(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    <span class="keyword">return</span> rslt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>pthread_create</p>
<blockquote>
<p>int pthread_create(pthread_t <em>tidp, const pthread_attr_t *attr, (void</em>)(<em>start_rtn)(void</em>), void *arg);</p>
<p>返回值:</p>
<pre><code>若线程创建成功，则返回0。若线程创建失败，则返回出错编号，并且*thread中的内容是未定义的。</code></pre><p>参数:</p>
<pre><code>第一个参数为指向线程标识符的指针。
第二个参数用来设置线程属性。
第三个参数是线程运行函数的起始地址。
最后一个参数是运行函数的参数。</code></pre><p>注意事项<br>因为pthread并非Linux系统的默认库，而是POSIX线程库。在Linux中将其作为一个库来使用，因此加上 -lpthread（或-pthread）以显式链接该库。函数在执行错误时的错误信息将作为返回值返回，并不修改系统全局变量errno，当然也无法使用perror()打印错误信息。</p>
</blockquote>
</li>
</ul>
<ul>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pid = getpid();</span><br><span class="line">    tid = pthread_self();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s pid %u tid %u (0x%x)\n"</span>, s, (<span class="keyword">unsigned</span> <span class="keyword">int</span>) pid,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">int</span>) tid, (<span class="keyword">unsigned</span> <span class="keyword">int</span>) tid);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printids(<span class="string">"new thread: "</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">pthread_t</span> ntid;</span><br><span class="line">    err = pthread_create(&amp;ntid, <span class="literal">NULL</span>, thr_fn, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread: %s\n"</span>, strerror(err));</span><br><span class="line">    printids(<span class="string">"main thread:"</span>);</span><br><span class="line">    pthread_join(ntid,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>1</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件： /src/java.base/share/native/libjli/java.c</span></span><br><span class="line"><span class="keyword">int</span> JNICALL</span><br><span class="line">JavaMain(<span class="keyword">void</span> * _args)</span><br><span class="line">&#123;</span><br><span class="line">    JavaMainArgs *args = (JavaMainArgs *)_args;</span><br><span class="line">    <span class="keyword">int</span> argc = args-&gt;argc;</span><br><span class="line">    <span class="keyword">char</span> **argv = args-&gt;argv;</span><br><span class="line">    <span class="keyword">int</span> mode = args-&gt;mode;</span><br><span class="line">    <span class="keyword">char</span> *what = args-&gt;what;</span><br><span class="line">    InvocationFunctions ifn = args-&gt;ifn;</span><br><span class="line"></span><br><span class="line">    JavaVM *vm = <span class="number">0</span>;</span><br><span class="line">    JNIEnv *env = <span class="number">0</span>;</span><br><span class="line">    jclass mainClass = <span class="literal">NULL</span>;</span><br><span class="line">    jclass appClass = <span class="literal">NULL</span>; <span class="comment">// actual application class being launched</span></span><br><span class="line">    jmethodID mainID;</span><br><span class="line">    jobjectArray mainArgs;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    jlong start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    RegisterThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the virtual machine */</span></span><br><span class="line">    start = CounterGet();</span><br><span class="line">    <span class="keyword">if</span> (!InitializeJVM(&amp;vm, &amp;env, &amp;ifn)) &#123;</span><br><span class="line">        JLI_ReportErrorMessage(JVM_ERROR1);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (showSettings != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ShowSettings(env, showSettings);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show resolved modules and continue</span></span><br><span class="line">    <span class="keyword">if</span> (showResolvedModules) &#123;</span><br><span class="line">        ShowResolvedModules(env);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// list observable modules, then exit</span></span><br><span class="line">    <span class="keyword">if</span> (listModules) &#123;</span><br><span class="line">        ListModules(env);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line">        LEAVE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// describe a module, then exit</span></span><br><span class="line">    <span class="keyword">if</span> (describeModule != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        DescribeModule(env, describeModule);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line">        LEAVE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (printVersion || showVersion) &#123;</span><br><span class="line">        PrintJavaVersion(env, showVersion);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (printVersion) &#123;</span><br><span class="line">            LEAVE();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// modules have been validated at startup so exit</span></span><br><span class="line">    <span class="keyword">if</span> (validateModules) &#123;</span><br><span class="line">        LEAVE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the user specified neither a class name nor a JAR file */</span></span><br><span class="line">    <span class="keyword">if</span> (printXUsage || printUsage || what == <span class="number">0</span> || mode == LM_UNKNOWN) &#123;</span><br><span class="line">        PrintUsage(env, printXUsage);</span><br><span class="line">        CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line">        LEAVE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FreeKnownVMs(); <span class="comment">/* after last possible PrintUsage */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JLI_IsTraceLauncher()) &#123;</span><br><span class="line">        end = CounterGet();</span><br><span class="line">        JLI_TraceLauncher(<span class="string">"%ld micro seconds to InitializeJVM\n"</span>,</span><br><span class="line">               (<span class="keyword">long</span>)(jint)Counter2Micros(end-start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* At this stage, argc/argv have the application's arguments */</span></span><br><span class="line">    <span class="keyword">if</span> (JLI_IsTraceLauncher())&#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s is '%s'\n"</span>, launchModeNames[mode], what);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"App's argc is %d\n"</span>, argc);</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"    argv[%2d] = '%s'\n"</span>, i, argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Get the application's main class. It also checks if the main</span></span><br><span class="line"><span class="comment">     * method exists.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * See bugid 5030265.  The Main-Class name has already been parsed</span></span><br><span class="line"><span class="comment">     * from the manifest, but not parsed properly for UTF-8 support.</span></span><br><span class="line"><span class="comment">     * Hence the code here ignores the value previously extracted and</span></span><br><span class="line"><span class="comment">     * uses the pre-existing code to reextract the value.  This is</span></span><br><span class="line"><span class="comment">     * possibly an end of release cycle expedient.  However, it has</span></span><br><span class="line"><span class="comment">     * also been discovered that passing some character sets through</span></span><br><span class="line"><span class="comment">     * the environment has "strange" behavior on some variants of</span></span><br><span class="line"><span class="comment">     * Windows.  Hence, maybe the manifest parsing code local to the</span></span><br><span class="line"><span class="comment">     * launcher should never be enhanced.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Hence, future work should either:</span></span><br><span class="line"><span class="comment">     *     1)   Correct the local parsing code and verify that the</span></span><br><span class="line"><span class="comment">     *          Main-Class attribute gets properly passed through</span></span><br><span class="line"><span class="comment">     *          all environments,</span></span><br><span class="line"><span class="comment">     *     2)   Remove the vestages of maintaining main_class through</span></span><br><span class="line"><span class="comment">     *          the environment (and remove these comments).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method also correctly handles launching existing JavaFX</span></span><br><span class="line"><span class="comment">     * applications that may or may not have a Main-Class manifest entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mainClass = LoadMainClass(env, mode, what);</span><br><span class="line">    CHECK_EXCEPTION_NULL_LEAVE(mainClass);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * In some cases when launching an application that needs a helper, e.g., a</span></span><br><span class="line"><span class="comment">     * JavaFX application with no main method, the mainClass will not be the</span></span><br><span class="line"><span class="comment">     * applications own main class but rather a helper class. To keep things</span></span><br><span class="line"><span class="comment">     * consistent in the UI we need to track and report the application main class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    appClass = GetApplicationClass(env);</span><br><span class="line">    NULL_CHECK_RETURN_VALUE(appClass, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Build platform specific argument array */</span></span><br><span class="line">    mainArgs = CreateApplicationArgs(env, argv, argc);</span><br><span class="line">    CHECK_EXCEPTION_NULL_LEAVE(mainArgs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dryRun) &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">        LEAVE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * PostJVMInit uses the class name as the application name for GUI purposes,</span></span><br><span class="line"><span class="comment">     * for example, on OSX this sets the application name in the menu bar for</span></span><br><span class="line"><span class="comment">     * both SWT and JavaFX. So we'll pass the actual application class here</span></span><br><span class="line"><span class="comment">     * instead of mainClass as that may be a launcher or helper class instead</span></span><br><span class="line"><span class="comment">     * of the application class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PostJVMInit(env, appClass, vm);</span><br><span class="line">    CHECK_EXCEPTION_LEAVE(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The LoadMainClass not only loads the main class, it will also ensure</span></span><br><span class="line"><span class="comment">     * that the main method's signature is correct, therefore further checking</span></span><br><span class="line"><span class="comment">     * is not required. The main method is invoked here so that extraneous java</span></span><br><span class="line"><span class="comment">     * stacks are not in the application stack trace.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, <span class="string">"main"</span>,</span><br><span class="line">                                       <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">    CHECK_EXCEPTION_NULL_LEAVE(mainID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Invoke main method. */</span></span><br><span class="line">    (*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The launcher's exit code (in the absence of calls to</span></span><br><span class="line"><span class="comment">     * System.exit) will be non-zero if main threw an exception.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ret = (*env)-&gt;ExceptionOccurred(env) == <span class="literal">NULL</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    LEAVE();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>虚拟机的启动</p>
<blockquote>
<p>HotSpot VM 启动时JNI_CreateJavaVM方法将执行以下一系列操作。<br>（1）确保只有一个线程调用这个方法并且确保只创建一个HotSpot VM实例。因为HotSpot VM创建的静态数据结构无法再次初始化，所以一旦初始化到达某个确定点后，进程空间里就只能有一个HotSpot VM，在HotSpot VM的开发工程师看来，HotSpot VM启动至此已经是无法逆转了。<br>（2）检查并确保支持当前的JNI版本，初始化垃圾收集日志的输出流。<br>（3）初始化OS模块，如随机数生成器（Random Number Generator）、当前进程id（Current Process id）、高精度计时器（High-Resolution Timer）、内存页尺寸（Memory Page Sizes）、保护页（Guard Pages）。保护页是不可访问的内存页，用作内存访问区域的边界。例如，操作系统常在线程栈顶压入一个保护页以保证引用不会超出栈的边界。<br>（4）解析传入JNI_CreateJavaVM的命令行选项，保存以备将来使用。<br>（5）初始化标准的Java系统属性，例如java.version、java.vendor、os.name等。<br>（6）初始化支持同步、栈、内存和安全点页的模块。<br>（7）加载libzip、libhpi、libjava及libthread等库。<br>（8）初始化并设置信号处理器（Signal Handler）。<br>（9）初始化线程库。<br>（10）初始化输出流日志记录器（Logger）。<br>（11）如果用到Agent库（hprof、jdi），则初始化并启动。<br>（12）初始化线程状态（Thread State）和线程本地存储（Thread Local Storage），它们存储了线程私有数据。<br>（13）初始化部分HotSpot VM全局数据，例如事件日志（Event Log），OS同步原语、perfMemory（性能统计数据内存），以及chunkPool（内存分配器）。<br>（14）至此，HotSpot VM可以创建线程了。创建出来的Java版main线程被关联到当前操作系统线程，只不过还没有添加到已知线程列表中。<br>（15）初始化并激活Java级别的同步。<br>（16）初始化启动类加载器（Bootclassloader）、代码缓存、解释器、JIT编译器、JNI、系统词典（System Dictionary）及universe（一种必备的全局数据结构集）。<br>（17）现在，添加Java主线程到已知线程列表中。检查universe是否正常。创建HotSpot VMThread，它执行HotSpot VM所有的关键功能。同事发出适当的JVMTI事件，报告HotSpot VM当前的状态。<br>（18）加载和初始化以下Java类：java.lang.String、java.lang.System、java.lang.Thread、java.lang.ThreadGroup、java.lang.reflect.Method、java.lang.ref.Finalizer、java.lang.Class以及余下的Java系统类。此时，HotSpot已经初始化完毕并可使用，只是功能还不完备。<br>（19）启动HotSpot VM的信号处理器线程，初始化JIT编译器并启动HotSpot编译代理线程。启动HotSpot VM辅助线程（如监控线程和统计抽样器）。至此，HotSpot VM已功能完备。<br>（20）最后，生成JNIEnv对象返回给调用者，HotSpot则准备响应新的JNI请求。<br>如果HotSpot VM启动过程中发生错误，启动器则调用DestroyJavaVM方法关闭HotSpot VM。如果HotSpot VM启动后执行过程中发生很严重的错误，也会调用DestroyJavaVM方法。</p>
<p>DestroyJavaVM按以下步骤停止HotSpot VM。<br>（1）一直等待，直到只有一个非守护的线程执行，注意此时HotSpot VM仍然可用。<br>（2）调用java.lang.Shutdown.shutdown()，它会调用Java上的shutdown钩子方法，如果finalization-on-exit为true，则运行Java对象的finalizer。<br>（3）运行HotSpot VM上的shutdown钩子（通过JVM_OnExit()注册），停止以下线程：性能分线器、统计数据抽样器、监控线程及垃圾收集器线程。发出状态事件通知JVMTI，然后关闭JVMTI、停止信号线程。<br>（4）调用HotSpot的JavaThread::exit()释放JNI处理块，移除保护页，并将当前线程从已知线程队列中移除。从这时起，HotSpot VM就无法执行任何Java代码了。<br>（5）停止HotSpot VM线程，将遗留的HotSpot VM线程带到安全点并停止JIT编译器线程。<br>（6）停止追踪JNI，HotSpot VM及JVMTI屏障。<br>（7）为哪些仍然以本地代码运行的线程设置标记“vm exited”。<br>（8）删除当前线程。<br>（9）删除或移除所有的输入/输出流，释放PerfMemory（性能统计内存）资源。<br>（10）最后返回到调用者。</p>
</blockquote>
<h5 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h5><ul>
<li><a href="https://hunterzhao.io/post/2018/02/23/hotspot-explore-startup-process-initialization/" target="_blank" rel="noopener">https://hunterzhao.io/post/2018/02/23/hotspot-explore-startup-process-initialization/</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/03/Android 打包流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/03/Android 打包流程/" itemprop="url">Android 打包流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-03T15:34:01+08:00">
                2020-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Android-打包流程"><a href="#Android-打包流程" class="headerlink" title="Android 打包流程"></a>Android 打包流程</h5><ul>
<li><p>打包资源文件，生成R.java文件</p>
<blockquote>
<p>使用工具：<code>aapt（The Android Asset Packaing Tool）</code>，目录 <code>sdk\build-tools\25.0.0\aapt</code>。</p>
<p>1、填充xml文件中的引用，并编译为二进制文件；同时生成R.java、resource.arse文件；</p>
<p>2、R文件保存资源名称到ResourceID的映射关系。</p>
<p>3、resource.arse文件为ResourceID、资源名称、资源路径的映射关系。</p>
<p>4、压缩图片</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>处理AIDL文件，生成Java文件</p>
<blockquote>
<p>使用工具是：<code>aidl（Android Interface Definition Language）</code>，即Android接口描述语言，目录 <code>sdk\build-tools\25.0.0\aidl</code>。</p>
<p>aidl工具解析接口定义文件然后<code>生成相应的Java代码接口</code>供程序调用。如果在项目没有使用到aidl文件，则可以跳过这一步。</p>
</blockquote>
</li>
<li><p>编译源码，生成class文件</p>
<blockquote>
<p>使用工具是: <code>Java编译器（javac）</code></p>
<p>项目中所有的<code>Java代码，包括R.java和.aidl文件</code>，都会变Java编译器（javac）编译成<code>.class文件</code>，生成的class文件位于工程中的app/build/intermediates/javac/release/compileReleaseJavaWithJavac目录下。</p>
</blockquote>
</li>
<li><p>根据class文件生成Dex文件</p>
<blockquote>
<p>使用工具是： <code>dx（dex）</code>，工具目录<code>（sdk\build-tools\25.0.0\dx）</code>。</p>
<p>1、将所有的class文件(自己的源码、引用的第三方Jar、aar等) 转换为可供Android系统Dalvik虚拟机执行的<code>classes.dex</code>文件；</p>
<p>2、优点是：dx工具的主要工作是将<code>Java字节码</code>转成 <code>Dalvik字节码</code>、压缩常量池、消除冗余信息等。</p>
</blockquote>
</li>
<li><p>打包生成APK文件</p>
<blockquote>
<p>使用工具是：<code>apkbuilder</code>，目录 <code>android-sdk/tools</code>，apkbuilder为一个脚本文件，实际调用的是（sdk\tools\lib）文件中的com.android.sdklib.build.ApkbuilderMain类。</p>
<p>1、所有没有编译的资源，如images、assets目录下资源</p>
<p>2、编译过的资源，如dex、res、resource.arse、AndroidManifest.xml文件都会被apkbuilder工具打包到最终的.apk文件中。</p>
</blockquote>
</li>
<li><p>对APK文件进行签名</p>
<blockquote>
<p>使用工具是<code>Jarsigner</code>, 对上一步生成的APK进行签名。PS：必须被签名才能被安装在设备上。</p>
<p>1、主要是两种签名的keystore，一种是用于调试的debug.keystore，它主要用于调试。另一种就是用于发布正式版本的<code>relese.keystore</code>，需要开发者自己配置。</p>
<p>2、另外还有一种签名文件release.jks文件。</p>
<p>3、jks文件和keystore文件的区别是，前者是Android Studio打包使用的，而后者是Eclipse打包用的。</p>
<p>4、证书生成工具keytool，例如：keytool -list -v -keystore debug.keystore</p>
</blockquote>
</li>
<li><p>对签名后的文件进行对齐处理</p>
<blockquote>
<p>使用工具是:<code>zipalign</code>，目录 <code>sdk\build-tools\25.0.0\zipalign</code>。</p>
<p>1、对齐的主要过程是将APK包中所有的资源文件距离文件起始偏移为4字节整数倍，这样通过内存映射访问apk文件时的速度会更快。对齐的作用就是减少运行时内存的使用。</p>
</blockquote>
</li>
</ul>
<h5 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h5><ul>
<li><a href="https://juejin.im/entry/58b78d1b61ff4b006cd47e5b" target="_blank" rel="noopener">https://juejin.im/entry/58b78d1b61ff4b006cd47e5b</a></li>
<li><a href="https://juejin.im/post/5cd0046fe51d453aa5635f98" target="_blank" rel="noopener">https://juejin.im/post/5cd0046fe51d453aa5635f98</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/03/数据加密算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/03/数据加密算法/" itemprop="url">数据加密算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-03T14:29:26+08:00">
                2020-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/加密/" itemprop="url" rel="index">
                    <span itemprop="name">加密</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="加密、解密的定义"><a href="#加密、解密的定义" class="headerlink" title="加密、解密的定义"></a>加密、解密的定义</h5><ul>
<li><p>加密 </p>
<blockquote>
<p>就是对原来为 <strong>明文</strong> 的文件或数据按 <strong>某种算法</strong> 进行处理，使其成为 <strong>不可读</strong> 的一段代码，通常称为 <strong>“密文”</strong>。通过这样的途径，来达到 <strong>保护数据</strong> 不被 <strong>非法人窃取</strong>、阅读的目的。</p>
</blockquote>
</li>
<li><p>解密</p>
<blockquote>
<p>加密 的 <strong>逆过程</strong> 为 <strong>解密</strong>，即将该 <strong>编码信息</strong> 转化为其 <strong>原来数据</strong> 的过程。</p>
</blockquote>
</li>
</ul>
<h5 id="对称加密和非对称加密"><a href="#对称加密和非对称加密" class="headerlink" title="对称加密和非对称加密"></a>对称加密和非对称加密</h5><ul>
<li><p>对称加密</p>
<blockquote>
<p><strong>对称加密算法</strong> 是应用较早的加密算法，又称为 <strong>共享密钥加密算法</strong>。在 <strong>对称加密算法</strong> 中，使用的密钥只有一个，<strong>发送</strong> 和 <strong>接收</strong> 双方都使用这个密钥对数据进行 <strong>加密</strong> 和 <strong>解密</strong>。这就要求加密和解密方事先都必须知道加密的密钥。</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>非对称加密</p>
<blockquote>
<p><strong>非对称加密算法</strong>，又称为 <strong>公开密钥加密算法</strong>。它需要两个密钥，一个称为 <strong>公开密钥</strong> (<code>public key</code>)，即 <strong>公钥</strong>，另一个称为 <strong>私有密钥</strong> (<code>private key</code>)，即 <strong>私钥</strong>。</p>
</blockquote>
</li>
</ul>
<h5 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h5><ul>
<li><p>MD5算法</p>
<blockquote>
<p><code>MD5</code> 用的是 <strong>哈希函数</strong>，它的典型应用是对一段信息产生 <strong>信息摘要</strong>，以 <strong>防止被篡改</strong>。严格来说，<code>MD5</code> 不是一种 <strong>加密算法</strong> 而是 <strong>摘要算法</strong>。无论是多长的输入，<code>MD5</code> 都会输出长度为 <code>128bits</code> 的一个串 (通常用 <code>16</code> <strong>进制</strong> 表示为 <code>32</code> 个字符)。</p>
</blockquote>
</li>
<li><p>SHA1、SHA-256算法</p>
<blockquote>
<p><code>SHA1</code> 是和 <code>MD5</code> 一样流行的 <strong>消息摘要算法</strong>，然而 <code>SHA1</code> 比 <code>MD5</code> 的 <strong>安全性更强</strong>。对于长度小于 <code>2 ^ 64</code> 位的消息，<code>SHA1</code> 会产生一个 <code>160</code> 位的 <strong>消息摘要</strong>。基于 <code>MD5</code>、<code>SHA1</code> 的信息摘要特性以及 <strong>不可逆</strong> (一般而言)，可以被应用在检查 <strong>文件完整性</strong> 以及 <strong>数字签名</strong> 等场景。</p>
<p>SHA2或者SHA-256有256 位，更加安全，但也更加耗时。</p>
<p>另外还有SHA-224、SHA-384、SHA-512等；</p>
<p><a href="https://zh.wikipedia.org/wiki/SHA家族" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/SHA%E5%AE%B6%E6%97%8F</a></p>
</blockquote>
</li>
<li><p>HMAC 、MAC算法</p>
<blockquote>
<p><code>HMAC</code> 是密钥相关的 <strong>哈希运算消息认证码</strong>（Hash-based Message Authentication Code），<code>HMAC</code> 运算利用 <strong>哈希算法</strong> (<code>MD5</code>、<code>SHA1</code> 等)，以 <strong>一个密钥</strong> 和 <strong>一个消息</strong> 为输入，生成一个 <strong>消息摘要</strong> 作为 <strong>输出</strong>。</p>
</blockquote>
</li>
<li></li>
</ul>
<h5 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h5><ul>
<li><p>DES算法</p>
<blockquote>
<p><code>DES</code> 加密算法是一种 <strong>分组密码</strong>，以 <code>64</code> 位为 <strong>分组对数据</strong> 加密，它的 <strong>密钥长度</strong> 是 <code>56</code> 位，<strong>加密解密</strong> 用 <strong>同一算法</strong>。</p>
<p><code>DES</code> 加密算法是对 <strong>密钥</strong> 进行保密，而 <strong>公开算法</strong>，包括加密和解密算法。这样，只有掌握了和发送方 <strong>相同密钥</strong> 的人才能解读由 <code>DES</code>加密算法加密的密文数据。因此，破译 <code>DES</code> 加密算法实际上就是 <strong>搜索密钥的编码</strong>。对于 <code>56</code> 位长度的 <strong>密钥</strong> 来说，如果用 <strong>穷举法</strong> 来进行搜索的话，其运算次数为 <code>2 ^ 56</code> 次。</p>
</blockquote>
</li>
<li><p>3DES 算法</p>
<blockquote>
<p>是基于 <code>DES</code> 的 <strong>对称算法</strong>，对 <strong>一块数据</strong> 用 <strong>三个不同的密钥</strong> 进行 <strong>三次加密</strong>，<strong>强度更高</strong>。</p>
</blockquote>
</li>
<li><p>AES 算法</p>
<blockquote>
<p><code>AES</code> 加密算法是密码学中的 <strong>高级加密标准</strong>，该加密算法采用 <strong>对称分组密码体制</strong>，密钥长度的最少支持为 <code>128</code> 位、 <code>192</code> 位、<code>256</code> 位，分组长度 <code>128</code> 位，算法应易于各种硬件和软件实现。这种加密算法是美国联邦政府采用的 <strong>区块加密标准</strong>。</p>
<p><code>AES</code> 本身就是为了取代 <code>DES</code> 的，<code>AES</code> 具有更好的 <strong>安全性</strong>、<strong>效率</strong> 和 <strong>灵活性</strong>。</p>
</blockquote>
</li>
</ul>
<h5 id="非对称加密算法"><a href="#非对称加密算法" class="headerlink" title="非对称加密算法"></a>非对称加密算法</h5><ul>
<li><p>RSA算法</p>
<blockquote>
<p><code>RSA</code> 加密算法是目前最有影响力的 <strong>公钥加密算法</strong>，并且被普遍认为是目前 <strong>最优秀的公钥方案</strong> 之一。<code>RSA</code> 是第一个能同时用于 <strong>加密</strong> 和 <strong>数字签名</strong> 的算法，它能够 <strong>抵抗</strong> 到目前为止已知的 <strong>所有密码攻击</strong>，已被 <code>ISO</code> 推荐为公钥数据加密标准。</p>
<p><code>RSA</code> <strong>加密算法</strong> 基于一个十分简单的数论事实：将两个大 <strong>素数</strong> 相乘十分容易，但想要对其乘积进行 <strong>因式分解</strong> 却极其困难，因此可以将 <strong>乘积</strong> 公开作为 <strong>加密密钥</strong>。</p>
</blockquote>
</li>
<li><p>ECC 算法</p>
<blockquote>
<p><code>ECC</code> 也是一种 <strong>非对称加密算法</strong>，主要优势是在某些情况下，它比其他的方法使用 <strong>更小的密钥</strong>，比如 <code>RSA</code> <strong>加密算法</strong>，提供 <strong>相当的或更高等级</strong> 的安全级别。不过一个缺点是 <strong>加密和解密操作</strong> 的实现比其他机制 <strong>时间长</strong> (相比 <code>RSA</code> 算法，该算法对 <code>CPU</code> 消耗严重)。</p>
</blockquote>
</li>
</ul>
<h5 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h5><ul>
<li><a href="https://juejin.im/post/5b48b0d7e51d4519962ea383" target="_blank" rel="noopener">https://juejin.im/post/5b48b0d7e51d4519962ea383</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/01/Java ClassLoader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/01/Java ClassLoader/" itemprop="url">Java ClassLoader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-01T17:46:13+08:00">
                2020-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Java-类是如何被加载的"><a href="#Java-类是如何被加载的" class="headerlink" title="Java 类是如何被加载的"></a>Java 类是如何被加载的</h5><ul>
<li><p>java虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的java类型，这就是虚拟机的类加载机制。</p>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/60328095" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60328095</a></p>
</blockquote>
</li>
<li></li>
</ul>
<h5 id="Java-双亲委派"><a href="#Java-双亲委派" class="headerlink" title="Java 双亲委派"></a>Java 双亲委派</h5><ul>
<li><p>如果一个类加载器收到了类加载的请求，它首先不会自己去加载这个类，而是把这个请求委派给父类加载器去完成，每一层的类加载器都是如此，这样所有的加载请求都会被传送到顶层的启动类加载器中，只有当父加载无法完成加载请求（它的搜索范围中没找到所需的类）时，子加载器才会尝试去加载类。</p>
<blockquote>
<p><a href="https://juejin.im/post/5b3cc84ee51d4519873f08da" target="_blank" rel="noopener">https://juejin.im/post/5b3cc84ee51d4519873f08da</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/60328095" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60328095</a></p>
</blockquote>
</li>
<li></li>
</ul>
<p>参考文章</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/60328095" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60328095</a></li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/06/01/Java虚拟机编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/06/01/Java虚拟机编译/" itemprop="url">Java 虚拟机编译(JDK编译)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-01T16:57:48+08:00">
                2020-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Java-OpenJDK11u"><a href="#Java-OpenJDK11u" class="headerlink" title="Java OpenJDK11u"></a>Java OpenJDK11u</h5><ul>
<li><p>源码下载</p>
<blockquote>
<p>源码下载地址：</p>
<p><a href="https://hg.openjdk.java.net/jdk-updates/jdk11u" target="_blank" rel="noopener">https://hg.openjdk.java.net/jdk-updates/jdk11u</a></p>
<p>源码编译介绍：</p>
<p><a href="https://zhuanlan.zhihu.com/p/101402297" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/101402297</a></p>
<p>参考文章：</p>
<p><a href="https://www.lixiang.red/articles/2020/01/17/1579266236278.html" target="_blank" rel="noopener">https://www.lixiang.red/articles/2020/01/17/1579266236278.html</a></p>
</blockquote>
</li>
<li><p>编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unzip xxx.zip</span><br><span class="line"><span class="meta">#</span> cd 进入jdk目录</span><br><span class="line">cd doc</span><br><span class="line"><span class="meta">#</span> 参考building.md 里面的步骤进行编译。</span><br><span class="line"><span class="meta">#</span>  安装指定版本的jdk, 参考 https://jdk.java.net/archive/</span><br><span class="line">bash configure</span><br><span class="line"><span class="meta">#</span> 构建</span><br><span class="line">make images</span><br><span class="line"><span class="meta">#</span> 运行 java -version 验证 </span><br><span class="line">./build/macosx-x86_64-normal-server-release/images/jdk/bin/java -version</span><br><span class="line"><span class="meta">#</span> 下载jtreg 测试框架 https://ci.adoptopenjdk.net/view/Dependencies/job/jtreg/</span><br><span class="line"><span class="meta">#</span> 测试虚拟机 </span><br><span class="line">make run-test-tier1</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载c、c++跨平台编辑器CLion</p>
<blockquote>
<p>CLion 下载地址：</p>
<p><a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">https://www.jetbrains.com/clion/</a></p>
<p>下载CLion编辑器介绍：</p>
<p><a href="https://blog.csdn.net/zwx19921215/article/details/83306119" target="_blank" rel="noopener">https://blog.csdn.net/zwx19921215/article/details/83306119</a></p>
<p>免费激活：证书失效了</p>
<p><a href="http://blog.jdk5.com/zh/jetbrains-activation-code/" target="_blank" rel="noopener">http://blog.jdk5.com/zh/jetbrains-activation-code/</a></p>
<p><a href="https://www.techgrow.cn/posts/c0477083.html" target="_blank" rel="noopener">https://www.techgrow.cn/posts/c0477083.html</a></p>
</blockquote>
</li>
<li><p>虚拟机相关研究文章</p>
<blockquote>
<p><a href="https://www.zhihu.com/people/wang-xian-sheng-78-39/posts?page=1" target="_blank" rel="noopener">https://www.zhihu.com/people/wang-xian-sheng-78-39/posts?page=1</a></p>
</blockquote>
</li>
<li><p>虚拟机目录含义</p>
<blockquote>
<p><a href="https://hllvm-group.iteye.com/group/topic/26998" target="_blank" rel="noopener">https://hllvm-group.iteye.com/group/topic/26998</a></p>
</blockquote>
</li>
</ul>
<h5 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h5><ul>
<li><p><code>dlopen</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dlopen函数：</span><br><span class="line">功能：打开一个动态链接库</span><br><span class="line">包含头文件：</span><br><span class="line">	#include &lt;dlfcn.h&gt;</span><br><span class="line">函数定义：</span><br><span class="line">	void * dlopen( const char * pathname, int mode );</span><br><span class="line">函数描述：</span><br><span class="line">　在dlopen()函数以指定模式打开指定的动态连接库文件，并返回一个句柄给调用进程。通过这个句柄来使用库中的函数和类。使用dlclose()来卸载打开的库。</span><br><span class="line">mode：分为这两种</span><br><span class="line">　　RTLD_LAZY 暂缓决定，等有需要时再解出符号</span><br><span class="line">　　RTLD_NOW 立即决定，返回前解除所有未决定的符号。</span><br><span class="line">　　RTLD_LOCAL</span><br><span class="line">　　RTLD_GLOBAL 允许导出符号</span><br><span class="line">　　RTLD_GROUP</span><br><span class="line">　　RTLD_WORLD</span><br><span class="line">返回值:</span><br><span class="line">　　打开错误返回NULL;成功，返回库引用;编译时候要加入 -ldl (指定dl库)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dlsym</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">函数定义：</span><br><span class="line">  void* dlsym(void* handle,const char* symbol)</span><br><span class="line">该函数在&lt;dlfcn.h&gt;文件中。handle是由dlopen打开动态链接库后返回的指针，symbol就是要求获取的函数的名称，函数  返回值是void*,指向函数的地址，供调用使用。</span><br></pre></td></tr></table></figure>
</li>
<li><p>例子</p>
<blockquote>
<p>参考：<a href="https://blog.csdn.net/kingkong1024/article/details/8474210" target="_blank" rel="noopener">https://blog.csdn.net/kingkong1024/article/details/8474210</a></p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/05/30/Xposed 相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/05/30/Xposed 相关/" itemprop="url">Xposed 简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-30T12:32:02+08:00">
                2020-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="xposed-相关介绍"><a href="#xposed-相关介绍" class="headerlink" title="xposed 相关介绍"></a>xposed 相关介绍</h5><ul>
<li><p><code>xposed框架</code> </p>
<blockquote>
<p>xposed框架需要刷入系统才可以使用。</p>
<p>其实它就是单独搞了一套 xposed 版的 zygote。这个 zygote 会替换系统原生的 zygote。所以，它需要由 XposedInstaller 在 root 之后放到 /system/bin 下。</p>
<p>可以在不修改APK文件的情况下修改程序的运行（修改系统），基于它可以制作出许多功能强大的模块，且在功能不冲突的情况下同时运作。这套框架需要设备解锁了<a href="https://zh.wikipedia.org/wiki/Bootloader" target="_blank" rel="noopener">Bootloader</a>方可安装使用<a href="https://zh.wikipedia.org/wiki/Xposed_(框架)#cite_note-1" target="_blank" rel="noopener">[1]</a>（<a href="https://zh.wikipedia.org/wiki/Root_(Android)" target="_blank" rel="noopener">root</a>为解锁Bootloader的充分不必要条件，而xposed安装仅需通过<a href="https://zh.wikipedia.org/wiki/TWRP" target="_blank" rel="noopener">TWRP</a>等第三方<a href="https://zh.wikipedia.org/w/index.php?title=Android_System_Recovery&action=edit&redlink=1" target="_blank" rel="noopener">Recovery</a><a href="https://zh.wikipedia.org/wiki/刷机" target="_blank" rel="noopener">卡刷</a>安装包而不需要设备拥有完整的root权限）。</p>
<p>参考：<a href="https://zh.wikipedia.org/wiki/Xposed_(框架)" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/Xposed_(%E6%A1%86%E6%9E%B6)</a></p>
<p>xposed 编译流程详细</p>
<p><a href="https://www.infoq.cn/article/android-in-depth-xposed" target="_blank" rel="noopener">https://www.infoq.cn/article/android-in-depth-xposed</a></p>
<p>xposed 源码</p>
<p><a href="https://github.com/rovo89/Xposed" target="_blank" rel="noopener">https://github.com/rovo89/Xposed</a></p>
</blockquote>
</li>
<li><p><code>Xposed Installer</code></p>
<blockquote>
<p>这是 Xposed 的插件管理和功能控制 APP，也就是说 Xposed 整体管控功能就是由这个 APP 来完成的，它包括启用 Xposed 插件功能，下载和启用指定插件 APP，还可以禁用 Xposed 插件功能等。注意，这个 app 要正常无误得运行必须能拿到 root 权限。</p>
<p>源码：</p>
<p><a href="https://github.com/rovo89/XposedInstaller" target="_blank" rel="noopener">https://github.com/rovo89/XposedInstaller</a> </p>
<p>作者关于xposed 博客：</p>
<p><a href="https://forum.xda-developers.com/showthread.php?t=3034811&amp;page=1" target="_blank" rel="noopener">https://forum.xda-developers.com/showthread.php?t=3034811&amp;page=1</a></p>
</blockquote>
</li>
<li><p><code>XposedBridge</code> </p>
<blockquote>
<p>这个项目也是 Xposed 框架，它属于 Xposed 框架的 Java 部分，编译出来是一个 XposedBridge.jar 包。</p>
<p>XposedBridge 源码：</p>
<p><a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="noopener">https://github.com/rovo89/XposedBridge</a></p>
</blockquote>
</li>
<li><p><code>XposedTools</code></p>
<blockquote>
<p>Xposed 和 XposedBridge 编译依赖于 Android 源码，而且还有一些定制化的东西。所以 XposedTools 就是用来帮助我们编译<em>Xposed</em>和<em>XposedBridge</em>的。</p>
</blockquote>
</li>
</ul>
<ul>
<li><p><code>虚拟Xposed框架</code></p>
<blockquote>
<p>Virtual Xposed framework 是一套在 <a href="https://zh.wikipedia.org/wiki/Android" target="_blank" rel="noopener">Android</a> 高权限模式下运行的框架服务。与Xposed不同，它不需要设备已解锁<a href="https://zh.wikipedia.org/wiki/Bootloader" target="_blank" rel="noopener">Bootloader</a>或者已<a href="https://zh.wikipedia.org/wiki/Root_(Android)" target="_blank" rel="noopener">root</a>，但是多数情况下需要修改<a href="https://zh.wikipedia.org/wiki/APK" target="_blank" rel="noopener">APK文件</a>来植入框架。其兼容性较差，且当框架本体未开源并商业化的情况时具有较大的危险性、可检测性及不稳定性。<a href="https://zh.wikipedia.org/wiki/Xposed_(框架)#cite_note-7" target="_blank" rel="noopener">[7]</a>其多数特性与Xposed基本相同。最早发布的虚拟Xposed框架为VirtualXposed。</p>
<p>中文说明文档：</p>
<p><a href="https://github.com/android-hacker/VirtualXposed/blob/vxp/CHINESE.md" target="_blank" rel="noopener">https://github.com/android-hacker/VirtualXposed/blob/vxp/CHINESE.md</a></p>
<p>源码地址：</p>
<p><a href="https://github.com/android-hacker/VirtualXposed" target="_blank" rel="noopener">https://github.com/android-hacker/VirtualXposed</a></p>
<p>使用说明</p>
<p><a href="https://sspai.com/post/44447" target="_blank" rel="noopener">https://sspai.com/post/44447</a></p>
</blockquote>
</li>
<li><p>Xpatch</p>
<blockquote>
<p>Xpatch是一款免Root实现App加载Xposed插件的工具，可以非常方便地实现App的逆向破解</p>
<p>参考：</p>
<p><a href="https://windysha.github.io/2019/07/27/免Root-实现App加载Xposed插件的工具Xpatch源码解析（一）/" target="_blank" rel="noopener">https://windysha.github.io/2019/07/27/%E5%85%8DRoot-%E5%AE%9E%E7%8E%B0App%E5%8A%A0%E8%BD%BDXposed%E6%8F%92%E4%BB%B6%E7%9A%84%E5%B7%A5%E5%85%B7Xpatch%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/</a></p>
<p>xpatch 源码</p>
<p><a href="https://github.com/WindySha/Xpatch" target="_blank" rel="noopener">https://github.com/WindySha/Xpatch</a></p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2020/05/29/dex 脱壳/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2020/05/29/dex 脱壳/" itemprop="url">dex 脱壳</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-29T15:59:01+08:00">
                2020-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="https://www.52pojie.cn/thread-977325-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-977325-1-1.html</a></li>
<li>fdex2</li>
<li><a href="https://www.cnblogs.com/cxchanpin/p/7374652.html" target="_blank" rel="noopener">https://www.cnblogs.com/cxchanpin/p/7374652.html</a></li>
<li><a href="http://www.droidsec.cn/从android运行时出发，打造我们的脱壳神器/" target="_blank" rel="noopener">http://www.droidsec.cn/%E4%BB%8Eandroid%E8%BF%90%E8%A1%8C%E6%97%B6%E5%87%BA%E5%8F%91%EF%BC%8C%E6%89%93%E9%80%A0%E6%88%91%E4%BB%AC%E7%9A%84%E8%84%B1%E5%A3%B3%E7%A5%9E%E5%99%A8/</a></li>
<li><a href="https://github.com/heartbee/Va_Fdex2" target="_blank" rel="noopener">https://github.com/heartbee/Va_Fdex2</a></li>
<li><a href="https://www.twblogs.net/a/5b8e6ec92b71771883452139" target="_blank" rel="noopener">https://www.twblogs.net/a/5b8e6ec92b71771883452139</a></li>
<li><a href="http://www.520monkey.com/archives/920" target="_blank" rel="noopener">http://www.520monkey.com/archives/920</a></li>
<li><a href="https://www.cnblogs.com/goodhacker/p/3961045.html" target="_blank" rel="noopener">https://www.cnblogs.com/goodhacker/p/3961045.html</a></li>
<li><a href="https://github.com/KB5201314/ZjDroid" target="_blank" rel="noopener">https://github.com/KB5201314/ZjDroid</a></li>
</ul>
<p>1.android-unpacker</p>
<p>2.Fdex2</p>
<p>3.drizzledumper</p>
<p>4.dexExtractor</p>
<p>5.zjdroid </p>
<p>6.dumpdex</p>
<p>7.android killer</p>
<p>8.IDA pro</p>
<p>9.showJava(安装app反编译)</p>
<p>dex 编辑器</p>
<p>010editor</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" href="/blog/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/blog/images/head.png" alt="lpl">
            
              <p class="site-author-name" itemprop="name">lpl</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zubao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.cnblogs.com/lipeil" target="_blank" title="博客园">
                      
                        <i class="fa fa-fw fa-博客园"></i>博客园</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lpl</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
