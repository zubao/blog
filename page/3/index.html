<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/blog/atom.xml" title="闲敲棋子落灯花" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="闲敲棋子落灯花">
<meta property="og:url" content="https://zubao.github.io/blog/page/3/index.html">
<meta property="og:site_name" content="闲敲棋子落灯花">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="闲敲棋子落灯花">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zubao.github.io/blog/page/3/">





  <title>闲敲棋子落灯花</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">闲敲棋子落灯花</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/25/Jar加固/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/25/Jar加固/" itemprop="url">Jar加固</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-25T17:12:41+08:00">
                2019-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##### </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/25/Android Q 线刷/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/25/Android Q 线刷/" itemprop="url">Android Q 线刷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-25T08:57:55+08:00">
                2019-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="android-Q-升级的两种方式："><a href="#android-Q-升级的两种方式：" class="headerlink" title="android Q 升级的两种方式："></a>android Q 升级的两种方式：</h4><h5 id="加入android测试版记录"><a href="#加入android测试版记录" class="headerlink" title="加入android测试版记录"></a>加入android测试版记录</h5><ul>
<li><p>官方网站：<a href="https://www.google.com/android/beta" target="_blank" rel="noopener">https://www.google.com/android/beta</a></p>
</li>
<li><p>1、优点是炒作简单</p>
</li>
<li><p>2、缺点是需要FQ，SS工具可能无法做到全局代理。如果在境外，或者有可以FQ的路由器应该没问题。</p>
</li>
</ul>
<h5 id="下载zip包，刷入手机"><a href="#下载zip包，刷入手机" class="headerlink" title="下载zip包，刷入手机"></a>下载zip包，刷入手机</h5><ul>
<li><p>官方网站： <a href="https://developers.google.com/android/images" target="_blank" rel="noopener">https://developers.google.com/android/images</a></p>
</li>
<li><p>下载对应手机的zip文件，解压到指定目录。</p>
</li>
<li><p>更新 platform-tools到最新版本</p>
</li>
<li><p>手机打开开发者模式，去开发者选项中启动允许OEM解锁。</p>
</li>
<li><p>刷机之前，千万记得退出账号。</p>
</li>
<li><p>adb reboot bootloader 进入到 bootloader模式；</p>
</li>
<li><p>fastboot flashing unlock 解锁手机</p>
<blockquote>
<p>以pixel 2xl 为例，如果bootloader version 低于 TMZ20a（例如8.0系统），需要执行 fastboot flashing unlock 、fastboot flashing unlock_critical 两条命令解锁。高于TMZ20a的则只需要 fastboot flashing unlock即可。</p>
<p>如果出现  FAILED (remote: ‘Flashing Unlock is not allowed），可以先执行fastboot flashing lock 锁定 OEM，重启手机，然后再次去开发者选项中打开运行OEM解锁，进入 BootLoader模式，然后执行上面两条命令解锁。</p>
</blockquote>
</li>
<li><p>执行 flash-all.sh 脚本 刷入ROM</p>
</li>
<li><p>执行 fastboot flashing lock 锁定OEM</p>
<blockquote>
<p>我再刷入Android Q之后，在开机连接wifi阶段卡住了，一直通过不了；</p>
<p>尝试过：</p>
<p>1、PC FQ，手机通过wifi代理到PC FQ连接Google服务器，依然无法通过。</p>
<p>2、小米手机4G+FQ，pixel 2xl 通过小米共享的热点FQ，也不行。</p>
<p>3、然后试图刷低版本(8.0)尝试绕过，还是不行。</p>
<p>4、最终通过购买香港一日流量卡解决问题。PS：流量卡需要先激活，我是小米用流量卡，共享热点给Pixel 2XL 连接上的google。流量卡需要用可以正常使用的手机先激活。</p>
<p>5、应该是我的PC、小米 FQ 都没有做到全局代理，导致google的请求没有走代理连接不上服务器。如果有路由器能FQ最好。</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/24/Android SDK 自动化测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/24/Android SDK 自动化测试/" itemprop="url">Android SDK 自动化测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-24T15:10:56+08:00">
                2019-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h5><ul>
<li><p>JUnit - JUnit 是一个 Java 编程语言的单元测试框架。<a href="https://www.w3cschool.cn/junit/" target="_blank" rel="noopener">文档</a> </p>
</li>
<li><p>JUnit 3 - JUnit 3 是JUnit的3.x版本</p>
<blockquote>
<p>在JUnit3中，如果某个类是测试类，必须将其继承类TestCase；如果某个方法是测试方法，必须让这个方法以testXX开头；如果希望指定某个测试方法运行之前运行某个初始化方法，这个方法的名称必须是setUp；如果希望在某个测试方法运行之后运行某个释放资源的方法，这个方法的名称必须是tearDown</p>
</blockquote>
</li>
<li><p>JUnit 4 - 是JUnit的 4.x版本</p>
<blockquote>
<p>JUnit 4是与JUnit3完全不同的API，它基于Java 5.0中的注解、静态导入等构建而成。JUnit 4更简单、更丰富、更易于使用，并引入了更为灵活的初始化和清理工作，还有限时的和参数化测试用例。</p>
<p>在junit4中，一个POJO类就是一个测试类；</p>
<p>1、测试方法通过@Test来标识；</p>
<p>2、初始化方法通过@Before来标识；</p>
<p>3、释放资源的方法通过@After来标识；</p>
<p>4、为了让junit4的测试类在junit3中也可以使用，习惯于把初始化方法命名为setUp，释放资源的方法命名为tearDown。</p>
<p>5、Test中的测试方法一般以Test来开始。其中标识为Before注解的方法，每次运行测试类，都会执行标识为@After与@Before的方法。</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>Instrumentation - Instrumentation是Android Java API层的一个类.</p>
<blockquote>
<p>通过阅读源码可以发现，平时我们在用Application、Activity的时候，实际上Application的创建、Activity的实例化、生命周期里onCreate等方法的调用，都是通过Instrumentation实现的。不仅如此，通过Instrumentation还可以向APP发送用户点击、按钮事件等。获取到了权限足够的Instrumentation，几乎就可以完全控制APP甚至手机了。</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>AndroidJUnit4 - 继承于Runner抽象类，不负责具体实现。采用了委托模式，由继承于Runner的另一内部对象 AndroidJUnit4ClassRunner 负责具体实现。采用了JUnit4实现。</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(AndroidJUnit4.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleInstrumentedTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    @Rule</span></span><br><span class="line">    <span class="comment">//    public ActivityTestRule activityTestRule = new ActivityTestRule(MainActivity.class);</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useAppContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>AndroidJUnitRunner - 用于build.gradle配置文件</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>Instrumentation Test Runner - 可以支持 JUnit Test测试和Instrmentation Unit Tests测试。均只支持JUnit3</p>
</li>
<li><p>Android JUnit Test Runner - 支持JUnit4，对Instumentation Test Runner 的替代。</p>
</li>
<li><p>Local Unit Tests - 基于JVM的，只支持JUnit测试，其测试代码直接在电脑上的JVM中运行。测试类应该放在src/test/java目录下。只能测试纯java代码。</p>
<blockquote>
<p>Robolectric 使用教程 ：<a href="https://blog.csdn.net/shensky711/article/details/53561172" target="_blank" rel="noopener">https://blog.csdn.net/shensky711/article/details/53561172</a> </p>
<p>Robolectric 给 Unit Tests 提供 android框架支持。</p>
<p>Mock 模仿android 依赖, <a href="https://www.jianshu.com/p/00ab03f3d394" target="_blank" rel="noopener">https://www.jianshu.com/p/00ab03f3d394</a> </p>
</blockquote>
</li>
<li><p>Instrmentation Unit Tests - 测试类放在src/androidTest/java目录。可以在模拟器、真机上测试，支持和android 框架相关的代码部分测试。</p>
<blockquote>
<p>参考文章：</p>
<p><a href="http://www.paincker.com/android-test-1" target="_blank" rel="noopener">http://www.paincker.com/android-test-1</a></p>
<p><a href="https://developer.android.com/training/testing/?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/training/testing/?hl=zh-cn</a></p>
</blockquote>
</li>
</ul>
<h5 id="测试Demo"><a href="#测试Demo" class="headerlink" title="测试Demo"></a>测试Demo</h5><ul>
<li><p>Android JUnit Demo 创建。</p>
<blockquote>
<p>优点是：直接在JVM上运行，速度快。</p>
</blockquote>
</li>
</ul>
<ul>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Java 类，不涉及android框架相关。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a * b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自动创建测试样例：在这个类中，右键-&gt; Go to -&gt; Test -&gt; Create New Test -&gt; 选择 src/test/java 目录保存  </span></span><br><span class="line"><span class="comment">// 手动创建测试样例：http://www.paincker.com/android-test-2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 右键运行 Run CalTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Cal mCal;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mCal    = <span class="keyword">new</span> Cal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mCal    = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        assertEquals(mCal.add(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multiply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        assertEquals(mCal.multiply(<span class="number">2</span>, <span class="number">3</span>), <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>Android Instrumented Tests Demo 创建</p>
<blockquote>
<p>优点是：运行在模拟器或者真机上，贴合场景。</p>
<p>对于同一个Java类，可以生成两个测试用例一个Android JUnit， 一个Android Instrumented；</p>
<p>生成方式类似，用例保存地址不同。</p>
</blockquote>
</li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/24/Android自动化测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/24/Android自动化测试/" itemprop="url">android自动化测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-24T14:02:44+08:00">
                2019-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="android-自动化测试工具介绍："><a href="#android-自动化测试工具介绍：" class="headerlink" title="android 自动化测试工具介绍："></a>android 自动化测试工具介绍：</h4><h5 id="Monkey"><a href="#Monkey" class="headerlink" title="Monkey"></a>Monkey</h5><blockquote>
<p> 是Android SDK自带的测试工具，在测试过程中会向系统发送伪随机的用户事件流，如按键输入、触摸屏输入、手势输入等)，实现对正在开发的应用程序进行压力测试，也有日志输出。实际上该工具只能做程序做一些压力测试，由于测试事件和数据都是随机的，不能自定义，所以有很大的局限性。</p>
<p>参考链接：<a href="https://blog.csdn.net/hebbely/article/details/78901466" target="_blank" rel="noopener">https://blog.csdn.net/hebbely/article/details/78901466</a> 介绍了Monkey 及相关参数的用法。</p>
</blockquote>
<h5 id="MonkeyRunner"><a href="#MonkeyRunner" class="headerlink" title="MonkeyRunner"></a>MonkeyRunner</h5><blockquote>
<p>也是Android SDK提供的测试工具。严格意义上来说MonkeyRunner其实是一个Api工具包，比Monkey强大，可以编写测试脚本来自定义数据、事件。缺点是脚本用Python来写，对测试人员来说要求较高，有比较大的学习成本。</p>
</blockquote>
<h5 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h5><blockquote>
<p>是早期Google提供的Android自动化测试工具类，虽然在那时候JUnit也可以对Android进行测试，但是Instrumentation允许你对应用程序做更为复杂的测试，甚至是框架层面的。通过Instrumentation你可以模拟按键按下、抬起、屏幕点击、滚动等事件。Instrumentation是通过将主程序和测试程序运行在同一个进程来实现这些功能，你可以把Instrumentation看成一个类似Activity或者Service并且不带界面的组件，在程序运行期间监控你的主程序。缺点是对测试人员来说编写代码能力要求较高，需要对Android相关知识有一定了解，还需要配置AndroidManifest.xml文件，不能跨多个App。</p>
</blockquote>
<h5 id="UiAutomator"><a href="#UiAutomator" class="headerlink" title="UiAutomator"></a>UiAutomator</h5><blockquote>
<p>也是Android提供的自动化测试框架，基本上支持所有的Android事件操作，对比Instrumentation它不需要测试人员了解代码实现细节（可以用UiAutomatorviewer抓去App页面上的控件属性而不看源码）。基于Java，测试代码结构简单、编写容易、学习成本，一次编译，所有设备或模拟器都能运行测试，能跨App（比如：很多App有选择相册、打开相机拍照，这就是跨App测试）。缺点是只支持SDK 16（Android 4.1）及以上，不支持Hybird App、WebApp。</p>
<p>参考链接：</p>
<p><a href="https://blog.csdn.net/eclipsexys/article/details/45622813" target="_blank" rel="noopener">https://blog.csdn.net/eclipsexys/article/details/45622813</a></p>
</blockquote>
<h5 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h5><blockquote>
<p>是Google的开源自动化测试框架。相对于Robotium和UIAutomator，它的特点是规模更小、更简洁，API更加精确，编写测试代码简单，容易快速上手。因为是基于Instrumentation的，所以不能跨App。</p>
<p>官方文档：<a href="https://developer.android.com/training/testing/espresso" target="_blank" rel="noopener">https://developer.android.com/training/testing/espresso</a> </p>
</blockquote>
<h5 id="Selendroid"><a href="#Selendroid" class="headerlink" title="Selendroid"></a>Selendroid</h5><blockquote>
<p>也是基于Instrumentation的测试框架，可以测试Native App、Hybird App、Web App，但是网上资料较少，社区活跃度也不大。</p>
</blockquote>
<h5 id="Robotium"><a href="#Robotium" class="headerlink" title="Robotium"></a>Robotium</h5><blockquote>
<p>也是基于Instrumentation的测试框架，目前国内外用的比较多，资料比较多，社区也比较活跃。缺点是对测试人员来说要有一定的Java基础，了解Android基本组件，不能跨App。</p>
</blockquote>
<h5 id="Athrun"><a href="#Athrun" class="headerlink" title="Athrun"></a>Athrun</h5><blockquote>
<p>是淘宝出的一个移动测试框架/平台，同时支持iOS和Android。Android部分也是基于Instrumentation，在Android原有的ActivityInstrumentationTestCase2类基础上进行了扩展，提供一整套面向对象的API。<a href="https://link.zhihu.com/?target=http%3A//code.taobao.org/p/athrun/wiki/index/" target="_blank" rel="noopener">这里</a>有详细介绍。</p>
<p>CSDN：<a href="https://blog.csdn.net/xiaobai20131118/article/details/43762527" target="_blank" rel="noopener">https://blog.csdn.net/xiaobai20131118/article/details/43762527</a> </p>
<p>官方文档没有找到，可能是已经关闭了。</p>
</blockquote>
<h5 id="Appium"><a href="#Appium" class="headerlink" title="Appium"></a>Appium</h5><blockquote>
<p>是最近比较热门的框架，社区也很活跃。Appium是一个跨平台工具，它允许测试人员使用同样的接口、基于不同的平台写自动化测试代码，大大增加了测试套件间代码的复用性。android部分是基于UiAutomator和Selendroid。</p>
<p>官方文档：<a href="https://github.com/appium/appium/tree/master/docs/cn" target="_blank" rel="noopener">https://github.com/appium/appium/tree/master/docs/cn</a> </p>
</blockquote>
<h5 id="Macaca"><a href="#Macaca" class="headerlink" title="Macaca"></a>Macaca</h5><blockquote>
<p>macaca 是阿里的提供的解决方案,android部分也是基于uiautomator，和AutomatorX很类似，集成了多个工具集。1.功能与AutomatorX基本相同，除了可以用wifi 2.网页的测试更好. 依赖过多，安装复杂。</p>
<p>官方文档：<a href="https://macacajs.github.io/zh/" target="_blank" rel="noopener">https://macacajs.github.io/zh/</a> </p>
</blockquote>
<h5 id="AutomatorX"><a href="#AutomatorX" class="headerlink" title="AutomatorX"></a>AutomatorX</h5><blockquote>
<p>AutomatorX是网易给出的一套解决方案，是集合了各个测试框架之后给的一个方案，所以目前看来功能点是最全的。支持夸平台。</p>
<p>官方文档：<a href="https://github.com/NetEaseGame/ATX" target="_blank" rel="noopener">https://github.com/NetEaseGame/ATX</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/22/Java 注解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/22/Java 注解/" itemprop="url">Java 注解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-22T13:43:25+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Java-注解"><a href="#Java-注解" class="headerlink" title="Java 注解"></a>Java 注解</h5><ul>
<li><p>Java 注解定义：</p>
<blockquote>
<p>Java 注解又称标注，Java 5.0 开始支持，是一种特殊的语法元数据。</p>
<p>Java 语言中的包、类、方法、参数、变量都可以被标注。和Javadoc不同，标注可以通过反射或者标注内容。在编译器生成类文件时，标注可以被嵌入到字节码中。Java虚拟机可以保留标注内容，在运行时可以获取到标注内容。当然也支持自定义的标注。</p>
</blockquote>
</li>
<li><p>Annotation Processing tool 即 apt tool，提供了一个补充性的编译时注解操作接口。</p>
</li>
<li><p>Java 内置的注解有：</p>
<blockquote>
<p>作用在代码的注解：</p>
<p>@override - 检查该方法是否是重载方法。如果发现其父类或者是引用的接口中并没有改方法时，会报编译错误。</p>
<p>@Deprecated - 标记过时方法。如果使用该方法，会报编译警告。</p>
<p>@SuppressWarnings - 指示编译器去忽略注解中声明的警告。</p>
<p>作用于其他注解的注解（或者说元注解）：</p>
<p>@Retention - 标识这个注解怎么保存，是只在代码中，还是编入class文件中，或者是在运行时可以通过反射访问。</p>
<p>@Ducumented - 标记这个注解是否包含在用户文档中。</p>
<p>@Target - 标记这个注解应该是那种Java成员。</p>
<p>@Inherited - 标记这个注解是继承于哪个注解类(默认 注解并没有继承于任何子类)</p>
<p>从Java 7 额外添加了3个注解：</p>
<p>@SafeVarargs - Java 7 支持，忽略任何使用参数为泛型变量的方法或构造函数的调用产生的警告。</p>
<p>@FunctionalInterface - Java 8 开始支持，标识一个匿名函数或者函数式接口。</p>
<p>@Repeatable - Java 8 开始支持， 标识某注解可以在同一个声明是使用多次。</p>
</blockquote>
</li>
</ul>
<h5 id="android-内置注解"><a href="#android-内置注解" class="headerlink" title="android 内置注解"></a>android 内置注解</h5><blockquote>
<p>@Nullable - 指示变量、参数、返回值可以为null。</p>
<p>@NonNull - 指示变量、参数、返回值不可以为null。</p>
<p>资源注解：</p>
<p>@StringRes - 字符串标注，参数只接受R.string.tips， R.color.tips报错。虽然都是整形。</p>
<p>@DrawableRes - 以下都同上。</p>
<p>@DimenRes - </p>
<p>@ColorRes - </p>
<p>@InterpolatorRes - </p>
<p>@LayoutRes - </p>
<p>线程注解：用于检测某个方法是否从指定类型的线程中调用。</p>
<p>@MainThread - </p>
<p>@UIThread - </p>
<p>@WorkerThread - </p>
<p>@BinderThread - </p>
<p>@AnyThread - </p>
<p>值约束注解：</p>
<p>@IntRange - 验证传递参数的值的取值范围</p>
<p>@FloatRange - 同上</p>
<p>@Size - 验证传递参数的值（例如：数组等）的长度。</p>
<p>权限注解：</p>
<p>@RequiresPermission - 验证方法调用方的权限。</p>
<p>返回值注解：</p>
<p>@CheckResult - 验证调用方是否有对方法的返回值进行处理。</p>
<p>超类注解：</p>
<p>@CallSuper - 验证子类重新父类的方法，是否有调用父类的实现，没有则报警告。</p>
<p> 枚举注解：</p>
<p>@Typedef - 可以确保特定的参数、返回值、字段引用特定的常量集。</p>
<p>代码可访问性注解：</p>
<p>@Keep - 标注的类或者方法在混淆的时候不被混淆。</p>
<p>其他常见注解：</p>
<p>@TargetApi - 用于屏蔽IDE对API版本的限制。即相当于告诉编译器标记的代码在指定的api上面运行。</p>
<p>@SuppressLint - 类似@TargetApi，屏蔽IDE对API版本的一切限制。</p>
<p>@Widget - 标记该类是自定义的Widget类。</p>
<p>测试可见注解：</p>
<p>@VisibleForTesting - 标注是否对测试可见。</p>
</blockquote>
<ul>
<li><p>android 注解的特性：</p>
<blockquote>
<p>1、依赖注入；</p>
<p>2、简化线程操作；</p>
<p>3、事件绑定；</p>
<p>4、No Magic，只是在编译的时候生成了子类，可以检查代码看是如何运行的。</p>
<p>5、体积小，无反射，没有运行时影响。不会影响性能。</p>
</blockquote>
</li>
</ul>
<h5 id="运行时动态注解实现：参考"><a href="#运行时动态注解实现：参考" class="headerlink" title="运行时动态注解实现：参考"></a>运行时动态注解实现：<a href="https://juejin.im/post/5addec5cf265da0b7b35861c" target="_blank" rel="noopener">参考</a></h5><blockquote>
<p>运行时注解一般和反射机制配合使用，相比编译时注解性能比较低，但灵活性好，实现起来比较简单。</p>
</blockquote>
<ul>
<li><p>创建注解，创建一个可以字符串相加的注解。</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.test;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(value = ElementType.FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Append&#123;</span><br><span class="line">    <span class="function">String <span class="title">str1</span><span class="params">()</span> <span class="keyword">default</span> "hello"</span>;</span><br><span class="line">    <span class="function">String <span class="title">str2</span><span class="params">()</span> <span class="keyword">default</span> "world"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用反射实现注解处理：</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="comment">//import</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Inject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">final</span> Object object)</span></span>&#123;</span><br><span class="line">        Field[] fields  = object.getClass().getDeclaredFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Field field: fields)&#123;</span><br><span class="line">            Append append   = field.getAnnotation(Append.class);</span><br><span class="line">            <span class="keyword">if</span>(append != <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(object <span class="keyword">instanceof</span> MainActivity)&#123;</span><br><span class="line">                    String str  = append.str1() + append.str2();</span><br><span class="line"></span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        field.set(object, str);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注解使用Demo</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Append</span>(str1 = <span class="string">"how"</span>, str2 = <span class="string">"are you"</span>)</span><br><span class="line"><span class="keyword">public</span> String tips;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Append</span></span><br><span class="line"><span class="keyword">public</span> String names;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">	setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">	Inject.inject(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制台输出：howare you  helloworld</span></span><br><span class="line">  Log.i(<span class="string">"TAG"</span>, tips + <span class="string">"  "</span>+ names);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="编译时注解实现："><a href="#编译时注解实现：" class="headerlink" title="编译时注解实现："></a>编译时注解实现：</h5><blockquote>
<p>编译时注解通过注解处理器实现。注解处理器是（Annotation Processor）是javac的一个工具，用来在编译时扫描和编译和处理注解（Annotation）。</p>
<p>注解处理器以Java代码或者（编译过的字节码）作为输入，生成文件（通常是java文件）。这些生成的java文件不能修改，并且会同其手动编写的java代码一样会被javac编译。</p>
</blockquote>
</li>
<li><p>创建注解</p>
<blockquote>
<p>使用 Java Module - lib_annotations，用于在编译时，生成XXX_SUFFIX.java 文件，代码如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.lib_annotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(value = ElementType.FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EAppend &#123;</span><br><span class="line">    <span class="function">String <span class="title">str1</span><span class="params">()</span> <span class="keyword">default</span> "hello"</span>;</span><br><span class="line">    <span class="function">String <span class="title">str2</span><span class="params">()</span> <span class="keyword">default</span> "world"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建注解解析器</p>
<blockquote>
<p>使用 Java Module - lib_compiler, 依赖上面 Module，代码如下</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.lib_compiler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.pa.test.lib_annotations.EAppend;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Name;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.type.TypeMirror;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.util.Elements;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String value1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String value2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Element mClassElement;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 元素相关的辅助类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> Elements mElementUtils;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TypeMirror elementType;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Name elementName;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AnnotatedClass</span><span class="params">(Element classElement)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.mClassElement = classElement;</span><br><span class="line">            <span class="keyword">this</span>.elementType = classElement.asType();</span><br><span class="line">            <span class="keyword">this</span>.elementName = classElement.getSimpleName();</span><br><span class="line"></span><br><span class="line">            value1 = mClassElement.getAnnotation(EAppend.class).str1();</span><br><span class="line">            value2 = mClassElement.getAnnotation(EAppend.class).str2();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Name <span class="title">getElementName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> elementName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">TypeMirror <span class="title">getElementType</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> elementType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String <span class="title">getTotal</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"\""</span>+ (value1 + value2) + <span class="string">"\""</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 包名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPackageName</span><span class="params">(TypeElement type)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mElementUtils.getPackageOf(type).getQualifiedName().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 类名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getClassName</span><span class="params">(TypeElement type, String packageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> packageLen = packageName.length() + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> type.getQualifiedName().toString().substring(packageLen).replace(<span class="string">'.'</span>, <span class="string">'$'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.lib_compiler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</span><br><span class="line"><span class="keyword">import</span> com.pa.test.lib_annotations.EAppend;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.JavaFile;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.MethodSpec;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.TypeName;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.TypeSpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Filer;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Messager;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.ElementKind;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Modifier;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.util.Elements;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.util.Types;</span><br><span class="line"><span class="keyword">import</span> javax.tools.Diagnostic;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EAppendProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EAPPEND_SUFFIX = <span class="string">"_EAppend"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_STATEMENT_FORMAT = <span class="string">"target.%1$s = %2$s"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONST_PARAM_TARGET_NAME = <span class="string">"target"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span> CHAR_DOT = <span class="string">'.'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Messager    messager;</span><br><span class="line">    <span class="keyword">private</span> Types       typesUtil;</span><br><span class="line">    <span class="keyword">private</span> Elements    elementsUtil;</span><br><span class="line">    <span class="keyword">private</span> Filer       filer;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析的目标注解集合，一个类里可以包含多个注解，所以是Map&lt;String, List&lt;AnnotatedClass&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, List&lt;AnnotatedClass&gt;&gt; annotatedElementMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">        messager    = processingEnv.getMessager();</span><br><span class="line">        typesUtil   = processingEnv.getTypeUtils();</span><br><span class="line">        filer       = processingEnv.getFiler();</span><br><span class="line">        elementsUtil    = processingEnv.getElementUtils();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</span><br><span class="line">        annotataions.add(EAppend.class.getCanonicalName());</span><br><span class="line">        <span class="keyword">return</span> annotataions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//            因为该方法可能会执行多次，所以每次进来必须clear</span></span><br><span class="line">        annotatedElementMap.clear();</span><br><span class="line">        <span class="comment">//1.遍历每个有Add注解的Element，</span></span><br><span class="line">        <span class="comment">//2.然后把它加入Map里面,一个类里可以包含多个注解，所以是Map&lt;String, List&lt;AnnotatedClass&gt;&gt;，</span></span><br><span class="line">        <span class="comment">//3.赋予它工作任务，告诉他你该做什么，</span></span><br><span class="line">        <span class="comment">//4.然后生成Java文件</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(EAppend.class)) &#123;</span><br><span class="line">            <span class="comment">//判断被注解的类型是否符合要求</span></span><br><span class="line">            <span class="keyword">if</span> (element.getKind() != ElementKind.FIELD) &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Only FIELD can be annotated with @%s"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            TypeElement encloseElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">            String fullClassName = encloseElement.getQualifiedName().toString();</span><br><span class="line">            AnnotatedClass annotatedClass = <span class="keyword">new</span> AnnotatedClass(element);</span><br><span class="line">            <span class="comment">//把类名和该类里面的所有关于Add注解的注解放到Map里面</span></span><br><span class="line">            <span class="keyword">if</span>(annotatedElementMap.get(fullClassName) == <span class="keyword">null</span>)&#123;</span><br><span class="line">                annotatedElementMap.put(fullClassName, <span class="keyword">new</span> ArrayList&lt;AnnotatedClass&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            annotatedElementMap.get(fullClassName).add(annotatedClass);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//因为该方法会执行多次，所以size=0时返回true结束</span></span><br><span class="line">        <span class="keyword">if</span> (annotatedElementMap.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用javapoet生成类文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;AnnotatedClass&gt;&gt; entry : annotatedElementMap.entrySet()) &#123;</span><br><span class="line">                MethodSpec constructor  = createConstructor(entry.getValue());</span><br><span class="line">                TypeSpec binder         = createClass(getClassName(entry.getKey()), constructor);</span><br><span class="line">                JavaFile javaFile       = JavaFile.builder(getPackage(entry.getKey()), binder).build();</span><br><span class="line">                javaFile.writeTo(filer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Error on creating java file"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是javapoet创建各种方法的实现方式</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createConstructor</span><span class="params">(List&lt;AnnotatedClass&gt; randomElements)</span> </span>&#123;</span><br><span class="line">        AnnotatedClass firstElement = randomElements.get(<span class="number">0</span>);</span><br><span class="line">        MethodSpec.Builder builder = MethodSpec.constructorBuilder()</span><br><span class="line">                .addModifiers(Modifier.PUBLIC)</span><br><span class="line">                .addParameter(TypeName.get(firstElement.mClassElement.getEnclosingElement().asType()), CONST_PARAM_TARGET_NAME);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; randomElements.size(); i++) &#123;</span><br><span class="line">            addStatement(builder, randomElements.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addStatement</span><span class="params">(MethodSpec.Builder builder, AnnotatedClass randomElement)</span> </span>&#123;</span><br><span class="line">        builder.addStatement(String.format(</span><br><span class="line">                TARGET_STATEMENT_FORMAT,</span><br><span class="line">                randomElement.getElementName().toString(),</span><br><span class="line">                randomElement.getTotal())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createClass</span><span class="params">(String className, MethodSpec constructor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TypeSpec.classBuilder(className + EAPPEND_SUFFIX)</span><br><span class="line">                .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span><br><span class="line">                .addMethod(constructor)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getPackage</span><span class="params">(String qualifier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qualifier.substring(<span class="number">0</span>, qualifier.lastIndexOf(CHAR_DOT));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getClassName</span><span class="params">(String qualifier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> qualifier.substring(qualifier.lastIndexOf(CHAR_DOT) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'java-library'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup:javapoet:1.9.0'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.google.auto.service:auto-service:1.0-rc4'</span></span><br><span class="line">    implementation <span class="keyword">project</span>(<span class="string">':lib_annotations'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="string">"7"</span></span><br><span class="line"><span class="keyword">targetCompatibility</span> = <span class="string">"7"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>AutoService 主要的作用是注解 processor 类，并对其生成 META-INF 的配置信息。</li>
<li>JavaPoet 这个库的主要作用就是帮助我们通过类调用的形式来生成代码。</li>
<li>参考：<a href="https://juejin.im/entry/58fefebf8d6d810058a610de" target="_blank" rel="noopener">https://juejin.im/entry/58fefebf8d6d810058a610de</a> </li>
<li>参考：<a href="https://juejin.im/post/584d4b5b0ce463005c5dc444" target="_blank" rel="noopener">https://juejin.im/post/584d4b5b0ce463005c5dc444</a> </li>
</ol>
</blockquote>
</li>
<li><p>创建辅助模块</p>
<blockquote>
<p>使用存Java Module - lib_api ，用于将类A.java 与 编译时生成的A_SUFFIX.java 关联，非必须的。也可以在</p>
<p>Demo中手动关联。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pa.test.lib_api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EAppend_SUFFIX = <span class="string">"_EAppend"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Utils</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class bindingClass = Class.forName(object.getClass().getCanonicalName() + EAppend_SUFFIX);</span><br><span class="line">            Constructor constructor = bindingClass.getConstructor(object.getClass());</span><br><span class="line">            constructor.newInstance(object);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建demo</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="meta">@Append</span>(str1 = <span class="string">"how"</span>, str2 = <span class="string">"are you"</span>)</span><br><span class="line"><span class="keyword">public</span> String tips;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Append</span></span><br><span class="line"><span class="keyword">public</span> String names;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@EAppend</span>(str1 = <span class="string">"hi "</span>, str2 = <span class="string">"annotations"</span>)</span><br><span class="line"><span class="keyword">public</span> String ann;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@EAppend</span></span><br><span class="line"><span class="keyword">public</span> String ant;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">  </span><br><span class="line">    Inject.inject(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// howare you  helloworld</span></span><br><span class="line">    Log.i(<span class="string">"TAG"</span>, tips + <span class="string">"  "</span>+ names);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    Utils.inject(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// hi annotations  helloworld</span></span><br><span class="line">    Log.i(<span class="string">"TAG"</span>, ann + <span class="string">"  "</span>+ ant);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;com.android.application&apos;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 29</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId &quot;com.pa.test.test&quot;</span><br><span class="line">        minSdkVersion 26</span><br><span class="line">        targetSdkVersion 29</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</span><br><span class="line">    implementation &apos;com.android.support:appcompat-v7:28.+&apos;</span><br><span class="line">    implementation &apos;com.android.support.constraint:constraint-layout:1.1.3&apos;</span><br><span class="line">    testImplementation &apos;junit:junit:4.12&apos;</span><br><span class="line">    androidTestImplementation &apos;com.android.support.test:runner:1.0.2&apos;</span><br><span class="line">    androidTestImplementation &apos;com.android.support.test.espresso:espresso-core:3.0.2&apos;</span><br><span class="line"></span><br><span class="line">    api project(&apos;:lib_annotations&apos;)</span><br><span class="line">    api project(&apos;:lib_api&apos;)</span><br><span class="line">    annotationProcessor project(&apos;:lib_compiler&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/19/Hexo + github 搭建静态博客/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/19/Hexo + github 搭建静态博客/" itemprop="url">Hexo + github 搭建静态博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-19T15:41:59+08:00">
                2019-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Hexo-github-搭建静态博客"><a href="#Hexo-github-搭建静态博客" class="headerlink" title="Hexo + github 搭建静态博客"></a>Hexo + github 搭建静态博客</h5><ul>
<li><p>注册github，创建项目; <a href="https://zhuanlan.zhihu.com/p/35668237" target="_blank" rel="noopener">参考文章</a> </p>
</li>
<li><p>安装git、curl、brew、node.js等</p>
</li>
<li><p>安装hexo 相关; <a href="https://zhuanlan.zhihu.com/p/35668237" target="_blank" rel="noopener">参考文章</a></p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> npm install -g hexo-cli</span><br><span class="line"><span class="meta">$</span> npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化hexo项目</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入hexo 项目的根目录，获取next 主题</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> git clone https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改hexo 项目更目录下面的_config.yml文件</p>
</li>
<li><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">title: note</span><br><span class="line">author: lpl</span><br><span class="line">language: zh-Hans</span><br><span class="line"></span><br><span class="line">url: https://zubao.github.io/blog</span><br><span class="line">root: /blog/</span><br><span class="line"></span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:zubao/blog.git</span><br><span class="line">  branch: master</span><br><span class="line">  message: message</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexo 命令介绍; <a href="https://hexo.io/zh-cn/docs/generating.html" target="_blank" rel="noopener">hexo 文档</a> </p>
<blockquote>
<p>hexo g 生成静态文件</p>
<p>hexo d 发布到github</p>
<p>hexo s 启动本地静态服务器</p>
<p>ls -i tcp:4000 查找端口为4000的进程</p>
<p>kill -9 PID 杀掉进程</p>
<p>hexo clean 清除缓存</p>
</blockquote>
</li>
<li><p>next 主题文档介绍: <a href="[http://theme-next.iissnan.com/getting-started.html](http://theme-next.iissnan.com/getting-started.html)">官方文档</a> </p>
</li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/19/AOSP文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/19/AOSP文档/" itemprop="url">AOSP 编译文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-19T11:32:45+08:00">
                2019-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="准备工作："><a href="#准备工作：" class="headerlink" title="准备工作："></a>准备工作：</h5><ul>
<li><p>Mac Pro 10.14版本，16G内存，256G SSD；</p>
</li>
<li><p>外接移动硬盘1T，使用自带的磁盘工具分区；A区不分大小写，用于时间机器备份电脑；B区(Mac OS扩展，区分大小写)用于AOSP项目。</p>
</li>
<li><p><a href="https://source.android.com/setup/build/initializing" target="_blank" rel="noopener">参考官网配置环境</a></p>
</li>
<li><p><a href="https://mirror.tuna.tsinghua.edu.cn/help/AOSP/" target="_blank" rel="noopener">去清华镜像下载AOSP初始包</a>；使用curl -C - -O 命令，迅雷需要会员不然下载不了。文件47.8GB，需要使用支持断点续传的工具下载。</p>
</li>
<li><p><a href="https://source.android.com/setup/build/downloading" target="_blank" rel="noopener">官网下载文档</a></p>
</li>
<li><p><a href="[https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly](https://link.jianshu.com/?t=https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly)">下载md5文件</a></p>
</li>
<li><p>验证aosp-latest.tar文件的md5值，判断是否下载完整。</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install md5sha1sum</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证md5</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum aosp-latest.tar</span><br></pre></td></tr></table></figure>
</li>
<li><p>将初始包下载到移动硬盘分区中，并解压：</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf aosp-latest.tar</span><br></pre></td></tr></table></figure>

<p>运行命令同步项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果命令repo没有，参考<a href="https://mirror.tuna.tsinghua.edu.cn/help/AOSP/" target="_blank" rel="noopener">清华文档</a> 下载配置。</p>
</li>
<li><p>查看远程分支，切换分支：</p>
</li>
<li><p>查看可切换的分支 ，切换分支，并同步代码：</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd .repo/manifests </span><br><span class="line">git branch -a </span><br><span class="line">切换到9.0分支</span><br><span class="line">repo init -b  android-9.0.0_r34</span><br><span class="line">同步代码</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>（可选）切换命令行运行的shell版本</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -p $$ // 查看当前运行的shell版本</span><br><span class="line">chsh -s /bin/bash // 切换到b shell</span><br><span class="line">chsh -s /bin/zsh // 切换到 z shell</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化环境, 必须在bash环境运行。</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd aosp</span><br><span class="line">source build/envsetup.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>(可选)查看cpu内核数，用于编译时选择线程数。我的是4核</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -n machdep.cpu.core_count</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过lunch 命令选择要编译的源码架构, 需要输入对应的序号。ps：lunch可能会花几分钟。</p>
</li>
<li><p>编译源码，x=cpu核心数*2+2。如果没有lunch，默认编译第一个。</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -jx</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理编译产生的文件</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make clobber</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="https://blog.csdn.net/nwpushuai/article/details/79255993" target="_blank" rel="noopener">AOSP目录详解</a> 解释每个目录、子目录的用途，编译宏观上理解android。</p>
</li>
<li><p><a href="https://source.android.com/setup/build/running#selecting-device-build" target="_blank" rel="noopener">刷机文档</a></p>
</li>
<li><p>错误a</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">internal error: could not open symlink hardware/qcom/sdm710/Android.bp</span><br></pre></td></tr></table></figure>

<p>方法1：删除sdm710目录；(采用，验证可以通过这个错误)</p>
<p>方法2：重新解压，重新同步不同的分支。</p>
<p>网上说法是，遗漏了某些文件，或者是上一个分支的问题没有移除；<a href="https://groups.google.com/forum/?nomobile=true#!topic/android-building/k5RKBPNGMrg" target="_blank" rel="noopener">参考</a></p>
</li>
<li><p>错误b</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">internal error: Could not find a supported mac sdk: [&quot;10.10&quot; &quot;10.11&quot; &quot;10.12&quot; &quot;10.13&quot;]</span><br></pre></td></tr></table></figure>

<p>解决方法：<a href="https://www.cnblogs.com/larack/p/9646860.html" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim build/soong/cc/config/x86_darwin_host.go</span><br><span class="line">darwinSupportedSdkVersions = []string&#123;</span><br><span class="line">      &quot;10.10&quot;,</span><br><span class="line">      &quot;10.11&quot;,</span><br><span class="line">      &quot;10.12&quot;,</span><br><span class="line">      &quot;10.13&quot;,</span><br><span class="line">      &quot;10.14&quot;,</span><br><span class="line">&#125;</span><br><span class="line">因为我的系统版本，xcode版本是10.14，这里也添加 10.14</span><br></pre></td></tr></table></figure>

<p>添加10.14后，可能报<a href="https://groups.google.com/forum/#!topic/android-building/f4_tNSapWsA" target="_blank" rel="noopener">错误</a> ，解决方法是<a href="https://github.com/phracker/MacOSX-SDKs" target="_blank" rel="noopener">下载MacOSX10.13.SDK</a> 放到 目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs</span><br></pre></td></tr></table></figure>

<p>这里要注意的是10.13SDK网上有些版本是有bug的，部分文件的符号引用在文件夹移动之后失效。上面下载地址中github上修正了这个bug。</p>
</li>
<li><p>编译成功提示</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>### build completed successfully (05:58:17 (hh:mm:ss)) ####</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行emulator 运行模拟器。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator -partition-size 3000</span><br></pre></td></tr></table></figure>

<ul>
<li><p>运行模拟器报错</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator: command not found</span><br></pre></td></tr></table></figure>

<p>原因是 直接使用make编译的项目。</p>
<p>解决方法：</p>
<p>使用lunch 选择 aosp_x86_64-eng 重新编译，就可以正常启动模拟器。<a href="https://github.com/TADSG/aosp-study/tree/master/ch3_build" target="_blank" rel="noopener">参见</a> </p>
</li>
<li><p>使用IntelliJ 阅读源码</p>
<blockquote>
<p>1、使用命令，生成android.ipr, android.iml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; make idegen &amp;&amp; development/tools/idegen/idegen.sh</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>2、修改IntelliJ 配置，扩大虚拟机使用内存，文件大小写敏感。方法：打开IntelliJ包内容，bin目录下找到 <code>idea.vmoptions</code> 和 <code>idea.properties</code> 这两个文件。具体参考：<a href="https://www.jianshu.com/p/1d1b8d0de1ed" target="_blank" rel="noopener">https://www.jianshu.com/p/1d1b8d0de1ed</a></p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/15/Java 虚拟机阅读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/15/Java 虚拟机阅读/" itemprop="url">Java虚拟机阅读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-15T16:50:35+08:00">
                2019-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Java-虚拟机阅读"><a href="#Java-虚拟机阅读" class="headerlink" title="Java 虚拟机阅读"></a>Java 虚拟机阅读</h5><ul>
<li><p>KVM (Kilobyte VM)</p>
<blockquote>
<p>KVM 中的 K 是“Kilobyte”的意思，它强调简单，轻量，高度可移植，但是运行速度比较慢。在 Androd、iOS 等智能手机操作系统出现前曾经在手机平台上得到非常广泛应用。</p>
<p>优点：包含JVM最核心的组件；实现方式与JVM规范描述的抽象的JVM相近</p>
<p>缺点：是Java ME CLDC VM，而不是Java SE VM；未实现反射、浮点计算等功能。</p>
<p>注意：KVM(kernel-base VM) 是一款基于linux内核的虚拟机 <a href="[https://www.evernote.com/shard/s325/client/snv?noteGuid=bebe0aaa-9d30-4624-9772-a0af9dfffead&noteKey=a08905a6b6733c5cd945bba560d4d927&sn=https%3A%2F%2Fwww.evernote.com%2Fshard%2Fs325%2Fsh%2Fbebe0aaa-9d30-4624-9772-a0af9dfffead%2Fa08905a6b6733c5cd945bba560d4d927&title=QEMU%252BKVM%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0](https://www.evernote.com/shard/s325/client/snv?noteGuid=bebe0aaa-9d30-4624-9772-a0af9dfffead&noteKey=a08905a6b6733c5cd945bba560d4d927&sn=https%3A%2F%2Fwww.evernote.com%2Fshard%2Fs325%2Fsh%2Fbebe0aaa-9d30-4624-9772-a0af9dfffead%2Fa08905a6b6733c5cd945bba560d4d927&title=QEMU%2BKVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0)">QEMU+KVM</a> <a href="https://www.hongweipeng.com/index.php/archives/1179/" target="_blank" rel="noopener">KVM 介绍</a>  <a href="https://blog.csdn.net/21cnbao/article/details/56654334" target="_blank" rel="noopener">宋宝华KVM介绍</a> </p>
<p><a href="https://www.infoq.cn/article/jvm-family" target="_blank" rel="noopener">Java 虚拟机家族考</a> </p>
</blockquote>
</li>
<li><p>Squawk VM</p>
<blockquote>
<ul>
<li>Squawk VM 是由 Sun 开发，运行于 Sun SPOT（Sun Small Programmable Object Technology，一种手持的 Wifi 设备），也曾经运用于 Java Card。这是一个 Java 代码比重很高的嵌入式虚拟机实现，其中诸如类加载器、字节码验证器、垃圾收集器、解释器、编译器和线程调度都是 Java 语言本身所完成的，仅仅靠 C 语言来编写设备 I/O 和必要的本地代码。</li>
</ul>
</blockquote>
</li>
<li><p>JavaInJava</p>
<blockquote>
<p>JavaInJava 是 Sun 公司 1997 年～1998 年间所研发的一个实验室性质的虚拟机，从名字就可以看出，它试图以 Java 语言来实现 Java 语言本身的运行环境，既所谓的“元循环”（Meta-Circular，是指使用语言自身来实现其运行环境）。它必须运行在另外一个宿主虚拟机之上，内部没有 JIT 编译器，代码只能以解释模式执行。在上世纪末主流 Java 虚拟机都未能很好解决性能问题的时代，开发这种项目，其执行速度大家可想而知。</p>
</blockquote>
</li>
<li><p>Maxine VM</p>
<blockquote>
<p>Maxine VM 和上面的 JavaInJava 非常相似，它也是一个几乎全部以 Java 代码实现（只有用于启动 JVM 的加载器使用 C 语言编写）的元循环 Java 虚拟机。这个项目于 2005 年开始，到现在仍然在发展之中，比起 JavaInJava，Maxine VM 就显得“靠谱”很多，它有先进的 JIT 编译器和垃圾收集器（但没有解释器），可在宿主模式或独立模式下执行，其执行效率已经接近了 HotSpot Client VM 的水平</p>
</blockquote>
</li>
<li><p>JRockit VM</p>
<blockquote>
<p>曾经号称“世界上速度最快的 Java 虚拟机”（广告词，貌似 J9 VM 也这样说过），它是 BEA 公司在 2002 年从 Appeal Virtual Machines 公司收购获得的虚拟机。BEA 将其发展为一款专门为服务器硬件和服务端应用场景高度优化的虚拟机，由于专注于服务端应用，它可以不太关注于程序启动速度，因此 JRockit 内部不包含解析器实现，全部代码都靠即时编译器编译后执行。除此之外，JRockit 的垃圾收集器和 MissionControl 服务套件等部分的实现，在众多 Java 虚拟机中也一直处于领先水平。</p>
</blockquote>
</li>
<li><p>IBM J9 VM</p>
<blockquote>
<p>并不是 IBM 公司唯一的 Java 虚拟机，不过是目前 IBM 主力发展的 Java 虚拟机，J9 原本是内部开发代号，正式名称是“IBM Technology for Java Virtual Machine”，简称 IT4J，只是这个名字太拗口了一点，普及程度不如 J9。J9 VM 最初是由 IBM Ottawa 实验室一个 SmallTalk 的虚拟机扩展而来的，当时这个虚拟机有一个 bug 是因为 8k 值定义错误引起，工程师们花了很长时间终于发现并解决了这个错误，此后这个版本的虚拟机就被称为 K8 了，后来扩展出支持 Java 的虚拟机就被称为 J9 了。与 BEA JRockit 专注于服务端应用不同，IBM J9 的市场定位与 Sun HotSpot 比较接近，它是一款设计上从服务端到桌面应用再到嵌入式都全面考虑的多用途虚拟机，J9 的开发目的是作为 IBM 公司各种 Java 产品的执行平台，它的主要市场在和 IBM 产品（如 IBM WebSphere 等）搭配以及在 IBM AIX 和 z/OS 这些平台上部署 Java 应用。</p>
</blockquote>
</li>
<li><p>Apache Harmony</p>
<blockquote>
<p>是一个 Apache 软件基金会旗下以 Apache License 协议开源的实际兼容于 JDK 1.5 和 JDK 1.6 的 Java 程序运行平台，这个介绍相当拗口。它包含自己的虚拟机和 Java 库，用户可以在上面运行 Eclipse、Tomcat、Maven 等常见的 Java 程序，但是……它没有通过 TCK 认证，所以我们不得不用那么一长串拗口的语言来介绍它，而不能用一句“Apache 的 JDK”来说明。如果一个公司要宣布自己的运行平台“兼容于 Java 语言”，那就必须要通过 TCK（Technology Compatibility Kit）的兼容性测试，Apache 基金会曾要求 Sun 公司提供 TCK 的使用授权，但是一直遭到拒绝，直到 Oracle 收购了 Sun 公司之后，双方关系越闹越僵，最终导致 Apache 愤然退出 JCP（Java Community Process）组织，这是近代 Java 社区最严重的一次分裂。</p>
</blockquote>
</li>
<li><p>Dalvik VM</p>
<blockquote>
<p>是 Android 平台的核心组成部分之一，它名字来源于冰岛一个名为 Dalvik 的小渔村。Dalvik VM 并不是一个 Java 虚拟机，它没有遵循 Java 虚拟机规范，不能直接执行 Java 的 class 文件，使用寄存器架构而不是 JVM 中常见的栈架构。但是它与 Java 却又有着千丝万缕的联系，它执行 dex（Dalvik Executable）文件可以通过 class 文件转化而来，使用 Java 语法编写应用程序，可以直接使用大部分的 Java API 等等。目前 Dalvik VM 随着 Android 一起处于迅猛发展阶段，在 Android 2.2 中已提供即时编译器实现，执行性能有了很大的提高。</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/07/15/Java JNI 调用 C 实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/07/15/Java JNI 调用 C 实现/" itemprop="url">Java JNI 调用 C 实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-15T14:28:42+08:00">
                2019-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="Java-JNI-调用-C-实现"><a href="#Java-JNI-调用-C-实现" class="headerlink" title="Java JNI 调用 C 实现"></a>Java JNI 调用 C 实现</h5><ul>
<li><p>创建目录hook</p>
</li>
<li><p>创建Test.java文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">package</span> hook;</span><br><span class="line"> <span class="number">2</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line"> <span class="number">3</span>     <span class="keyword">static</span>&#123;</span><br><span class="line"> <span class="number">4</span>         System.loadLibrary(<span class="string">"test"</span>);</span><br><span class="line"> <span class="number">5</span>     &#125;</span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeAdd</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"> <span class="number">8</span></span><br><span class="line"> <span class="number">9</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line"><span class="number">10</span>         <span class="keyword">return</span> x + y;</span><br><span class="line"><span class="number">11</span>     &#125;</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line"><span class="number">14</span>         Test test       = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="number">15</span>         System.out.println(System.getProperty(<span class="string">"java.library.path"</span>));</span><br><span class="line"><span class="number">16</span>         System.out.println(test.add(<span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line"><span class="number">17</span>         System.out.println(test.nativeAdd(<span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line"><span class="number">18</span>     &#125;</span><br><span class="line"><span class="number">19</span> &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>编译java文件.</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac hook/Test.java</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 jni 头文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">javah -jni hook.Test</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span> <span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line">  <span class="number">2</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line">  <span class="number">3</span> <span class="comment">/* Header for class hook_Test */</span></span><br><span class="line">  <span class="number">4</span></span><br><span class="line">  <span class="number">5</span> <span class="meta">#<span class="meta-keyword">ifndef</span> _Included_hook_Test</span></span><br><span class="line">  <span class="number">6</span> <span class="meta">#<span class="meta-keyword">define</span> _Included_hook_Test</span></span><br><span class="line">  <span class="number">7</span> <span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">  <span class="number">8</span> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">  <span class="number">9</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> <span class="number">10</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> 11  * Class:     hook_Test</span></span><br><span class="line"><span class="comment"> 12  * Method:    nativeAdd</span></span><br><span class="line"><span class="comment"> 13  * Signature: (II)I</span></span><br><span class="line"><span class="comment"> 14  */</span></span><br><span class="line"> <span class="number">15</span> JNIEXPORT jint JNICALL Java_hook_Test_nativeAdd</span><br><span class="line"> <span class="number">16</span>   (JNIEnv *, jobject, jint, jint);</span><br><span class="line"> <span class="number">17</span></span><br><span class="line"> <span class="number">18</span> <span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"> <span class="number">19</span> &#125;</span><br><span class="line"> <span class="number">20</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> <span class="number">21</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写Test.c 文件，和hook 同一级目录。</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hook_Test.h"</span></span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span> JNIEXPORT jint JNICALL Java_hook_Test_nativeAdd</span><br><span class="line"><span class="number">4</span>   (JNIEnv * env, jobject obj, jint x, jint y)&#123;</span><br><span class="line"><span class="number">5</span>       <span class="keyword">return</span> x + y ;</span><br><span class="line"><span class="number">6</span>       &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成动态链接库，命令如下</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -dynamiclib -o libtest.jnilib Test.c -framework JavaVM -I $JAVA_HOME/include -I $JAVA_HOME/include/darwin</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<p> -o：指定动态链接库编译后生成的路径及文件名</p>
<p>   -dynamiclib：表示编译成动态链接库</p>
<p>   -framework JavaVM -I：编译JNI需要用到JVM的头文件(jni.h)，第一个目录是平台无关的，第二个目录是与操作系统平台相关的头文件</p>
<p>mac 上和linux上命令有少许差异，linux 上是生成so文件，mac上是生成jnilib文件</p>
<p><a href="https://blog.csdn.net/hackooo/article/details/48395765" target="_blank" rel="noopener">参考文件linux</a>,[参考文件多平台]([<a href="http://blog.0613.me/2017/05/14/20170514%20-%20Java-%E9%80%9A%E8%BF%87-JNI-%E8%B0%83%E7%94%A8-so-jnilib-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/]" target="_blank" rel="noopener">http://blog.0613.me/2017/05/14/20170514%20-%20Java-%E9%80%9A%E8%BF%87-JNI-%E8%B0%83%E7%94%A8-so-jnilib-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/]</a>(<a href="http://blog.0613.me/2017/05/14/20170514" target="_blank" rel="noopener">http://blog.0613.me/2017/05/14/20170514</a> - Java-通过-JNI-调用-so-jnilib-动态链接库/)) </p>
</blockquote>
</li>
<li><p>执行验证结果</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. hook.Test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要加上 -Djava.library.path=. 指明从当前目录加载动态链接库文件，否则会出现找不到库文件的异常。</p>
</blockquote>
</li>
<li><p>查看class 文件命令</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">javap -verbose hook.Test</span><br><span class="line"></span><br><span class="line">Classfile /Users/lipeilong/note/java/vm/hook/Test.class</span><br><span class="line">  Last modified 2019-7-15; size 747 bytes</span><br><span class="line">  MD5 checksum 223fad605354553a14ee9dd1adaae086</span><br><span class="line">  Compiled from "Test.java"</span><br><span class="line">public class hook.Test</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line"><span class="meta">   #</span>1 = Methodref          #13.#26        // java/lang/Object."&lt;init&gt;":()V</span><br><span class="line"><span class="meta">   #</span>2 = Class              #27            // hook/Test</span><br><span class="line"><span class="meta">   #</span>3 = Methodref          #2.#26         // hook/Test."&lt;init&gt;":()V</span><br><span class="line"><span class="meta">   #</span>4 = Fieldref           #28.#29        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"><span class="meta">   #</span>5 = String             #30            // java.library.path</span><br><span class="line"><span class="meta">   #</span>6 = Methodref          #28.#31        // java/lang/System.getProperty:(Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line"><span class="meta">   #</span>7 = Methodref          #32.#33        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"><span class="meta">   #</span>8 = Methodref          #2.#34         // hook/Test.add:(II)I</span><br><span class="line"><span class="meta">   #</span>9 = Methodref          #32.#35        // java/io/PrintStream.println:(I)V</span><br><span class="line"><span class="meta">  #</span>10 = Methodref          #2.#36         // hook/Test.nativeAdd:(II)I</span><br><span class="line"><span class="meta">  #</span>11 = String             #37            // test</span><br><span class="line"><span class="meta">  #</span>12 = Methodref          #28.#38        // java/lang/System.loadLibrary:(Ljava/lang/String;)V</span><br><span class="line"><span class="meta">  #</span>13 = Class              #39            // java/lang/Object</span><br><span class="line"><span class="meta">  #</span>14 = Utf8               &lt;init&gt;</span><br><span class="line"><span class="meta">  #</span>15 = Utf8               ()V</span><br><span class="line"><span class="meta">  #</span>16 = Utf8               Code</span><br><span class="line"><span class="meta">  #</span>17 = Utf8               LineNumberTable</span><br><span class="line"><span class="meta">  #</span>18 = Utf8               nativeAdd</span><br><span class="line"><span class="meta">  #</span>19 = Utf8               (II)I</span><br><span class="line"><span class="meta">  #</span>20 = Utf8               add</span><br><span class="line"><span class="meta">  #</span>21 = Utf8               main</span><br><span class="line"><span class="meta">  #</span>22 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line"><span class="meta">  #</span>23 = Utf8               &lt;clinit&gt;</span><br><span class="line"><span class="meta">  #</span>24 = Utf8               SourceFile</span><br><span class="line"><span class="meta">  #</span>25 = Utf8               Test.java</span><br><span class="line"><span class="meta">  #</span>26 = NameAndType        #14:#15        // "&lt;init&gt;":()V</span><br><span class="line"><span class="meta">  #</span>27 = Utf8               hook/Test</span><br><span class="line"><span class="meta">  #</span>28 = Class              #40            // java/lang/System</span><br><span class="line"><span class="meta">  #</span>29 = NameAndType        #41:#42        // out:Ljava/io/PrintStream;</span><br><span class="line"><span class="meta">  #</span>30 = Utf8               java.library.path</span><br><span class="line"><span class="meta">  #</span>31 = NameAndType        #43:#44        // getProperty:(Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line"><span class="meta">  #</span>32 = Class              #45            // java/io/PrintStream</span><br><span class="line"><span class="meta">  #</span>33 = NameAndType        #46:#47        // println:(Ljava/lang/String;)V</span><br><span class="line"><span class="meta">  #</span>34 = NameAndType        #20:#19        // add:(II)I</span><br><span class="line"><span class="meta">  #</span>35 = NameAndType        #46:#48        // println:(I)V</span><br><span class="line"><span class="meta">  #</span>36 = NameAndType        #18:#19        // nativeAdd:(II)I</span><br><span class="line"><span class="meta">  #</span>37 = Utf8               test</span><br><span class="line"><span class="meta">  #</span>38 = NameAndType        #49:#47        // loadLibrary:(Ljava/lang/String;)V</span><br><span class="line"><span class="meta">  #</span>39 = Utf8               java/lang/Object</span><br><span class="line"><span class="meta">  #</span>40 = Utf8               java/lang/System</span><br><span class="line"><span class="meta">  #</span>41 = Utf8               out</span><br><span class="line"><span class="meta">  #</span>42 = Utf8               Ljava/io/PrintStream;</span><br><span class="line"><span class="meta">  #</span>43 = Utf8               getProperty</span><br><span class="line"><span class="meta">  #</span>44 = Utf8               (Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line"><span class="meta">  #</span>45 = Utf8               java/io/PrintStream</span><br><span class="line"><span class="meta">  #</span>46 = Utf8               println</span><br><span class="line"><span class="meta">  #</span>47 = Utf8               (Ljava/lang/String;)V</span><br><span class="line"><span class="meta">  #</span>48 = Utf8               (I)V</span><br><span class="line"><span class="meta">  #</span>49 = Utf8               loadLibrary</span><br><span class="line">&#123;</span><br><span class="line">  public hook.Test();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 2: 0</span><br><span class="line"></span><br><span class="line">  public native int nativeAdd(int, int);</span><br><span class="line">    descriptor: (II)I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_NATIVE</span><br><span class="line"></span><br><span class="line">  public int add(int, int);</span><br><span class="line">    descriptor: (II)I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=3, args_size=3</span><br><span class="line">         0: iload_1</span><br><span class="line">         1: iload_2</span><br><span class="line">         2: iadd</span><br><span class="line">         3: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 10: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=4, locals=2, args_size=1</span><br><span class="line">         0: new           #2                  // class hook/Test</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #3                  // Method "&lt;init&gt;":()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        11: ldc           #5                  // String java.library.path</span><br><span class="line">        13: invokestatic  #6                  // Method java/lang/System.getProperty:(Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line">        16: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        19: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        22: aload_1</span><br><span class="line">        23: iconst_3</span><br><span class="line">        24: iconst_5</span><br><span class="line">        25: invokevirtual #8                  // Method add:(II)I</span><br><span class="line">        28: invokevirtual #9                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">        31: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        34: aload_1</span><br><span class="line">        35: iconst_3</span><br><span class="line">        36: iconst_5</span><br><span class="line">        37: invokevirtual #10                 // Method nativeAdd:(II)I</span><br><span class="line">        40: invokevirtual #9                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">        43: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 14: 0</span><br><span class="line">        line 15: 8</span><br><span class="line">        line 16: 19</span><br><span class="line">        line 17: 31</span><br><span class="line">        line 18: 43</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: ldc           #11                 // String test</span><br><span class="line">         2: invokestatic  #12                 // Method java/lang/System.loadLibrary:(Ljava/lang/String;)V</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 4: 0</span><br><span class="line">        line 5: 5</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: "Test.java"</span><br></pre></td></tr></table></figure>
</li>
<li></li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zubao.github.io/blog/blog/2019/06/28/android设备特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lpl">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="闲敲棋子落灯花">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/06/28/android设备特性/" itemprop="url">获取设备名称</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-28T15:16:27+08:00">
                2019-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>获取设备名称</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BluetoothAdapter.getDefaultAdapter().getName()</span><br><span class="line"></span><br><span class="line">静态权限：</span><br><span class="line">android.permission.BLUETOOTH</span><br></pre></td></tr></table></figure>

<p>PS：小米手机配对后可以获取真实值、努比亚需要开蓝牙才可以获取真实值。Pixel 2XL可以。</p>
</li>
<li><p>android 6.0开始。<code>WifiInfo.getMacAddress()</code> 方法和 <code>BluetoothAdapter.getAddress()</code> 方法现在会返回常量值 <code>02:00:00:00:00:00</code>。</p>
</li>
<li><p>android 6.0 引入运行时权限</p>
</li>
<li><p>6.0 引入低功耗模式：当用户设备未插接电源、处于静止状态且屏幕关闭时，该模式会推迟 CPU 和网络活动，从而延长电池寿命。定时短期恢复正常工作。7.0对低功耗模式进行优化，不处于静止状态也可以进入低功耗模式(例如：放在口袋)。低功耗模式第一步：关闭网络、停止同步、作业；静止一段时间进入第二步：关闭gps、闹钟，wifi扫描等。</p>
</li>
<li><p>6.0引入待机模式：一段时间不触摸手机，进入待机模式。</p>
</li>
<li><p>6.0 移除了 对 apache http支持，请使用HttpUrlConnection</p>
</li>
<li><p>6.0USB传输数据，必须显示启用</p>
</li>
<li><p>7.0 targetSDK为7.0的后台服务器不在收到网络变化的广播。所有7.0系统的手机上后台新建图片和视频的广播</p>
</li>
<li><p>7.0 tragetSDK为7.0+，开发者不能放宽私有文件访问权限，分享私有文件的方法为FileProvider</p>
</li>
<li><p>7.0 设备所有者，可以通过使用DevicePolicyManager.getWifiMacAddress访问mac地址，如果wifi没有启用过返回null</p>
</li>
<li><p>8.0 进一步限制清单注册的隐式广播</p>
</li>
<li><p>8.0 降低后台应用接收位置信息的频率</p>
</li>
<li><p>8.0 以前用户请求一权限组中的某一权限是，系统自动授予了权限组的其他权限。8.0后系统修复了这一bug，改为，请求那一具体权限，授予这一具体权限，但是下次请求这一具体权限所在权限组的其他权限是，系统默认授予，而不是提示用户。</p>
<blockquote>
<p>在 Android 8.0 之前，如果应用在运行时请求权限并且被授予该权限，系统会错误地将属于同一权限组并且在清单中注册的其他权限也一起授予应用。</p>
<p>对于针对 Android 8.0 的应用，此行为已被纠正。系统只会授予应用明确请求的权限。然而，一旦用户为应用授予某个权限，则所有后续对该权限组中权限的请求都将被自动批准。</p>
<p>例如，假设某个应用在其清单中列出 <code>READ_EXTERNAL_STORAGE</code> 和 <code>WRITE_EXTERNAL_STORAGE</code>。应用请求 <code>READ_EXTERNAL_STORAGE</code>，并且用户授予了该权限。如果该应用针对的是 API 级别 24 或更低级别，系统还会同时授予 <code>WRITE_EXTERNAL_STORAGE</code>，因为该权限也属于同一 <code>STORAGE</code> 权限组并且也在清单中注册过。如果该应用针对的是 Android 8.0，则系统此时仅会授予 <code>READ_EXTERNAL_STORAGE</code>；不过，如果该应用后来又请求 <code>WRITE_EXTERNAL_STORAGE</code>，则系统会立即授予该权限，而不会提示用户。</p>
</blockquote>
</li>
<li><p>android 8.0 后 androidID，不同app、相同证书获取的ID相同；不同app、不同证书获取到的ID不同；相同APP，不同证书、卸载重装之后或者重启手机之后获取到的ID不同。</p>
</li>
<li><p>android 8.0 以后获取设备账号接口不可直接使用；需要用户授予权限GET_ACCOUNTS，然后：</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent googlePicker = AccountManager.newChooseAccountIntent(<span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; <span class="string">"com.google"</span>&#125;, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">startActivityForResult(googlePicker, PICK_ACCOUNT_REQUEST);</span><br></pre></td></tr></table></figure>
</li>
<li><p>8.0 Build.SERIAL 已弃用。需要知道硬件序列号的应用应改为使用新的 <code>Build.getSerial()</code> 函数，该函数要求具有 <code>READ_PHONE_STATE</code> 权限。</p>
</li>
<li><p>9.0 电源管理：</p>
<blockquote>
<p>Android 9 引入了一项新的电池管理功能，即应用待机群组。 应用待机群组可以基于应用最近使用时间和使用频率，帮助系统排定应用请求资源的优先级。 根据使用模式，每个应用都会归类到五个优先级群组之一中。 系统将根据应用所属的群组限制每个应用可以访问的设备资源。</p>
<p>五个群组按照以下特性将应用分组：</p>
<ul>
<li><p>活跃</p>
<p>如果用户当前正在使用应用，应用将被归到“活跃”群组中，例如：应用已启动一个 Activity应用正在运行前台服务应用的同步适配器与某个前台应用使用的 content provider 关联用户在应用中点击了某个通知如果应用处于“活跃”群组，系统不会对应用的作业、报警或 FCM 消息施加任何限制。</p>
</li>
<li><p>工作集</p>
<p>如果应用经常运行，但当前未处于活跃状态，它将被归到“工作集”群组中。 例如，用户在大部分时间都启动的某个社交媒体应用可能就属于“工作集”群组。 如果应用被间接使用，它们也会被升级到“工作集”群组中 。如果应用处于“工作集”群组，系统会对它运行作业和触发报警的能力施加轻度限制。 如需了解详细信息，请参阅<a href="https://developer.android.com/topic/performance/power/power-details.html?hl=zh-cn" target="_blank" rel="noopener">电源管理限制</a>。</p>
</li>
<li><p>常用</p>
<p>如果应用会定期使用，但不是每天都必须使用，它将被归到“常用”群组中。 例如，用户在健身房运行的某个锻炼跟踪应用可能就属于“常用”群组。如果应用处于“常用”群组，系统将对它运行作业和触发报警的能力施加较强的限制，也会对高优先级 FCM 消息的数量设定限制。 如需了解详细信息，请参阅<a href="https://developer.android.com/topic/performance/power/power-details.html?hl=zh-cn" target="_blank" rel="noopener">电源管理限制</a>。</p>
</li>
<li><p>极少使用</p>
<p>如果应用不经常使用，那么它属于“极少使用”群组。 例如，用户仅在入住酒店期间运行的酒店应用就可能属于“极少使用”群组。</p>
</li>
</ul>
<p>如果应用处于“极少使用”群组，系统将对它运行作业、触发警报和接收高优先级 FCM 消息的能力施加严格限制。系统还会限制应用连接到网络的能力。 如需了解详细信息，请参阅<a href="https://developer.android.com/topic/performance/power/power-details.html?hl=zh-cn" target="_blank" rel="noopener">电源管理限制</a>。</p>
<ul>
<li><p>从未使用</p>
<p>安装但是从未运行过的应用会被归到“从未使用”群组中。 系统会对这些应用施加极强的限制。</p>
</li>
</ul>
<p>系统会动态地将每个应用归类到某个优先级群组，并根据需要重新归类。 系统可能会依靠某个使用机器学习的预加载应用确定每个应用的使用可能性，并将应用归类到合适的群组。 如果设备上不存在系统应用，系统默认将基于应用的最近使用时间对它们进行排序。 更为活跃的应用将被归类到为应用提供更高优先级的群组，从而让应用可以使用更多系统资源。 具体而言，群组决定应用运行作业的频率，应用可以触发报警的频率，以及应用可以接收高优先级 <a href="https://firebase.google.com/docs/cloud-messaging/?hl=zh-cn" target="_blank" rel="noopener">Firebase 云信息传递 <em>(FCM)</em></a> 消息的频率。 这些限制仅在设备使用电池电量时适用，如果设备正在充电，系统不会对应用施加这些限制。</p>
<p>每个制造商都可以设定自己的标准来归类非活跃应用。 您不应当尝试影响应用所属的群组。 相反，您应当将精力放在确保应用在所属的群组内良好运行上。 您的应用可以通过调用新函数 <a href="https://developer.android.com/reference/android/app/usage/UsageStatsManager.html?hl=zh-cn#getAppStandbyBucket()" target="_blank" rel="noopener"><code>UsageStatsManager.getAppStandbyBucket()</code></a> 查找当前属于哪个群组。</p>
<p>注：位于<a href="https://developer.android.com/training/monitoring-device-state/doze-standby?hl=zh-cn#support_for_other_use_cases" target="_blank" rel="noopener"> 低电耗模式白名单</a>中的应用不适用基于应用待机群组的限制。</p>
</blockquote>
<ul>
<li><p>9.0 省电模式：</p>
<blockquote>
<p>Android 9 对省电模式进行了多处改进。 设备制造商可以决定施加的确切限制。 例如，在 AOSP 构建中，系统会应用以下限制：</p>
<ul>
<li>系统会更积极地将应用置于应用待机模式，而不是等待应用空闲。</li>
<li>后台执行限制适用于所有应用，无论它们的目标 API 级别如何。</li>
<li>当屏幕关闭时，位置服务可能会被停用。</li>
<li>后台应用没有网络访问权限。</li>
</ul>
</blockquote>
</li>
<li><p>9.0 限制后台对传感器的访问</p>
<blockquote>
<p>Android 9 限制后台应用访问用户输入和传感器数据的能力。 如果您的应用在运行 Android 9 设备的后台运行，系统将对您的应用采取以下限制：</p>
<ul>
<li>您的应用不能访问麦克风或摄像头。</li>
<li>使用<a href="https://source.android.com/devices/sensors/report-modes?hl=zh-cn#continuous" target="_blank" rel="noopener">连续</a>报告模式的传感器（例如加速度计和陀螺仪）不会接收事件。</li>
<li>使用<a href="https://source.android.com/devices/sensors/report-modes?hl=zh-cn#on-change" target="_blank" rel="noopener">变化</a>或<a href="https://source.android.com/devices/sensors/report-modes?hl=zh-cn#one-shot" target="_blank" rel="noopener">一次性</a>报告模式的传感器不会接收事件。</li>
</ul>
<p>如果您的应用需要在运行 Android 9 的设备上检测传感器事件，请使用<a href="https://developer.android.com/guide/components/services.html?hl=zh-cn#Foreground" target="_blank" rel="noopener">前台服务</a>。</p>
</blockquote>
</li>
<li><p>9.0 限制 访问通话记录</p>
<blockquote>
<p>Android 9 引入 <a href="https://developer.android.com/reference/android/Manifest.permission_group?hl=zh-cn#CALL_LOG" target="_blank" rel="noopener"><code>CALL_LOG</code></a> <a href="https://developer.android.com/guide/topics/permissions/overview?hl=zh-cn#perm-groups" target="_blank" rel="noopener">权限组</a>并将 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_CALL_LOG" target="_blank" rel="noopener"><code>READ_CALL_LOG</code></a>、<a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#WRITE_CALL_LOG" target="_blank" rel="noopener"><code>WRITE_CALL_LOG</code></a> 和 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#PROCESS_OUTGOING_CALLS" target="_blank" rel="noopener"><code>PROCESS_OUTGOING_CALLS</code></a> 权限移入该组。 在之前的 Android 版本中，这些权限位于 <code>PHONE</code> 权限组。</p>
<p>对于需要访问通话敏感信息（如读取通话记录和识别电话号码）的应用，该 <code>CALL_LOG</code> 权限组为用户提供了更好的控制和可见性。</p>
<p>如果您的应用需要访问通话记录或者需要处理去电，则您必须向 <a href="https://developer.android.com/reference/android/Manifest.permission_group?hl=zh-cn#CALL_LOG" target="_blank" rel="noopener"><code>CALL_LOG</code></a> 权限组明确请求这些权限。 否则会发生 <a href="https://developer.android.com/reference/java/lang/SecurityException?hl=zh-cn" target="_blank" rel="noopener"><code>SecurityException</code></a>。</p>
</blockquote>
</li>
<li><p>9.0 限制访问电话号码</p>
<blockquote>
<p>在未首先获得 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_CALL_LOG" target="_blank" rel="noopener"><code>READ_CALL_LOG</code></a> 权限的情况下，除了应用的用例需要的其他权限之外，运行于 Android 9 上的应用无法读取电话号码或手机状态。</p>
<p>与来电和去电关联的电话号码可在<a href="https://developer.android.com/reference/android/telephony/TelephonyManager?hl=zh-cn#action_phone_state_changed" target="_blank" rel="noopener">手机状态广播</a>（比如来电和去电的手机状态广播）中看到，并可通过 <a href="https://developer.android.com/reference/android/telephony/PhoneStateListener?hl=zh-cn" target="_blank" rel="noopener"><code>PhoneStateListener</code></a> 类访问。 但是，如果没有 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_CALL_LOG" target="_blank" rel="noopener"><code>READ_CALL_LOG</code></a> 权限，则 <code>PHONE_STATE_CHANGED</code> 广播和 <code>PhoneStateListener</code> 提供的电话号码字段为空。</p>
<p>要从手机状态中读取电话号码，请根据您的用例更新应用以请求必要的权限：</p>
<ul>
<li>要通过 <code>PHONE_STATE</code> <a href="https://developer.android.com/guide/topics/manifest/action-element?hl=zh-cn" target="_blank" rel="noopener">Intent 操作</a>读取电话号码，同时需要 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_CALL_LOG" target="_blank" rel="noopener"><code>READ_CALL_LOG</code></a> 权限和 <a href="https://developer.android.com/reference/android/Manifest.permission.html?hl=zh-cn#READ_PHONE_STATE" target="_blank" rel="noopener"><code>READ_PHONE_STATE</code></a> 权限。</li>
<li>要从 <a href="https://developer.android.com/reference/android/telephony/PhoneStateListener?hl=zh-cn#oncallstatechanged" target="_blank" rel="noopener"><code>onCallStateChanged()</code></a> 中读取电话号码，只需要 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_CALL_LOG" target="_blank" rel="noopener"><code>READ_CALL_LOG</code></a> 权限。 不需要 <a href="https://developer.android.com/reference/android/Manifest.permission.html?hl=zh-cn#READ_PHONE_STATE" target="_blank" rel="noopener"><code>READ_PHONE_STATE</code></a> 权限。</li>
</ul>
</blockquote>
</li>
<li><p>9.0 限制访问wifi位置和连接信息。简单说，9.0以前扫描wifi只需要2个权限，并且前台扫描无限制，后台扫描每个APP30分钟可以扫描一次；9.0以后，除了权限还需要开启位置服务，前台2分钟扫描4次，后台所有app30分钟扫描一次。</p>
<blockquote>
<p>在 Android 9 中，应用进行 Wi-Fi 扫描的权限要求比之前的版本更严格。 详情请参阅 <a href="https://developer.android.com/guide/topics/connectivity/wifi-scan?hl=zh-cn#wifi-scan-restrictions" target="_blank" rel="noopener">Wi-Fi 扫描限制</a>。</p>
<p>类似的限制也适用于 <a href="https://developer.android.com/reference/android/net/wifi/WifiManager?hl=zh-cn#getConnectionInfo()" target="_blank" rel="noopener"><code>getConnectionInfo()</code></a> 函数，该函数返回描述当前 Wi-Fi 连接的 <a href="https://developer.android.com/reference/android/net/wifi/WifiInfo?hl=zh-cn" target="_blank" rel="noopener"><code>WifiInfo</code></a> 对象。 如果调用应用具有以下权限，则只能使用该对象的函数来检索 SSID 和 BSSID 值：</p>
<ul>
<li>ACCESS_FINE_LOCATION <strong>或</strong> ACCESS_COARSE_LOCATION</li>
<li>ACCESS_WIFI_STATE</li>
</ul>
<p>检索 SSID 或 BSSID 还需要在设备上启用位置服务（在 <strong>Settings &gt; Location</strong> 下）。</p>
</blockquote>
</li>
<li><p>9.0 wifi服务中移出了部分信息</p>
<blockquote>
<p>在 Android 9 中，下列事件和广播不接收用户位置或个人可识别数据方面的信息：</p>
<ul>
<li><code>WifiManager</code> 中的 <a href="https://developer.android.com/reference/android/net/wifi/WifiManager.html?hl=zh-cn#getScanResults()" target="_blank" rel="noopener"><code>getScanResults()</code></a> 和 <a href="https://developer.android.com/reference/android/net/wifi/WifiManager.html?hl=zh-cn#getConnectionInfo()" target="_blank" rel="noopener"><code>getConnectionInfo()</code></a> 函数。</li>
<li><code>WifiP2pManager</code> 中的 [<code>discoverServices()</code>](<a href="https://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html?hl=zh-cn#discoverServices" target="_blank" rel="noopener">https://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html?hl=zh-cn#discoverServices</a>(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pManager.ActionListener)) 和 [<code>addServiceRequest()</code>](<a href="https://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html?hl=zh-cn#addServiceRequest" target="_blank" rel="noopener">https://developer.android.com/reference/android/net/wifi/p2p/WifiP2pManager.html?hl=zh-cn#addServiceRequest</a>(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.nsd.WifiP2pServiceRequest, android.net.wifi.p2p.WifiP2pManager.ActionListener)) 函数。</li>
<li><a href="https://developer.android.com/reference/android/net/wifi/WifiManager.html?hl=zh-cn#NETWORK_STATE_CHANGED_ACTION" target="_blank" rel="noopener"><code>NETWORK_STATE_CHANGED_ACTION</code></a> 广播。</li>
</ul>
<p>Wi-Fi 的 <a href="https://developer.android.com/reference/android/net/wifi/WifiManager?hl=zh-cn#NETWORK_STATE_CHANGED_ACTION" target="_blank" rel="noopener"><code>NETWORK_STATE_CHANGED_ACTION</code></a>系统广播不再包含 SSID（之前为 EXTRA_SSID）、BSSID（之前为 EXTRA_BSSID）或连接信息（之前为 EXTRA_NETWORK_INFO）。 如果应用需要此信息，请改为调用<a href="https://developer.android.com/reference/android/net/wifi/WifiManager.html?hl=zh-cn#getConnectionInfo()" target="_blank" rel="noopener"><code>getConnectionInfo()</code></a>。</p>
</blockquote>
</li>
<li><p>9.0 电话信息现在依赖设备位置设置</p>
<blockquote>
<ul>
<li><a href="https://developer.android.com/reference/android/telephony/TelephonyManager.html?hl=zh-cn#getAllCellInfo()" target="_blank" rel="noopener"><code>getAllCellInfo()</code></a></li>
<li>[<code>listen()</code>](<a href="https://developer.android.com/reference/android/telephony/TelephonyManager.html?hl=zh-cn#listen" target="_blank" rel="noopener">https://developer.android.com/reference/android/telephony/TelephonyManager.html?hl=zh-cn#listen</a>(android.telephony.PhoneStateListener, int))</li>
<li><a href="https://developer.android.com/reference/android/telephony/TelephonyManager.html?hl=zh-cn#getCellLocation()" target="_blank" rel="noopener"><code>getCellLocation()</code></a></li>
<li><a href="https://developer.android.com/reference/android/telephony/TelephonyManager.html?hl=zh-cn#getNeighboringCellInfo()" target="_blank" rel="noopener"><code>getNeighboringCellInfo()</code></a></li>
</ul>
</blockquote>
</li>
<li><p>9.0 加密程序变更</p>
<blockquote>
<p><a href="https://www.jianshu.com/p/2b22daa8e2f6" target="_blank" rel="noopener">https://www.jianshu.com/p/2b22daa8e2f6</a>  </p>
</blockquote>
</li>
<li><p>Q 目标api 23以下的app会受到警告</p>
<blockquote>
<p>在 Android Q 中，当用户首次运行以 Android 6.0（API 级别 23）以下的版本为目标平台的任何应用时，Android 平台会向用户发出警告。如果此应用要求用户授予权限，则系统会先向用户提供调整应用权限的机会，然后才会允许此应用首次运行。</p>
</blockquote>
</li>
<li><p>Q  撤消了 <code>/proc/net</code> 访问权限</p>
</li>
<li><p>Q 开始，应用必须具有 <code>READ_PRIVILEGED_PHONE_STATE</code> 特许权限才能访问设备的不可重置标识符（包含 IMEI 和序列号）。</p>
<blockquote>
<ul>
<li>如果应用以 Android Q 为目标平台，则会发生 <a href="https://developer.android.com/reference/java/lang/SecurityException?hl=zh-cn" target="_blank" rel="noopener"><code>SecurityException</code></a>。</li>
<li>如果应用以 Android 9（API 级别 28）或更低版本为目标平台，则相应方法会返回 <code>null</code> 或占位符数据（如果应用具有 <a href="https://developer.android.com/reference/android/Manifest.permission.html?hl=zh-cn#READ_PHONE_STATE" target="_blank" rel="noopener"><code>READ_PHONE_STATE</code></a> 权限）。否则，会发生 <code>SecurityException</code>。</li>
</ul>
</blockquote>
</li>
<li><p>Q 后台APP不可访问剪切板</p>
</li>
<li><p>Q 无法启用、停用 WIFI；如果必须，使用设置面板</p>
</li>
<li><p>Q telephony API、WLAN API 和 Bluetooth API 需要精确位置权限 </p>
</li>
<li><p>Q 开始，如果targetSDK 为 29+，不可以读写SDCard，如果targetSDK 为 29以下，可以继续读写。</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/blog/images/head.png" alt="lpl">
            
              <p class="site-author-name" itemprop="name">lpl</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zubao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.cnblogs.com/lipeil" target="_blank" title="博客园">
                      
                        <i class="fa fa-fw fa-博客园"></i>博客园</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lpl</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
